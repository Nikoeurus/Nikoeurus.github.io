<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Python学习笔记"><meta name="keywords" content="Python"><meta name="author" content="Somnus"><meta name="copyright" content="Somnus"><title>Python网络编程(一) | Somnus's blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket库基本用法"><span class="toc-number">1.</span> <span class="toc-text">Socket库基本用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#os库基本用法"><span class="toc-number">2.</span> <span class="toc-text">os库基本用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用threading库实现多线程连接"><span class="toc-number">3.</span> <span class="toc-text">利用threading库实现多线程连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟TCP代理"><span class="toc-number">4.</span> <span class="toc-text">模拟TCP代理</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Somnus</div><div class="author-info__description text-center">与其哀叹，不如埋头苦干</div><div class="follow-button"><a href="https://Nikoeurus.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">79</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">25</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">七月火</a><a class="author-info-links__name text-center" href="https://zhzhdoai.github.io" target="_blank" rel="noopener">osword</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Somnus's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Python网络编程(一)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-07-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Python学习笔记</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>Socket是网络编程的一个非常重要的基础，而Python的Socket标准库也提供了非常完善且易用的语法，这篇文章简单介绍一下Socket库的基本用法，以及结合os标准库，threading多线程库实现远程SSH通信，最后模拟TCP代理交互的过程<a id="more"></a></p>
<h2 id="Socket库基本用法"><a href="#Socket库基本用法" class="headerlink" title="Socket库基本用法"></a>Socket库基本用法</h2><p>Socket是任何一种计算机网络通讯最基础的内容，例如当你在浏览器地址栏中输入一个网址时，你就会打开一个套接字，任何连接到指定的网址并读取响应的页面然后显示出来，在Python中使用Socket库进行通信的对象无非就是两个，一个是服务器端，一个是客户端</p>
<p>服务器端的主要流程：</p>
<p>(1)初始化socket()，创建套接字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket(AF_INET,SOCK_STREAM)</span><br></pre></td></tr></table></figure>

<p>这里socket函数是初始化socket，里面的参数默认是AF_INET和SOCK_STREAM</p>
<p>(2)使用bind()绑定服务器端的ip和端口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.bind((<span class="string">'127.0.0.1'</span>,<span class="number">6666</span>))</span><br></pre></td></tr></table></figure>

<p>这里注意传入的参数是一个元组，包含了ip地址和端口号</p>
<p>(3)使用listen()监听消息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.listen(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>这里的参数最大值为5</p>
<p>(4)使用accept()获取客户端的套接字地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock,addr = s.accept()</span><br></pre></td></tr></table></figure>

<p>这个函数有点类似input函数，input函数是等待用户输入才会执行下一步，而accept函数则等待用户的连接才执行下一步，返回也是一个元组(conn,address)，其中conn是新的套接字对象，可以用来接收和发送数据，address是连接的客户端地址</p>
<p>(5)使用recv()接收数据，send()发送数据与客户端进行交互</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text = sock.recv(<span class="number">1024</span>)</span><br><span class="line">sock.send(data)</span><br></pre></td></tr></table></figure>

<p>这里要注意的是在Python 3中send()中的参数必须是字节类型</p>
<p>客户端的主要流程：</p>
<p>(1)初始化socket()，创建套接字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = socket.socket(AF_INET,SOCK_STREAM)</span><br></pre></td></tr></table></figure>

<p>(2)使用connect()指定连接的ip和端口号连接至指定服务器端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.connect((<span class="string">'127.0.0.1'</span>,<span class="number">6666</span>))</span><br></pre></td></tr></table></figure>

<p>同样的，参数必须是元组，包括要连接的服务器的ip地址和端口号</p>
<p>(3)使用recv()接收数据，send()发送数据与服务器端进行交互</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text = c.recv(<span class="number">1024</span>)</span><br><span class="line">c.send(data)</span><br></pre></td></tr></table></figure>

<p>其实使用socket库其实就只需要注意send()与recv()需要对应起来，不然可能导致客户端或者服务器端处于挂起的状态</p>
<p>下面我们就来看一个简单的服务器端和客户端的一个例子</p>
<p>Server(服务器端)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s=socket(AF_INET,SOCK_STREAM) <span class="comment">#初始化socket，创建套接字</span></span><br><span class="line">s.bind((<span class="string">'localhost'</span>,<span class="number">6666</span>)) <span class="comment">#绑定服务器ip地址和端口</span></span><br><span class="line">s.listen(<span class="number">5</span>) <span class="comment">#开始监听</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock,addr=s.accept() <span class="comment">#等待客户端连接，获取客户端套接字地址</span></span><br><span class="line">    print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">    sock.send(str.encode(<span class="string">'Welcome to Server!'</span>)) <span class="comment">#向客户端发送数据</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data=sock.recv(<span class="number">1024</span>) <span class="comment">#接收客户端发送的数据</span></span><br><span class="line">        print(bytes.decode(data))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            print(<span class="string">'Client has lost'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>Client(客户端)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c=socket(AF_INET,SOCK_STREAM) <span class="comment">#初始化套接字</span></span><br><span class="line">c.connect((<span class="string">'127.0.0.1'</span>,<span class="number">6666</span>)) <span class="comment">#连接服务器</span></span><br><span class="line">text=c.recv(<span class="number">1024</span>)</span><br><span class="line">print(bytes.decode(text))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    data=input()</span><br><span class="line">    c.send(str.encode(data))</span><br><span class="line">c.close()</span><br></pre></td></tr></table></figure>

<p>服务器端使用了死循环以保持一直处于监听状态，客户端发送10次信息与服务器端断开连接，之后服务器继续等待客户端连接，这个程序缺点是服务器端只能支持一个客户端连入，不能支持多个客户端同时连入</p>
<h2 id="os库基本用法"><a href="#os库基本用法" class="headerlink" title="os库基本用法"></a>os库基本用法</h2><p>Python的os库提供了各种操作系统功能的接口，通过例子简单说明一下几种常用的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">cmd = input(<span class="string">'Please input a command: '</span>)</span><br><span class="line">a = os.system(cmd) <span class="comment">#执行shell命令</span></span><br><span class="line">print(a) <span class="comment">#返回值为0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = input(<span class="string">'Please input a command: '</span>)</span><br><span class="line">a = os.popen(cmd) <span class="comment">#返回一个对象</span></span><br><span class="line">print(a.read())</span><br><span class="line"></span><br><span class="line">print(os.getcwd()) <span class="comment">#获取当前目录</span></span><br><span class="line">print(os.listdir(os.getcwd())) <span class="comment">#返回指定文件夹下包含的文件或文件夹的名字的列表</span></span><br><span class="line">os.chdir(os.getcwd()+<span class="string">'/test'</span>) <span class="comment">#到达指定目录下</span></span><br><span class="line">os.system(<span class="string">'test.py'</span>)</span><br></pre></td></tr></table></figure>

<p>下面通过os库与socket库结合模拟SSH通信</p>
<p>服务器端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">s = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'localhost'</span>,<span class="number">6666</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock,addr = s.accept()</span><br><span class="line">    print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">    sock.send(str.encode(<span class="string">'Welcome to the SSHServer!'</span>))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        cmd = bytes.decode(cmd)</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">            print(<span class="string">'Client has lost'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        result = os.popen(cmd).read()</span><br><span class="line">        sock.send(str.encode(result))</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">c = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">c.connect((<span class="string">'127.0.0.1'</span>,<span class="number">6666</span>))</span><br><span class="line">text = c.recv(<span class="number">1024</span>)</span><br><span class="line">print(bytes.decode(text))</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'Please input a command: '</span>)</span><br><span class="line">    c.send(str.encode(cmd))</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        c.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result = c.recv(<span class="number">1024</span>)</span><br><span class="line">    print(bytes.decode(result))</span><br></pre></td></tr></table></figure>

<p>当客户端输入exit时，断开与服务器的连接。同样的，这里的服务器端还是只能与一个客户端连接</p>
<h2 id="利用threading库实现多线程连接"><a href="#利用threading库实现多线程连接" class="headerlink" title="利用threading库实现多线程连接"></a>利用threading库实现多线程连接</h2><p>服务器端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ThreadHandle</span><span class="params">(sock,addr)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        cmd = bytes.decode(cmd)</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">            print(addr,<span class="string">'has lost'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        result = os.popen(cmd).read()</span><br><span class="line">        sock.send(str.encode(result))</span><br><span class="line"></span><br><span class="line">s = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'localhost'</span>,<span class="number">6666</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock,addr = s.accept()</span><br><span class="line">    print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">    sock.send(str.encode(<span class="string">'Welcome to SSHServer!'</span>))</span><br><span class="line">    t = Thread(target=ThreadHandle,args=(sock,addr))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">c = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">c.connect((<span class="string">'127.0.0.1'</span>,<span class="number">6666</span>))</span><br><span class="line">text = c.recv(<span class="number">1024</span>)</span><br><span class="line">print(bytes.decode(text))</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'Please input a command: '</span>)</span><br><span class="line">    c.send(str.encode(cmd))</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        c.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result = c.recv(<span class="number">1024</span>)</span><br><span class="line">    print(bytes.decode(result))</span><br></pre></td></tr></table></figure>

<p>服务器端使用了threading标准库的Thread函数开启了多线程，即每个连接都是一个单独的进程</p>
<h2 id="模拟TCP代理"><a href="#模拟TCP代理" class="headerlink" title="模拟TCP代理"></a>模拟TCP代理</h2><p>我们假设服务器与客户端因为某种原因不能直接通信，这时候就需要一个中间的代理将客户端的信息转发到服务器，再接收服务器返回的数据再转发给客户端，这就是代理的原理</p>
<p>如果我们把Python中一个socket代表一个连接，那么代理既要与客户端连接又要与服务器连接，就需要两个socket</p>
<p>我们先来编写服务器端和客户端，跟前面的例子一样，不说明了</p>
<p>服务器端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">s = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'localhost'</span>,<span class="number">6666</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock,addr = s.accept()</span><br><span class="line">    print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        cmd = bytes.decode(cmd)</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">            print(<span class="string">'TCPClient has lost'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        result = os.popen(cmd).read()</span><br><span class="line">        sock.send(str.encode(result))</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line">PORT = input(<span class="string">'Please input a PORT to connect: '</span>)</span><br><span class="line">PORT = int(PORT)</span><br><span class="line"></span><br><span class="line">c = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">c.connect((HOST,PORT))</span><br><span class="line">text = c.recv(<span class="number">1024</span>)</span><br><span class="line">print(bytes.decode(text))</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">'Please input a command: '</span>)</span><br><span class="line">    c.send(str.encode(cmd))</span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">        c.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    result = c.recv(<span class="number">1024</span>)</span><br><span class="line">    result = bytes.decode(result)</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>

<p>接下来开始编写代理，首先我们先定义建立与客户端连接的socket的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Server</span><span class="params">(LPORT,CHOST,CPORT)</span>:</span></span><br><span class="line">    c = Client(CHOST,CPORT)</span><br><span class="line">    s = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    s.bind((<span class="string">'localhost'</span>,LPORT))</span><br><span class="line">    s.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sock,addr = s.accept()</span><br><span class="line">        print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">        sock.send(str.encode(<span class="string">'Welcome to TCPProxy!'</span>))</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> bytes.decode(cmd) == <span class="string">'exit'</span>:</span><br><span class="line">                print(<span class="string">'TCPClient '</span>+addr+<span class="string">' has lost'</span>)</span><br><span class="line">                Forward(c,cmd)</span><br><span class="line">                c.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(<span class="string">'The command from TCPClient is: '</span>+bytes.decode(cmd))</span><br><span class="line">            result = Forward(c,cmd)</span><br><span class="line">            print(<span class="string">'The result from TCPServer is: '</span>+bytes.decode(result))</span><br><span class="line">            sock.send(result)</span><br></pre></td></tr></table></figure>

<p>因为代理是接收客户端的数据再将数据转发至服务器，再把服务器返回的结果转发到客户端。所以我们不妨把代理看成是客户端的服务器，因此定义函数名为Server，等待客户端的连接，虽然它不然处理客户端发来的数据，但是它可以将数据转发服务器端让服务器端代为处理，这里的参数LPORT是代理绑定的端口号，CHOST和CPORT是传入Client函数的参数，也就是后面讲代理看作是客户端与服务器端连接。</p>
<p>与客户端建立连接后，接收客户端的数据打印出来后，将数据通过Forward函数转发至服务器端，当客户端输入exit命令时，代理将断开与服务器端的连接和客户端的连接并继续等待客户端的接入</p>
<p>接下来编写与服务器端连接的函数Client和转发数据的函数Forward</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Client</span><span class="params">(CHOST,CPORT)</span>:</span></span><br><span class="line">    c = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    c.connect((CHOST,CPORT))</span><br><span class="line">    <span class="keyword">return</span> c</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Forward</span><span class="params">(c,cmd)</span>:</span></span><br><span class="line">    c.send(cmd)</span><br><span class="line">    result = c.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>参数CHOST和CPORT是服务器端的IP和端口</p>
<p>再编写主函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        LPORT = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">        CHOST = sys.argv[<span class="number">2</span>]</span><br><span class="line">        CPORT = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">        Server(LPORT,CHOST,CPORT)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        usage()</span><br></pre></td></tr></table></figure>

<p>这里用到了sys标准库的sys.argv[]，简单地说就是我们在cmd中输入执行python程序时获取的参数，假如我们在cmd命令行中输入test.py aaa bbb，那么sys.argv[0]就代表了字符串’test.py’，sys.argv[1]代表了字符串’aaa’，同理sys.argv[2]代表了字符串’bbb’，所以我们要执行这个代理的程序，不仅要输入python程序的文件名，还要同时输入三个参数，否则就出错而执行usage函数，我们就定义usage函数为这个程序的用法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'TCPProxy.py [ListenedPORT] [ConnectedHOST] [ConnectedPORT]'</span>)</span><br></pre></td></tr></table></figure>

<p>说明了执行这个代理程序应当输入的格式</p>
<p>下面附上代理端完整的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'TCPProxy.py [ListenedPORT] [ConnectedHOST] [ConnectedPORT]'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Server</span><span class="params">(LPORT,CHOST,CPORT)</span>:</span></span><br><span class="line">    c = Client(CHOST,CPORT)</span><br><span class="line">    s = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    s.bind((<span class="string">'localhost'</span>,LPORT))</span><br><span class="line">    s.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sock,addr = s.accept()</span><br><span class="line">        print(<span class="string">'Connected By'</span>,addr)</span><br><span class="line">        sock.send(str.encode(<span class="string">'Welcome to TCPProxy!'</span>))</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> bytes.decode(cmd) == <span class="string">'exit'</span>:</span><br><span class="line">                print(<span class="string">'TCPClient '</span>+addr+<span class="string">' has lost'</span>)</span><br><span class="line">                Forward(c,cmd)</span><br><span class="line">                c.close()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(<span class="string">'The command from TCPClient is: '</span>+bytes.decode(cmd))</span><br><span class="line">            result = Forward(c,cmd)</span><br><span class="line">            print(<span class="string">'The result from TCPServer is: '</span>+bytes.decode(result))</span><br><span class="line">            sock.send(result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Client</span><span class="params">(CHOST,CPORT)</span>:</span></span><br><span class="line">    c = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    c.connect((CHOST,CPORT))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Forward</span><span class="params">(c,cmd)</span>:</span></span><br><span class="line">    c.send(cmd)</span><br><span class="line">    result = c.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        LPORT = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">        CHOST = sys.argv[<span class="number">2</span>]</span><br><span class="line">        CPORT = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">        Server(LPORT,CHOST,CPORT)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        usage()</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Somnus</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nikoeurus.github.io/2018/07/22/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(%E4%B8%80)/">https://nikoeurus.github.io/2018/07/22/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(%E4%B8%80)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Nikoeurus.github.io">Somnus's blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/07/24/Python%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(%E4%BA%8C)/"><i class="fa fa-chevron-left">  </i><span>Python网络编程(二)</span></a></div><div class="next-post pull-right"><a href="/2018/07/21/Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"><span>Python正则表达式</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'piszMlsB7MhecwDRlz0IFCop-gzGzoHsz',
  appKey:'PHmvwpbyTPCcD3D52L1CoTlp',
  placeholder:'Just go go',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Somnus</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>